<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PresuRE v1.3</title>
    <link rel="icon" type="image/png" sizes="32x32" href="favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png">
    <link rel="shortcut icon" href="favicon-32x32.png">
    <meta name="theme-color" content="#1a365d">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="PresuRE">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exceljs/4.3.0/exceljs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary: #274b7d;
            --secondary: #2d3748;
            --accent: #3182ce;
            --light: #f7fafc;
            --danger: #e53e3e;
            --success: #38a169;
            --warning: #d69e2e;
            --purple: #805ad5;
            --border: #cbd5e0;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            margin: 0; 
            background-color: #edf2f7; 
            color: #2d3748; 
            font-size: 13px; 
            -webkit-tap-highlight-color: transparent;
            line-height: 1.4;
        }
        
        /* Layout Mobile-First Friendly */
        header { 
            background: linear-gradient(135deg, var(--primary), #2c5282); 
            color: white; 
            padding: 12px 15px; 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            position: relative; 
            z-index: 100;
        }

        .header-title { 
            font-size: 1.3rem; 
            font-weight: 700; 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            letter-spacing: -0.3px;
        }

        /* Indicador de estado (Punto Verde/Rojo) */
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: var(--success);
            box-shadow: 0 0 8px rgba(56, 161, 105, 0.6);
            margin-left: 10px;
            transition: all 0.3s ease;
            display: inline-block;
        }
        .status-dot.unsaved {
            background-color: var(--danger);
            box-shadow: 0 0 8px rgba(229, 62, 62, 0.8);
            transform: scale(1.2);
        }

        .header-actions { display: flex; gap: 8px; flex-wrap: wrap; }
        
        .container { 
            padding: 5px; 
            max-width: 100vw; 
            margin: 0 auto; 
            box-sizing: border-box; 
            overflow-x: hidden; 
        }
        
        /* Navigation Tabs */
        .tabs { 
            display: flex; 
            overflow-x: auto; 
            white-space: nowrap; 
            gap: 2px; 
            margin-bottom: 0; 
            border-bottom: 2px solid var(--accent); 
            padding-bottom: 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            /* Sticky Logic */
            position: sticky;
            top: 0;
            z-index: 900;
            background-color: #edf2f7;
            padding-top: 5px;
        }
        .tabs::-webkit-scrollbar { display: none; }
        
        .tab { 
            padding: 10px 5px; 
            cursor: pointer; 
            background: #e2e8f0; 
            border-radius: 6px 6px 0 0; 
            font-weight: 600; 
            color: #4a5568; 
            border: 1px solid #cbd5e0; 
            border-bottom: none; 
            flex: 1;
            text-align: center;
            min-width: 70px;
            font-size: 0.9rem;
            transition: all 0.2s ease;
        }
        .tab:hover { background: #cbd5e0; }
        .tab.active { 
            background: var(--accent); 
            color: white; 
            border-color: var(--accent); 
            box-shadow: 0 -2px 5px rgba(49, 130, 206, 0.2);
        }

        /* Reducir ancho específico de la pestaña Calculadora */
        .tabs .tab:nth-child(4) {
            flex: 0 0 50px;    /* No permite que crezca, no permite que se encoja, ancho fijo de 50px */
            min-width: 50px;   /* Asegura que mantenga ese tamaño mínimo */
            padding: 12px 0;   /* Ajusta el padding lateral a 0 para centrar el icono */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* Ajuste opcional: Si en móvil quieres que sea aún más pequeña */
        @media (max-width: 767px) {
            .tabs .tab:nth-child(4) {
                flex: 0 0 45px;
                min-width: 45px;
                font-size: 1.1rem; /* Aumenta un poco el icono para que sea fácil de tocar */
            }
        }
        
        /* Panels */
        .panel { 
            display: none; 
            background: white; 
            padding: 15px; 
            border-radius: 0 0 8px 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.08); 
            min-height: 500px; 
            padding-bottom: 80px; 
            animation: fadeIn 0.25s ease-out;
            margin-top: 0;
        }
        .panel.active { display: block; }
        
        /* Tables General */
        .table-container { 
            min-height: 250px; /* Altura mínima inicial */
            height: auto; /* Se expande con el contenido */
            width: 100%;
            overflow-x: auto;
            margin-bottom: 18px; 
            border: 1px solid #e2e8f0; 
            border-radius: 6px; 
            -webkit-overflow-scrolling: touch;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        table { width: 100%; border-collapse: separate; border-spacing: 0; }
        
        th, td { 
            border: 1px solid #e2e8f0; 
            padding: 8px 6px; 
            text-align: left; 
            vertical-align: middle; 
        }
        th { 
            background-color: var(--primary); 
            color: white; 
            text-align: center; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            white-space: nowrap; 
            cursor: pointer; 
            user-select: none; 
            font-weight: 600;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }
        th:hover { background-color: #2c5282; }
        tr:nth-child(even) { background-color: #f8fafc; }
        tr:hover { background-color: #f1f5f9; }
        
        /* Inputs & Textareas */
        input[type="number"], input[type="text"], select, textarea { 
            width: 100%; 
            padding: 7px 10px; 
            box-sizing: border-box; 
            border: 1px solid #cbd5e0; 
            border-radius: 4px; 
            font-family: inherit; 
            font-size: 13px;
            transition: border 0.2s;
        }
        
        textarea.table-input {
            resize: vertical;
            min-height: 34px;
            height: 34px;
            overflow: hidden;
            line-height: 1.3;
            padding: 6px 8px;
            font-family: inherit;
        }
        textarea.table-input:focus {
            min-height: 70px;
            overflow: auto;
            position: relative;
            z-index: 10;
        }

        textarea.db-desc-input {
            resize: vertical;
            min-height: 34px;
            height: 34px;
            overflow: hidden;
            line-height: 1.3;
            padding: 6px 8px;
            font-family: inherit;
            width: 100%;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            box-sizing: border-box;
        }
        textarea.db-desc-input:focus {
            min-height: 70px;
            overflow: auto;
            position: relative;
            z-index: 10;
        }

        input:focus, textarea:focus, select:focus { 
            border-color: var(--accent); 
            outline: none; 
            background-color: #ebf8ff; 
            box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
        }
        input[readonly] { 
            background-color: #f1f5f9; 
            color: #4a5568; 
            border: 1px solid #cbd5e0; 
            text-align:center; 
            cursor: default; 
        }
        
        /* Buttons */
        .btn { 
            padding: 5px 10px; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 0.85rem; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            gap: 6px; 
            color: white; 
            font-weight: 600; 
            min-height: 38px;
            margin-bottom: 0;
            white-space: nowrap;
            transition: all 0.2s ease;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-1px); box-shadow: 0 3px 6px rgba(0,0,0,0.15); }
        .btn:active { transform: translateY(0); box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .btn-sm { padding: 5px 10px; font-size: 0.75rem; min-height: 30px; }
        .btn-primary { background: var(--accent); }
        .btn-success { background: var(--success); }
        .btn-danger { background: var(--danger); }
        .btn-warning { background: var(--warning); color: #1a202c; }
        .btn-secondary { background: #718096; }
        .btn-purple { background: var(--purple); }
        .btn-info { background: #4299e1; }

        /* Acciones en fila */
        .actions-row {
            display: flex;
            flex-direction: row;
            flex-wrap: nowrap;
            gap: 4px;
            justify-content: center;
        }

        /* Grids & Responsiveness */
        .apu-header-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 10px; 
            background: #f1f5f9; 
            padding: 15px; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            border: 1px solid #e2e8f0;
        }
        
        .apu-body-grid { 
            display: grid; 
            grid-template-columns: 1fr; 
            gap: 20px; 
        }
        
        .resource-group { 
            margin-bottom: 25px; 
            border: 1px solid #e2e8f0; 
            border-radius: 8px; 
            overflow: hidden; 
            max-width: 100%; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .group-header { 
            background: #edf2f7; 
            padding: 12px 16px; 
            font-weight: 700; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            color: var(--primary); 
            font-size: 0.95rem; 
            border-bottom: 1px solid #e2e8f0;
        }
        
        .editor-table-container {
            width: 100%;
            overflow-x: auto;
            margin-bottom: 10px;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Tablas en editor - COMPACTAS para móviles */
        #panel-editor table {
            min-width: 100%;
            table-layout: fixed;
        }
        
        #panel-editor table th:nth-child(1),
        #panel-editor table td:nth-child(1) { width: 40%; min-width: 120px; }
        #panel-editor table th:nth-child(2),
        #panel-editor table td:nth-child(2) { width: 12%; min-width: 45px; }
        #panel-editor table th:nth-child(3),
        #panel-editor table td:nth-child(3) { width: 12%; min-width: 60px; }
        #panel-editor table th:nth-child(4),
        #panel-editor table td:nth-child(4) { width: 15%; min-width: 70px; }
        #panel-editor table th:nth-child(5),
        #panel-editor table td:nth-child(5) { width: 15%; min-width: 70px; }
        #panel-editor table th:nth-child(6),
        #panel-editor table td:nth-child(6) { width: 6%; min-width: 35px; }
        
        .totals-card { 
            background: var(--light); 
            padding: 18px; 
            border-radius: 8px; 
            border: 1px solid #cbd5e0; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .total-row { 
            display: flex; 
            justify-content: space-between; 
            padding: 8px 0; 
            border-bottom: 1px dashed #cbd5e0; 
            font-size: 0.9rem; 
        }
        .total-final { 
            background: linear-gradient(to right, var(--primary), #2c5282); 
            color: white; 
            padding: 15px; 
            font-size: 1.3rem; 
            font-weight: 700; 
            display: flex; 
            justify-content: space-between; 
            margin-top: 15px; 
            border-radius: 6px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        /* Estilos específicos para Tablas de Insumos (DB) */
        .db-table { min-width: 100%; }
        
        .db-table th.col-code, .db-table td.col-code { width: 35px; min-width: 35px; text-align: center; max-width: 35px;} 
        .db-table th.col-desc, .db-table td.col-desc { width: auto; min-width: 100px; max-width: 200px;} 
        .db-table th.col-unit, .db-table td.col-unit { width: 40px; min-width: 40px; text-align: center; max-width: 40px;}
        .db-table th.col-price, .db-table td.col-price { width: 70px; min-width: 70px; text-align: right; max-width: 70px;}
        .db-table th.col-action, .db-table td.col-action { width: 30px; min-width: 30px; text-align: center; max-width: 30px;}
        
        .db-table td input[type="text"],
        .db-table td input[type="number"],
        .db-table td textarea {
            min-width: 0;
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
        }

        .sort-icon { margin-left: 5px; font-size: 0.7em; opacity: 0.7; }

        /* Modal */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(3px); 
            animation: fadeIn 0.2s ease-out;
        }
        .modal-content { 
            background-color: white; 
            margin: 2% auto; 
            padding: 0; 
            border-radius: 10px; 
            width: 96%; 
            max-width: 800px; 
            height: 92vh; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .modal-header { 
            padding: 16px 20px; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .modal-body { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }

        /* Conflict Modal Buttons */
        .conflict-options {
            display: grid;
            gap: 10px;
            margin-top: 15px;
        }
        .conflict-options .btn {
            width: 100%;
            justify-content: center;
        }
        
        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: #f8fafc;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .pagination-info {
            font-size: 0.85rem;
            color: #718096;
        }
        
        /* Media Queries */
        @media (min-width: 768px) {
            header { 
                flex-direction: row; 
                justify-content: space-between; 
                align-items: center; 
                padding: 15px 20px;
            }
            .apu-header-grid { grid-template-columns: 3fr 1fr 1fr; }
            .apu-body-grid { grid-template-columns: 2.5fr 1fr; }
            .modal-content { width: 80%; height: auto; max-height: 90vh; margin: 5% auto; }
            body { font-size: 14px; }
            .container { padding: 15px; }
            
            #panel-editor table { table-layout: auto; }
            #panel-editor table th:nth-child(n), #panel-editor table td:nth-child(n) { width: auto; min-width: 0; }
            
            .db-table { min-width: auto; }
            .db-table th.col-code, .db-table td.col-code { width: 45px; min-width: 45px; max-width: none;} 
            .db-table th.col-desc, .db-table td.col-desc { width: auto; min-width: 150px; max-width: none;} 
            .db-table th.col-unit, .db-table td.col-unit { width: 55px; min-width: 55px; max-width: none;}
            .db-table th.col-price, .db-table td.col-price { width: 90px; min-width: 90px; max-width: none;}
            .db-table th.col-action, .db-table td.col-action { width: 40px; min-width: 40px; max-width: none;}
            
            /* Ajustado a 2 columnas pues quitamos 1 botón */
            .conflict-options { grid-template-columns: 1fr 1fr; }
        }

        /* Mejoras móviles */
        @media (max-width: 767px) {
            #panel-editor .resource-group { margin-bottom: 20px; }
            #panel-editor .editor-table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            #panel-editor .editor-table-container table { min-width: 100%; }
            #panel-editor .apu-body-grid { gap: 15px; }
            
            #panel-editor table th, #panel-editor table td { font-size: 12px; padding: 6px 4px; }
            #panel-editor table input, #panel-editor table textarea { font-size: 12px; padding: 5px 6px; }
            #panel-editor .btn-sm { padding: 3px 6px; min-height: 26px; }
            
            #panel-db .db-table th, #panel-db .db-table td { padding: 5px 3px; font-size: 11px; }
            #panel-db .db-table input, #panel-db .db-table textarea { font-size: 11px; padding: 4px 5px; }
            #panel-db .db-table th.col-code, #panel-db .db-table td.col-code { width: 30px; min-width: 30px; }
            #panel-db .db-table th.col-unit, #panel-db .db-table td.col-unit { width: 35px; min-width: 35px; }
            #panel-db .db-table th.col-price, #panel-db .db-table td.col-price { width: 65px; min-width: 65px; }
            #panel-db .db-table th.col-action, #panel-db .db-table td.col-action { width: 25px; min-width: 25px; }
            #panel-db .btn-sm { padding: 2px 4px; min-height: 24px; }
        }

        /* CORRECCIÓN GRID INSUMOS: Diseño Flexible y Responsivo */
        .db-grid-container { 
            display: flex; 
            flex-direction: column; 
            gap: 20px; 
            width: 100%;
        }

        /* Forzar que las tablas dentro de los contenedores de insumos tengan scroll si son muy anchas */
        .db-grid-container > div {
            width: 100%;
            overflow-x: auto; /* Permite scroll horizontal si la tabla es más ancha que el móvil */
            background: white;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        @media (min-width: 768px) { 
            .db-grid-container { 
                display: grid;
                grid-template-columns: 1fr 1fr; /* Dos columnas en tablets */
            }
            /* Equipos ocupa el ancho completo abajo en tablets */
            .db-grid-container > div:last-child { grid-column: 1 / -1; }
        } 

        @media (min-width: 1200px) { 
            .db-grid-container { 
                grid-template-columns: repeat(3, 1fr); /* Tres columnas en pantallas grandes */
            }
            /* Resetear para que Equipos sea una columna normal */
            .db-grid-container > div:last-child { grid-column: auto; }
        } 

        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .font-bold { font-weight: 700; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* Toast Notification */
        #toast {
            visibility: hidden;
            min-width: 280px;
            max-width: 90%;
            background-color: #2d3748;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 14px 20px;
            position: fixed;
            z-index: 3000;
            left: 50%;
            bottom: 40px;
            transform: translateX(-50%);
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            border-left: 4px solid var(--accent);
        }
        #toast.show { visibility: visible; animation: fadein 0.3s, fadeout 0.3s 2.7s; }
        @keyframes fadein { from {bottom: 20px; opacity: 0;} to {bottom: 40px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 40px; opacity: 1;} to {bottom: 20px; opacity: 0;} }

        @media (max-width: 767px) {
            .btn { padding: 7px 12px; min-height: 36px; }
            .btn-sm { padding: 4px 8px; }
            .header-actions { gap: 6px; }
            .panel { padding: 12px; }
            th, td { padding: 6px 4px; }
            .group-header { padding: 10px 12px; }
        }

        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { opacity: 1; height: 24px; }
        
        ::selection { background-color: rgba(49, 130, 206, 0.2); color: inherit; }
        
        /* Estilos para los nuevos botones de insumos */
        .insumos-buttons {
            display: flex;
            gap: 6px;
            margin-left: 8px;
        }
        
        .insumos-buttons .btn {
            padding: 6px 10px;
            min-height: 32px;
        }
        
        /* Estilos para modal de insumos */
        .insumo-checkbox {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .select-all-row {
            background-color: #edf2f7;
            font-weight: 600;
        }
        
        .insumo-actions {
            display: flex;
            gap: 5px;
            justify-content: flex-end;
        }
        
        /* NUEVO: Estilos para campo de precio editable en modal de insumos */
        .precio-editable {
            width: 100px;
            text-align: right;
            border: 1px solid #cbd5e0;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 13px;
            transition: all 0.2s;
        }
        
        .precio-editable:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px rgba(49, 130, 206, 0.2);
            background-color: #ebf8ff;
        }
        
        /* Modal de Configuración */
        #configModal { 
            display: none; 
            position: fixed; 
            z-index: 2000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background-color: rgba(0,0,0,0.5); 
            backdrop-filter: blur(3px); 
            animation: fadeIn 0.2s ease-out;
        }
        .config-modal-content { 
            background-color: white; 
            margin: 5% auto; 
            padding: 0; 
            border-radius: 10px; 
            width: 90%; 
            max-width: 500px; 
            height: auto; 
            max-height: 85vh;
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .config-modal-header { 
            padding: 16px 20px; 
            background: var(--primary); 
            color: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-shrink: 0; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .config-modal-body { 
            padding: 20px; 
            overflow-y: auto; 
            flex-grow: 1; 
        }
        
        /* Estilos para Drag & Drop - Sortable.js */
        /* Estilo visual mientras se arrastra */
        .sortable-ghost {
            background-color: #ebf8ff !important;
            opacity: 0.8;
        }
        .sortable-drag {
            background-color: #fff;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        /* Cursor para indicar que se puede mover (en zonas vacías) */
        tbody tr {
            cursor: grab;
        }
        tbody tr:active {
            cursor: grabbing;
        }

        /* --- ESTILOS SISTEMA DE MÓDULOS --- */
        .module-bar {
            display: flex;
            align-items: center;
            background: #e2e8f0;
            padding: 0;
            border-top: 1px solid #cbd5e0;
            overflow-x: auto;
            width: 100%;
            scrollbar-width: thin;
        }

        .module-tabs-container {
            display: flex;
            flex-grow: 1;
            overflow-x: auto;
            padding-left: 5px;
        }

        .module-tab {
            padding: 8px 15px;
            margin-right: 2px;
            background: #cbd5e0;
            border-right: 1px solid #a0aec0;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
            white-space: nowrap;
            position: relative;
            transition: background 0.2s;
            user-select: none;
            border-radius: 5px 5px 0 0;
            margin-top: 2px;
        }

        .module-tab:hover {
            background: #edf2f7;
        }

        .module-tab.active {
            background: #fff;
            color: var(--primary);
            border-top: 3px solid var(--primary);
            padding-top: 5px;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.05);
            z-index: 10;
        }

        .module-controls {
            display: flex;
            background: #e2e8f0;
            padding: 5px;
            position: sticky;
            right: 0;
            box-shadow: -5px 0 10px rgba(0,0,0,0.1);
        }

        .module-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: #4a5568;
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }
        .module-btn:hover { background: #cbd5e0; color: #1a202c; }

        .module-total-badge {
            margin-left: 10px;
            font-size: 0.85rem;
            color: var(--primary);
            background: #ebf8ff;
            padding: 4px 8px;
            border-radius: 4px;
            border: 1px solid #bee3f8;
        }

        /* Nuevo Grid para Configuración de Precisión */
        .config-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 columnas */
            gap: 12px;
            margin-bottom: 20px;
        }
        .config-item {
            background: #f7fafc;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
        }
        .config-item label {
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--secondary);
            display: block;
            margin-bottom: 4px;
        }
        .config-item select {
            width: 100%;
            padding: 4px 8px;
            font-size: 0.9rem;
            border-color: #cbd5e0;
        }
        /* Hacer que el item de "Totales" ocupe todo el ancho si se desea, o dejarlo en grid */
        .config-full-width {
            grid-column: 1 / -1;
        }
        
        .precision-quick {
            display: flex;
            gap: 3px;
            margin-left: 8px;
        }
        
        .precision-quick button {
            padding: 3px 8px;
            font-size: 0.7rem;
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-weight: 700;
            transition: all 0.2s;
        }
        
        .precision-quick button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }
        
        .precision-quick button.active {
            background: var(--accent);
            border-color: var(--accent);
        }

        /* Estilos para Modal de Reportes */
        #reportModal .modal-content {
            max-width: 600px;
            /* CAMBIO: Usar altura fija relativa y flex para permitir scroll */
            height: 85vh; 
            margin-top: 5vh;
            display: flex;
            flex-direction: column;
        }

        /* Asegúrate de que el cuerpo tenga scroll */
        #reportModal .modal-body {
            padding: 25px;
            overflow-y: auto; /* Activa el scroll vertical */
            flex-grow: 1;
        }

        .format-selector {
            display: flex;
            justify-content: center;
            gap: 15px;
        }

        .format-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 25px;
            border: 2px solid #cbd5e0;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #718096;
            transition: all 0.2s;
        }

        .format-option:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: #ebf8ff;
        }

        .format-option.active {
            border-color: var(--primary);
            background-color: var(--primary);
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .report-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        @media (min-width: 600px) and (max-width: 1023px) {
            .report-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media (min-width: 1024px) {
            .report-grid {
                grid-template-columns: 1fr 1fr 1fr; /* 3 columnas en pantallas grandes */
            }
        }

        .btn-report {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--secondary);
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .btn-report i {
            font-size: 1.5rem;
            color: var(--accent);
        }

        .btn-report:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--accent);
            background: #f7fafc;
        }

        /* Estilos para el PWA Toast estilo "X" */
        #pwa-toast {
            visibility: hidden;
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1a365d; /* Tu color de tema */
            color: white;
            padding: 16px;
            border-radius: 25px; /* Bordes redondeados estilo app */
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 90%;
            max-width: 400px;
            opacity: 0;
            transition: opacity 0.3s, bottom 0.3s;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        #pwa-toast.show {
            visibility: visible;
            opacity: 1;
            bottom: 30px; /* Efecto de subida */
        }

        .pwa-content {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
        }

        .pwa-btn {
            background-color: white;
            color: #1a365d;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 13px;
            cursor: pointer;
            white-space: nowrap;
        }

        .pwa-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.7);
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
        }

        /* Estilos para el Modal de Unificación */
        .unify-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .unify-option {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .unify-option:hover {
            border-color: var(--accent);
            background-color: #ebf8ff;
            transform: translateX(5px);
        }

        .unify-option.selected {
            border-color: var(--success);
            background-color: #f0fff4;
            box-shadow: 0 0 0 2px rgba(56, 161, 105, 0.2);
        }

        .unify-details {
            display: flex;
            flex-direction: column;
        }

        .unify-name {
            font-weight: 700;
            color: var(--primary);
            font-size: 1rem;
        }

        .unify-meta {
            font-size: 0.85rem;
            color: #718096;
            display: flex;
            gap: 10px;
        }

        /* Estilos para la lista de usos en el modal de fusión */
        .usage-badge {
            font-size: 0.75rem;
            background: #edf2f7;
            padding: 2px 8px;
            border-radius: 12px;
            color: #4a5568;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            margin-top: 4px;
            border: 1px solid #cbd5e0;
        }

        .usage-badge:hover {
            background: #e2e8f0;
            color: var(--primary);
        }

        .apu-usage-list {
            display: none; /* Oculto por defecto */
            margin-top: 8px;
            background: #f7fafc;
            border: 1px solid #edf2f7;
            border-radius: 6px;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
            font-size: 0.8rem;
            list-style: none;
        }

        .apu-usage-list li {
            padding: 3px 0;
            border-bottom: 1px dashed #e2e8f0;
            color: #2d3748;
        }

        .apu-usage-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body>

    <header>
        <div class="header-title">
            <img src="icon-192.png" alt="Logo" style="width: 30px; height: 30px; vertical-align: middle;">
            PresuRE v1.3
            <span id="save-indicator" class="status-dot" title="Estado de guardado"></span>
        </div>
        <div class="header-actions">
            <button class="btn btn-secondary" onclick="openConfigModal()" title="Configuración">
                <i class="fas fa-cog"></i>
            </button>
            <button class="btn btn-secondary" onclick="document.getElementById('fileProject').click()">
                <i class="fas fa-folder-open"></i> Abrir
            </button>
            <button class="btn btn-success" onclick="openSaveOptionsModal()">
                <i class="fas fa-save"></i> Guardar
            </button>
            <button class="btn btn-info" onclick="openReportModal()" title="Generar Reportes">
                <i class="fas fa-print"></i>
            </button>
            <button class="btn btn-danger btn-sm" onclick="openDeleteModal()" title="Opciones de Borrado">
                <i class="fas fa-trash-alt"></i>
            </button>
            <input type="file" id="fileProject" accept=".json,application/json,text/json,text/plain" style="display:none" onchange="loadProjectJSON(this)">
        </div>
    </header>

    <div class="container">
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('b1')" title="Elabore su presupuesto de obra">Presupuesto</div>
            <div class="tab" onclick="switchTab('items')" title="Base de datos de Items">Banco</div>
            <div class="tab" onclick="switchTab('db')" title="Base de datos de Insumos">Insumos</div>
            <div class="tab" onclick="switchTab('calc')" title="Calculadora de Materiales"><i class="fas fa-calculator"></i></div>
        </div>

        <div id="panel-b1" class="panel active">
            <div style="margin-bottom:20px;">
                <h2 style="margin:0 0 12px 0; color:var(--primary); font-size:1.5rem;">Presupuesto de Obra</h2>
                
                <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content: space-between;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-primary" onclick="openItemBankModalForSelect()" title="Agregar item de Base de datos">
                            <i class="fas fa-plus-square"></i> Agregar
                        </button>
                        <button class="btn btn-secondary" onclick="createEmptyItemB1()" title="Crear nuevo item">
                            <i class="fas fa-plus"></i> Nuevo
                        </button>
                    </div>
                    
                    <div style="display:flex; gap:8px;">                    
                        <button class="btn btn-success" onclick="exportB1ToExcel()" title="Exportar presupuesto a Excel">
                            <i class="fas fa-file-excel"></i> Excel
                        </button>
                        <div style="display:inline-block; margin-left:5px;">
                            <input type="file" id="fileImportBudget" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel" style="display:none" onchange="importBudgetFromExcel(this)">
                            <button class="btn btn-warning" onclick="document.getElementById('fileImportBudget').click()" title="Importar Volúmenes de Obra">
                                <i class="fas fa-file-import"></i> Importar
                            </button>
                        </div>

                        <div class="insumos-buttons">
                            <button class="btn btn-purple" onclick="openInsumosModal('materiales')" title="Ver materiales usados"><i class="fas fa-box"></i></button>
                            <button class="btn btn-warning" onclick="openInsumosModal('mano_obra')" title="Ver mano de obra usada"><i class="fas fa-users"></i></button>
                            <button class="btn btn-info" onclick="openInsumosModal('equipos')" title="Ver equipos usados"><i class="fas fa-tools"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="table-container" style="margin-bottom: 0; border-bottom: none; border-radius: 6px 6px 0 0;">
                <table id="table-b1" style="min-width: 950px;">
                    <thead>
                        <tr>
                            <th style="width:50px">Editar</th>
                            <th style="width:35px">Nº</th>
                            <th style="width:70px">Código</th>
                            <th>Descripción del Ítem</th>
                            <th style="width:55px">Und.</th>
                            <th style="width:80px">Cant.</th>
                            <th style="width:80px">P.Unit</th>
                            <th style="width:80px">Total</th>
                            <th style="width:100px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="b1-body"></tbody>
                </table>
            </div>

            <div class="module-bar">
                <div class="module-tabs-container" id="module-tabs">
                    <!-- Las pestañas de módulos se generarán aquí -->
                </div>
                <div class="module-controls">
                    <button class="module-btn" onclick="addModule()" title="Nuevo Módulo">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button class="module-btn" onclick="renameCurrentModule()" title="Renombrar Módulo">
                        <i class="fas fa-pen"></i>
                    </button>
                    <button class="module-btn" onclick="cloneCurrentModule()" title="Clonar Módulo">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="module-btn" onclick="deleteCurrentModule()" title="Eliminar Módulo" style="color:#e53e3e;">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                </div>
            </div>
            
            <div style="margin-top:15px; display:flex; flex-direction:column; gap:5px; align-items:flex-end;">
                <div style="font-size:1rem; color:#4a5568; padding:10px;">
                    Subtotal <span id="current-module-name-display" style="font-weight:600;">Módulo</span>: 
                    <span id="module-total-display" style="font-weight:700;">0.00</span> Bs
                </div>
                <div style="font-size:1.3rem; font-weight:700; color:var(--primary); padding:10px; background:#f1f5f9; box-sizing: border-box; border-radius:8px; width:100%; text-align:right;">
                    Total Presupuesto: <span id="grand-total-display">0.00</span> Bs
                </div>
            </div>

            <div id="b1-pagination" class="pagination" style="display: none;">
                <button class="btn btn-sm btn-secondary" onclick="changePage('b1', -1)"><i class="fas fa-chevron-left"></i> Anterior</button>
                <span class="pagination-info" id="b1-page-info">Página 1 de 1</span>
                <button class="btn btn-sm btn-secondary" onclick="changePage('b1', 1)">Siguiente <i class="fas fa-chevron-right"></i></button>
            </div>
        </div>

        <div id="panel-calc" class="panel">
            <div style="background:#fff; padding:15px; border-radius:8px; border:1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom:15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom:15px; border-bottom:1px solid #edf2f7; padding-bottom:10px;">
                    <h2 style="margin:0; color:var(--primary); font-size:1.3rem;">
                        Calculadora de Materiales
                    </h2>
                    <button onclick="printCalcReport()" class="btn-primary" style="background-color: var(--accent); padding: 8px 16px; font-size: 0.9rem; border: none; transition: opacity 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <i class="fas fa-print"></i> Imprimir Reporte
                    </button>
                </div>
                
                <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:flex-end;">
                    
                    <div style="flex: 2; min-width:250px; position:relative;">
                        <label class="font-bold" style="display:block; margin-bottom:4px; color:#4a5568; font-size:0.85rem;">1. Buscar Ítem (APU):</label>
                        <div style="position:relative;">
                            <i class="fas fa-search" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:#a0aec0;"></i>
                            <input type="text" id="calc-search-input" placeholder="Escribe para buscar..." 
                                onkeyup="searchCalcItem()" 
                                style="padding-left:32px; width:100%; height:38px;">
                        </div>
                        <div id="calc-search-results" style="display:none; position:absolute; top:100%; left:0; width:100%; max-height:200px; overflow-y:auto; background:white; border:1px solid #cbd5e0; border-radius:0 0 6px 6px; z-index:100; box-shadow:0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>

                    <div style="flex: 1.5; min-width:180px; background:#ebf8ff; padding:8px 12px; border-radius:6px; border:1px solid #bee3f8; height:38px; display:flex; flex-direction:column; justify-content:center;">
                        <div id="calc-selected-name" style="font-weight:700; color:var(--primary); font-size:0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">- Seleccione ítem -</div>
                        <div style="font-size:0.75rem;">Unidad: <span id="calc-selected-unit" style="font-weight:600;">-</span></div>
                    </div>

                    <div style="width:120px;">
                        <label class="font-bold" style="display:block; margin-bottom:4px; color:#2f855a; font-size:0.85rem;">2. Cant. Obra:</label>
                        <input type="text" inputmode="decimal" id="calc-quantity" value="1" 
                                onchange="this.value = solveMathExpression(this.value); recalcCalcTable()" 
                                onkeypress="if(event.key === 'Enter') this.blur();"
                                style="height:38px; font-size:1.1rem; font-weight:bold; color:#2f855a; border:2px solid #48bb78; text-align:center; width:100%;">
                    </div>
                </div>
            </div>

            <div class="table-container" style="margin-top:0;">
                <table id="table-calc">
                    <thead>
                        <tr>
                            <th style="width:40%">Descripción insu.</th>
                            <th style="width:10%">Und.</th>
                            <th style="width:15%">Cant-Unit.</th>
                            <th style="width:15%">Fact/Div</th>
                            <th style="width:20%">Requerido</th>
                        </tr>
                    </thead>
                    <tbody id="calc-body">
                        <tr><td colspan="5" class="text-center" style="padding:20px; color:#718096;">Selecciona un ítem para calcular.</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- PANEL BANCO CON BUSCADOR MEJORADO -->
        <div id="panel-items" class="panel">
            <div style="margin-bottom:20px;">
                <h2 style="margin:0 0 12px 0; color:var(--primary); font-size:1.5rem;">Banco de Ítems</h2>
                <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content: space-between; align-items:center;">
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-primary" onclick="createBankItem()">
                            <i class="fas fa-plus"></i> Crear Nuevo
                        </button>
                        <button class="btn btn-success" onclick="exportBankJSON()">
                            <i class="fas fa-file-upload"></i> Exportar
                        </button>
                        <button class="btn btn-warning" onclick="document.getElementById('fileBank').click()">
                            <i class="fas fa-download"></i> Importar
                        </button>
                        <input type="file" id="fileBank" accept=".json,application/json" style="display:none" onchange="importBankJSON(this)">
                    </div>
                    
                    <div style="position:relative; flex-grow:1; max-width:350px;">
                        <i class="fas fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#a0aec0;"></i>
                        <input type="text" id="main-bank-search" placeholder="Buscar en el banco..." 
                            onkeyup="currentPage.bank=1; renderBankList()" 
                            style="width:100%; padding:8px 8px 8px 35px; border-radius:6px; border:1px solid var(--border);">
                    </div>
                </div>
            </div>

            <div style="margin-bottom:20px; padding:15px; background:#f0fff4; border:1px dashed #38a169; border-radius:6px;">
                <strong><i class="fas fa-file-import"></i> Importar Excel (APUs):</strong>
                <div style="margin-top:8px; display:flex; align-items:center; gap:10px; flex-wrap:wrap;">
                    <input type="file" id="fileComplexAPU" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="display:none" onchange="importComplexAPUReport(this)">
                    <button class="btn btn-success btn-sm" onclick="document.getElementById('fileComplexAPU').click()">
                        <i class="fas fa-file-excel"></i> Seleccionar Archivo
                    </button>
                    <span style="font-size:0.8rem; color:#4a5568;">Formato: Excel con columnas claras</span>
                </div>
            </div>
            
            <div class="table-container">
                <table id="table-bank" style="min-width: 650px;">
                    <thead>
                        <tr>
                            <th style="width:35px" title="Agregar al presupuesto">aPresu</th>
                            <th style="width:35px">Cód</th>
                            <th>Descripción</th>
                            <th style="width:35px">Und.</th>
                            <th style="width:80px">Precio Ref.</th>
                            <th style="width:80px">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="bank-body"></tbody>
                </table>
            </div>
            
            <!-- Paginación para Banco -->
            <div id="bank-pagination" class="pagination" style="display: none;">
                <button class="btn btn-sm btn-secondary" onclick="changePage('bank', -1)">
                    <i class="fas fa-chevron-left"></i> Anterior
                </button>
                <span class="pagination-info" id="bank-page-info">Página 1 de 1</span>
                <button class="btn btn-sm btn-secondary" onclick="changePage('bank', 1)">
                    Siguiente <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>

        <div id="panel-editor" class="panel">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; border-bottom:2px solid var(--accent); padding-bottom:12px;">
                <h3 style="margin:0; color:var(--accent); font-size:1.3rem;" id="editor-title">Editar APU</h3>
                <div style="display:flex; gap:8px;">
                    <!-- Botones de navegación movidos aquí, al lado del botón Descartar -->
                    <button class="btn btn-warning btn-sm" onclick="navigateEditor(-1)" title="Anterior (Ctrl+←)" style="width: 30px;">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="navigateEditor(1)" title="Siguiente (Ctrl+→)" style="width: 30px;">
                        <i class="fas fa-chevron-right"></i>
                    </button>

                    <button class="btn btn-secondary" onclick="discardEditor()"> Descartar
                    </button>
                    <button class="btn btn-success" onclick="closeEditor()"> Guardar
                    </button>
                </div>
            </div>

            <div class="apu-header-grid">
                <div>
                    <label class="font-bold">Descripción:</label> 
                    <input type="text" id="apu-desc" onchange="updateEditorMeta()" placeholder="Descripción del ítem">
                </div>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <div>
                        <label class="font-bold">Unidad:</label> 
                        <input type="text" id="apu-unit" onchange="updateEditorMeta()" placeholder="Ej: m3, glb">
                    </div>
                    <div>
                        <label class="font-bold">Cantidad:</label> 
                        <input type="text" inputmode="decimal" id="apu-qty" 
                               onchange="updateEditorMeta()" 
                               onblur="autoformatInput(this, 'qty')" 
                               onfocus="this.select()"
                               step="0.01" min="0">
                    </div>
                </div>
            </div>

            <div class="apu-body-grid">
                <div class="apu-details">
                    <div class="resource-group">
                        <div class="group-header">
                            <span><i class="fas fa-box"></i> Materiales</span>
                            <div style="display:flex; gap:5px;"> <button class="btn btn-success btn-sm" onclick="quickCreateResource('materiales')" title="Crear Nuevo y Añadir">
                                    <i class="fas fa-magic"></i> Crear
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openResourceModal('materiales')">
                                    <i class="fas fa-plus"></i> Añadir
                                </button>
                            </div>
                        </div>
                        <div class="editor-table-container">
                            <table id="table-mat">
                                <thead>
                                    <tr>
                                        <th>Descripción</th>
                                        <th>Und.</th>
                                        <th>Rend.</th>
                                        <th>Precio</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div class="text-right font-bold" style="padding:10px; background:#f8fafc; border-top:1px solid #e2e8f0;">
                            Subtotal: <span id="sub-mat">0.00</span>
                        </div>
                    </div>

                    <div class="resource-group">
                        <div class="group-header">
                            <span><i class="fas fa-users"></i> Mano de Obra</span>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-success btn-sm" onclick="quickCreateResource('mano_obra')" title="Crear Nuevo y Añadir">
                                    <i class="fas fa-magic"></i> Crear
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openResourceModal('mano_obra')">
                                    <i class="fas fa-plus"></i> Añadir
                                </button>
                            </div>
                        </div>
                        <div class="editor-table-container">
                            <table id="table-mo">
                                <thead>
                                    <tr>
                                        <th>Descripción</th>
                                        <th>Und.</th>
                                        <th>Hrs</th>
                                        <th>Jornal</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="padding:12px; background:#fff; font-size:0.85rem;">
                            <div class="total-row"><span>Subtotal MO:</span> <span id="mo-basic">0.00</span></div>
                            <div class="total-row" style="color:var(--accent)">
                                <span>(+) Cargas Soc. (<span id="lbl-soc"></span>%):</span> 
                                <span id="mo-soc">0.00</span>
                            </div>
                            <div class="total-row" style="color:var(--accent)">
                                <span>(+) IVA MO (<span id="lbl-iva"></span>%):</span> 
                                <span id="mo-iva">0.00</span>
                            </div>
                            <div class="text-right font-bold" style="margin-top:8px; padding-top:8px; border-top:2px solid #e2e8f0;">
                                Total Mano de Obra: <span id="sub-mo">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="resource-group">
                        <div class="group-header">
                            <span><i class="fas fa-tools"></i> Equipos</span>
                            <div style="display:flex; gap:5px;">
                                <button class="btn btn-success btn-sm" onclick="quickCreateResource('equipos')" title="Crear Nuevo y Añadir">
                                    <i class="fas fa-magic"></i> Crear
                                </button>
                                <button class="btn btn-primary btn-sm" onclick="openResourceModal('equipos')">
                                    <i class="fas fa-plus"></i> Añadir
                                </button>
                            </div>
                        </div>
                        <div class="editor-table-container">
                            <table id="table-eq">
                                <thead>
                                    <tr>
                                        <th>Descripción</th>
                                        <th>Und.</th>
                                        <th>Rend.</th>
                                        <th>Tarifa</th>
                                        <th>Total</th>
                                        <th></th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                        <div style="padding:12px; background:#fff; font-size:0.85rem;">
                            <div class="total-row">
                                <span>Subtotal Eq:</span> 
                                <span id="eq-basic">0.00</span>
                            </div>
                            <div class="total-row" style="color:var(--accent)">
                                <span>(+) Herramientas (<span id="lbl-tools"></span>% de MO):</span> 
                                <span id="eq-tools">0.00</span>
                            </div>
                            <div class="text-right font-bold" style="margin-top:8px; padding-top:8px; border-top:2px solid #e2e8f0;">
                                Total Equipo: <span id="sub-eq">0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div>
                    <div class="totals-card">
                        <h4 style="margin-top:0; border-bottom:1px solid #cbd5e0; padding-bottom:8px; color:var(--primary);">
                            <i class="fas fa-calculator"></i> Resumen
                        </h4>
                        
                        <div class="total-row"><span>Costo Directo:</span> <strong id="sum-direct">0.00</strong></div>
                        <div class="total-row"><span>Gastos Grales (<span id="lbl-gg"></span>%):</span> <span id="sum-gg">0.00</span></div>
                        <div class="total-row"><span>Utilidad (<span id="lbl-util"></span>%):</span> <span id="sum-util">0.00</span></div>
                        <div class="total-row"><span>Impuesto IT (<span id="lbl-it"></span>%):</span> <span id="sum-it">0.00</span></div>
                        
                        <div class="total-final">
                            <span>P. UNITARIO:</span>
                            <span id="final-price">0.00</span>
                        </div>
                        
                        <div style="margin-top:15px; font-size:0.8rem; color:#718096; text-align:center;">
                            <i class="fas fa-info-circle"></i> Precio calculado automáticamente
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="panel-db" class="panel">
            <div style="margin-bottom:20px;">
                <h2 style="margin:0 0 12px 0; color:var(--primary); font-size:1.5rem;">Gestión de Insumos</h2>
                <div style="background:#fff; padding:15px; border:1px solid #e2e8f0; border-radius:6px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
                    <strong style="color:var(--primary);"><i class="fas fa-file-upload"></i> Carga Masiva:</strong>
                    <input type="file" id="dbFile" accept=".xlsx,.csv,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="flex-grow: 1; max-width: 200px;">
                    <select id="dbImportType" style="padding: 7px 10px; border-radius:4px; border:1px solid #cbd5e0;">
                        <option value="materiales">Materiales</option>
                        <option value="mano_obra">Mano de Obra</option>
                        <option value="equipos">Equipos</option>
                    </select>
                    <button class="btn btn-warning btn-sm" onclick="importDBFromExcel()">
                        <i class="fas fa-upload"></i> Subir
                    </button>
                    <button class="btn btn-purple btn-sm" onclick="cleanAndMergeDuplicates()" title="Fusionar descripciones idénticas">
                        <i class="fas fa-broom"></i> Unificar
                    </button>
                    <button class="btn btn-info btn-sm" onclick="syncDbToBank()" title="Actualizar precios del Banco con los de esta lista">
                        <i class="fas fa-sync"></i> Sincronizar Banco
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: #718096; margin-top: 8px;">
                    <i class="fas fa-sort"></i> Toca los títulos para ordenar. La numeración se auto-ajusta (1, 2, 3...) según el orden.
                </p>
            </div>

            <div class="db-grid-container">
                <div>
                    <div class="group-header" style="background:var(--primary); color:white">
                        <i class="fas fa-box"></i> MATERIALES 
                        <button class="btn btn-success btn-sm" onclick="addDbRow('materiales')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="table-container" style="max-height:450px; overflow-y:auto">
                        <table id="db-table-materiales" class="db-table">
                            <thead>
                                <tr>
                                    <th class="col-code" onclick="toggleDbSort('materiales', 'code')">Nº <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-desc" onclick="toggleDbSort('materiales', 'desc')">Descripción <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-unit">Und.</th>
                                    <th class="col-price">Precio</th>
                                    <th class="col-action"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Paginación para Materiales -->
                    <div id="db-mat-pagination" class="pagination" style="display: none; margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-mat', -1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info" id="db-mat-page-info">Página 1 de 1</span>
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-mat', 1)">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <div class="group-header" style="background:var(--primary); color:white">
                        <i class="fas fa-users"></i> MANO DE OBRA 
                        <button class="btn btn-success btn-sm" onclick="addDbRow('mano_obra')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="table-container" style="max-height:450px; overflow-y:auto">
                        <table id="db-table-mano_obra" class="db-table">
                            <thead>
                                <tr>
                                    <th class="col-code" onclick="toggleDbSort('mano_obra', 'code')">Nº <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-desc" onclick="toggleDbSort('mano_obra', 'desc')">Descripción <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-unit">Und.</th>
                                    <th class="col-price">Jornal</th>
                                    <th class="col-action"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Paginación para Mano de Obra -->
                    <div id="db-mo-pagination" class="pagination" style="display: none; margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-mo', -1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info" id="db-mo-page-info">Página 1 de 1</span>
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-mo', 1)">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div>
                    <div class="group-header" style="background:var(--primary); color:white">
                        <i class="fas fa-tools"></i> EQUIPOS 
                        <button class="btn btn-success btn-sm" onclick="addDbRow('equipos')">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                    <div class="table-container" style="max-height:450px; overflow-y:auto">
                        <table id="db-table-equipos" class="db-table">
                            <thead>
                                <tr>
                                    <th class="col-code" onclick="toggleDbSort('equipos', 'code')">Nº <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-desc" onclick="toggleDbSort('equipos', 'desc')">Descripción <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="col-unit">Und.</th>
                                    <th class="col-price">Tarifa</th>
                                    <th class="col-action"></th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <!-- Paginación para Equipos -->
                    <div id="db-eq-pagination" class="pagination" style="display: none; margin-top: 10px;">
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-eq', -1)">
                            <i class="fas fa-chevron-left"></i> Anterior
                        </button>
                        <span class="pagination-info" id="db-eq-page-info">Página 1 de 1</span>
                        <button class="btn btn-sm btn-secondary" onclick="changePage('db-eq', 1)">
                            Siguiente <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="resourceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0; font-size:1.3rem;">
                    <i class="fas fa-search"></i> Seleccionar Recurso
                </h3>
                <span style="font-size:28px; cursor:pointer; opacity:0.8; transition:opacity 0.2s;" 
                    onclick="closeResourceModal()" 
                    onmouseover="this.style.opacity='1'" 
                    onmouseout="this.style.opacity='0.8'">&times;</span>
            </div>
            <div class="modal-body">
                <div style="position:relative; margin-bottom:15px;">
                    <i class="fas fa-search" style="position:absolute; left:15px; top:50%; transform:translateY(-50%); color:#718096;"></i>
                    <input type="text" id="modal-search" placeholder="Buscar insumo por descripción o código..." 
                        onkeyup="filterModalList()" 
                        style="width:100%; padding:12px 12px 12px 45px; font-size:0.95rem; border:2px solid var(--accent); border-radius:6px;">
                </div>
                <div style="height:calc(100% - 60px); overflow-y:auto; border:1px solid #e2e8f0; border-radius:6px;">
                    <table class="db-select-table" style="width:100%">
                        <thead style="position:sticky; top:0; z-index:1; background:var(--primary);">
                            <tr>
                                <th width="15%">Nº</th>
                                <th>Descripción</th>
                                <th width="15%">Und.</th>
                                <th width="20%">Precio</th>
                                <th width="15%"></th>
                            </tr>
                        </thead>
                        <tbody id="modal-list-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="conflictModal" class="modal" style="z-index: 2500;">
        <div class="modal-content" style="max-width: 400px; height: auto; margin-top: 15vh;">
            <div class="modal-header" style="background-color: var(--warning); color: #1a202c;">
                <h3 style="margin:0; font-size:1.2rem;">
                    <i class="fas fa-exclamation-triangle"></i> Insumo Duplicado
                </h3>
            </div>
            <div class="modal-body" style="text-align: center;">
                <p id="conflict-msg" style="font-size: 1.1rem; margin-bottom: 20px;">
                    Este insumo ya existe en el APU.
                </p>
                <div class="conflict-options">
                    <button class="btn btn-primary" onclick="resolveConflict('replace')">
                        <i class="fas fa-sync-alt"></i> Reemplazar
                    </button>
                    <button class="btn btn-danger" onclick="resolveConflict('discard')">
                        <i class="fas fa-times"></i> Descartar
                    </button>
                </div>
                <p style="font-size: 0.85rem; color: #718096; margin-top: 15px;">
                    <b>Reemplazar:</b> Actualiza los datos (precio/unidad) del insumo existente.
                </p>
            </div>
        </div>
    </div>

    <!-- MODAL BANCO MEJORADO CON MULTI-SELECCIÓN -->
    <div id="bankModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="margin:0;"><i class="fas fa-database"></i> Agregar del Banco</h3>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button id="btn-bulk-add" class="btn btn-success btn-sm" onclick="addSelectedBankItems()" style="display:none;">
                        <i class="fas fa-plus-double"></i> Agregar Seleccionados (<span id="selected-count">0</span>)
                    </button>
                    <span style="font-size:28px; cursor:pointer" onclick="closeBankModal()">&times;</span>
                </div>
            </div>
            <div class="modal-body">
                <div style="position:relative; margin-bottom:12px;">
                    <i class="fas fa-search" style="position:absolute; left:12px; top:50%; transform:translateY(-50%); color:#718096;"></i>
                    <input type="text" id="bank-search" placeholder="Buscar actividad por nombre o código..." onkeyup="filterBankModal()" 
                        style="width:100%; padding:10px 10px 10px 35px; border-radius:6px; border:1px solid var(--border);">
                </div>
                <div style="overflow-y:auto; flex-grow:1; border:1px solid #e2e8f0; border-radius:6px;">
                    <table class="db-select-table">
                        <thead style="position:sticky; top:0; z-index:10; background:var(--primary);">
                            <tr>
                                <th style="width:30px"><input type="checkbox" id="bank-select-all" onclick="toggleSelectAllBank(this)"></th>
                                <th style="width:50px">Cód</th>
                                <th>Descripción del Ítem</th>
                                <th style="width:50px">Und.</th>
                                <th style="width:70px">Acción</th>
                            </tr>
                        </thead>
                        <tbody id="bank-modal-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="insumosModal" class="modal">
        <div class="modal-content" style="max-width: 95%; max-height: 95%; width: 95%; height: 95%;">
            <div class="modal-header">
                <h3 id="insumosModalTitle" style="margin:0; font-size:1.3rem;">
                    <i class="fas fa-list-alt"></i> <span id="modalTipoInsumo">Materiales</span> Usados en Presupuesto
                </h3>
                <span style="font-size:28px; cursor:pointer; opacity:0.8; transition:opacity 0.2s;" 
                    onclick="closeInsumosModal()" 
                    onmouseover="this.style.opacity='1'" 
                    onmouseout="this.style.opacity='0.8'">&times;</span>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; flex-wrap: wrap; gap: 8px; justify-content: space-between; align-items: center;">
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-purple btn-sm" onclick="initiateUnification()">
                            <i class="fas fa-object-group"></i> Fusionar Seleccionados
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="exportInsumosToExcel()">
                            <i class="fas fa-file-excel"></i> Exportar a Excel
                        </button>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-info btn-sm" onclick="aplicarPreciosEditados()">
                            <i class="fas fa-check-double"></i> Aplicar Cambios
                        </button>
                    </div>
                </div>
                
                <div style="overflow: auto; height: calc(100% - 120px); border: 1px solid #e2e8f0; border-radius: 6px;">
                    <table style="width:100%;">
                        <thead style="position:sticky; top:0; z-index:1; background:var(--primary);">
                            <tr>
                                <th width="5%" class="select-all-row">
                                    <input type="checkbox" id="selectAllInsumos" class="insumo-checkbox" onchange="toggleSelectAllInsumos(this)">
                                </th>
                                <th width="45%">Descripción Insumo</th>
                                <th width="8%">Und.</th>
                                <th width="12%">Cant.Total</th>
                                <th width="15%">P. Unitario</th>
                                <th width="15%">Total</th>
                            </tr>
                        </thead>
                        <tbody id="insumosTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Configuración -->
    <div id="configModal" class="modal">
        <div class="config-modal-content">
            <div class="config-modal-header">
                <h3 style="margin:0; font-size:1.3rem;">
                    <i class="fas fa-cog"></i> Configuración Global
                </h3>
                <span style="font-size:28px; cursor:pointer; opacity:0.8; transition:opacity 0.2s;" 
                    onclick="closeConfigModal()" 
                    onmouseover="this.style.opacity='1'" 
                    onmouseout="this.style.opacity='0.8'">&times;</span>
            </div>
            <div class="config-modal-body">

                <label class="font-bold" style="color:var(--purple); display:block; margin-bottom:8px;">
                    <i class="fas fa-list-ol"></i> Formato de Números (Miles y Decimales):
                </label>
                <select id="conf-format" onchange="saveSettings()" style="margin-bottom:20px; padding:8px 12px; width:100%;">
                    <option value="intl">Internacional: 1 234.56 (Espacio / Punto)</option>
                    <option value="latam">LATAM/USA: 1,234.56 (Coma / Punto)</option>
                    <option value="euro">España/Europa: 1.234,56 (Punto / Coma)</option>
                    <option value="raw">Datos Crudos: 1234.56 (Sin separadores)</option>
                </select>

                <div style="margin-bottom:15px; border-bottom:1px solid #e2e8f0; padding-bottom:10px;">
                    <h4 style="margin:0 0 10px 0; color:var(--purple); font-size:1rem;">
                        <i class="fas fa-calculator"></i> Precisión de Decimales
                    </h4>
                    <div class="config-grid">
                        <div class="config-item">
                            <label>Rendimientos (Insumos)</label>
                            <select id="conf-dec-yield" onchange="saveSettings()">
                                <option value="2">2 decimales</option>
                                <option value="3">3 decimales</option>
                                <option value="4">4 decimales</option>
                                <option value="5">5 decimales</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label>Precio Unitario (Insumos)</label>
                            <select id="conf-dec-price" onchange="saveSettings()">
                                <option value="2">2 decimales</option>
                                <option value="3">3 decimales</option>
                                <option value="4">4 decimales</option>
                                <option value="5">5 decimales</option> 
                            </select>
                        </div>
                        <div class="config-item">
                            <label>Parciales (Subtotales)</label>
                            <select id="conf-dec-partial" onchange="saveSettings()">
                                <option value="2">2 decimales</option>
                                <option value="3">3 decimales</option>
                                <option value="4">4 decimales</option>
                                <option value="5">5 decimales</option>
                            </select>
                        </div>
                        <div class="config-item">
                            <label>Cómputos (Cant. Obra)</label>
                            <select id="conf-dec-qty" onchange="saveSettings()">
                                <option value="1">1 decimal</option>
                                <option value="2">2 decimales</option>
                                <option value="3">3 decimales</option>
                                <option value="4">4 decimales</option>
                                <option value="5">5 decimales</option>
                            </select>
                        </div>
                        <div class="config-item config-full-width" style="background:#ebf8ff; border-color:#bee3f8;">
                            <label style="color:var(--primary);">Total Monetario (Precio Final)</label>
                            <select id="conf-dec-total" onchange="saveSettings()">
                                <option value="2">2 decimales (Estándar)</option>
                                <option value="3">3 decimales</option>
                                <option value="4">4 decimales (Precisión Alta)</option>
                                <option value="5">5 decimales (Precisión Muy Alta)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns: 1fr; gap:5px;">
                    <h4 style="margin:0 0 10px 0; color:var(--purple); font-size:1rem;">
                        <i class="fa-solid fa-money-check-dollar"></i> Parámetros de cálculo NB-SABS
                    </h4>
                    <div>
                        <label class="font-bold">Cargas Sociales (% de MO):</label>
                        <input type="number" id="conf-social" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                    
                    <div>
                        <label class="font-bold">IVA Mano de Obra (Factor %):</label>
                        <input type="number" id="conf-iva-mo" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                    
                    <div>
                        <label class="font-bold">Herramientas Menores (% de Total MO):</label>
                        <input type="number" id="conf-tools" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                    <div>
                        <label class="font-bold" style="color:var(--accent)">Gastos Generales (%):</label>
                        <input type="number" id="conf-gg" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                    
                    <div>
                        <label class="font-bold" style="color:var(--accent)">Utilidad (%):</label>
                        <input type="number" id="conf-util" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                    
                    <div>
                        <label class="font-bold">Impuesto a las Transacciones - IT (%):</label>
                        <input type="number" id="conf-it" onchange="saveSettings()" step="0.01" min="0" style="width:100%;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #2b6cb0, #2c5282);">
                <h3 style="margin:0;"><i class="fas fa-file-invoice"></i> Centro de Reportes</h3>
                <span style="font-size:28px; cursor:pointer;" onclick="closeReportModal()">&times;</span>
            </div>
            <div class="modal-body">
                
                <div style="margin-bottom: 20px;">
                    <label style="font-weight: bold; display: block; margin-bottom: 6px; color: var(--secondary);">
                        <i class="fas fa-pen"></i> Nombre del Proyecto:
                    </label>
                    <input type="text" id="reportProjectName" placeholder="Escribe el nombre del proyecto..." 
                        style="width: 100%; padding: 10px; border: 2px solid #cbd5e0; border-radius: 6px; font-size: 1rem; transition: border 0.3s;">
                </div>

                <div style="margin-bottom: 25px; text-align: center;">
                    <label style="font-weight: bold; display: block; margin-bottom: 10px; color: var(--secondary);">Formato de Salida:</label>
                    <div class="format-selector">
                        <label class="format-option active" onclick="setReportFormat('pdf')">
                            <input type="radio" name="repFormat" value="pdf" checked hidden>
                            <i class="fas fa-file-pdf"></i> PDF
                        </label>
                        <label class="format-option" onclick="setReportFormat('excel')">
                            <input type="radio" name="repFormat" value="excel" hidden>
                            <i class="fas fa-file-excel"></i> Excel
                        </label>
                    </div>
                </div>

                <label style="font-weight: bold; display: block; margin-bottom: 15px; color: var(--secondary); text-align: center;">Reportes Disponibles:</label>

                <div class="report-grid">
                    <button class="btn-report" onclick="generateSelectedReport('pg')">
                        <i class="fas fa-list-alt"></i>
                        <span>Formulario B-1 (PG)</span>
                    </button>
                    
                    <button class="btn-report" onclick="generateSelectedReport('apu')">
                        <i class="fas fa-calculator"></i>
                        <span>Formulario B-2 (APUs)</span>
                    </button>

                    <button class="btn-report" onclick="generateSelectedReport('materiales')">
                        <i class="fas fa-box"></i>
                        <span>Insumos: Materiales</span>
                    </button>

                    <button class="btn-report" onclick="generateSelectedReport('mano_obra')">
                        <i class="fas fa-users"></i>
                        <span>Insumos: Mano de Obra</span>
                    </button>

                    <button class="btn-report" onclick="generateSelectedReport('equipos')">
                        <i class="fas fa-truck-monster"></i>
                        <span>Insumos: Maquinaria</span>
                    </button>

                    <button class="btn-report" style="font-weight: bold; font-size: 1.1em;" onclick="generateSelectedReport('masivo')">
                        <i class="fas fa-folder-open"></i>
                        <span>EXPORTACIÓN MASIVA COMPLETA</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="saveOptionsModal" class="modal" style="z-index: 3100;">
        <div class="modal-content" style="max-width: 350px; height: auto; margin-top: 20vh;">
            <div class="modal-header" style="background: var(--success); color: white;">
                <h3 style="margin:0; font-size:1.1rem;"><i class="fas fa-save"></i> Opciones de Guardado</h3>
                <span style="font-size:24px; cursor:pointer;" onclick="document.getElementById('saveOptionsModal').style.display='none'">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px; text-align: center;">
                <p style="color: #4a5568; margin-bottom: 20px;">¿Qué deseas exportar a archivo?</p>
                
                <button class="btn btn-success" style="width: 100%; margin-bottom: 10px; justify-content: flex-start;" onclick="exportProjectJSON(); document.getElementById('saveOptionsModal').style.display='none'">
                    <i class="fas fa-archive"></i> <strong>Proyecto Completo</strong>
                    <span style="font-size: 0.8em; margin-left: auto; opacity: 0.8;">(Todo)</span>
                </button>
                
                <button class="btn btn-info" style="width: 100%; justify-content: flex-start;" onclick="exportBudgetOnlyJSON(); document.getElementById('saveOptionsModal').style.display='none'">
                    <i class="fas fa-file-contract"></i> <strong>Solo Presupuesto</strong>
                    <span style="font-size: 0.8em; margin-left: auto; opacity: 0.8;">(Items B1)</span>
                </button>
                
                <p style="font-size: 0.75rem; color: #a0aec0; margin-top: 15px;">
                    "Solo Presupuesto" exporta los ítems y configuración, excluyendo el Banco y la Base de Insumos global.
                </p>
            </div>
        </div>
    </div>

    <div id="deleteOptionsModal" class="modal" style="z-index: 3200;">
        <div class="modal-content" style="max-width: 350px; height: auto; margin-top: 20vh;">
            <div class="modal-header" style="background: var(--danger); color: white;">
                <h3 style="margin:0; font-size:1.1rem;"><i class="fas fa-trash-alt"></i> Opciones de Borrado</h3>
                <span style="font-size:24px; cursor:pointer;" onclick="closeDeleteModal()">&times;</span>
            </div>
            <div class="modal-body" style="padding: 20px; text-align: center;">
                <p style="color: #4a5568; margin-bottom: 20px;">¿Qué deseas eliminar?</p>
                
                <button class="btn btn-warning" style="width: 100%; margin-bottom: 10px; justify-content: flex-start;" onclick="clearBudgetOnly()">
                    <i class="fas fa-file-contract"></i> <strong>Solo Presupuesto</strong>
                    <span style="font-size: 0.8em; margin-left: auto; opacity: 0.8;">(Items B1)</span>
                </button>
                
                <button class="btn btn-danger" style="width: 100%; justify-content: flex-start;" onclick="confirmFullReset()">
                    <i class="fas fa-bomb"></i> <strong>Borrar Todo</strong>
                    <span style="font-size: 0.8em; margin-left: auto; opacity: 0.8;">(Fábrica)</span>
                </button>
                
                <p style="font-size: 0.75rem; color: #a0aec0; margin-top: 15px;">
                    "Solo Presupuesto" vacía la lista actual pero MANTIENE tu Banco de Ítems y Base de Insumos.
                </p>
            </div>
        </div>
    </div>

    <div id="unifyModal" class="modal" style="z-index: 3500;">
        <div class="modal-content" style="max-width: 500px; height: auto; max-height: 80vh;">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                <h3 style="margin:0;"><i class="fas fa-random"></i> Elegir Insumo Correcto</h3>
                <span style="font-size:24px; cursor:pointer;" onclick="closeUnifyModal()">&times;</span>
            </div>
            <div class="modal-body">
                <p style="color: #4a5568; margin-bottom: 15px; text-align: center;">
                    Has seleccionado <strong id="unify-count">0</strong> insumos similares.<br>
                    Selecciona cuál es el <b>CORRECTO</b>. Los demás serán reemplazados por este en todo el presupuesto.
                </p>
                
                <div id="unify-list-container" class="unify-list">
                    </div>
                
                <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid #e2e8f0; text-align: right;">
                    <button class="btn btn-secondary" onclick="closeUnifyModal()">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

<div id="toast">Guardado automáticamente</div>

<script>
    // --- CONSTANTES ---
    const STORAGE_KEY = 'costos_bolivia_data';
    const initialDB = {
        materiales: [
            {code:"1", desc:"Cemento portland", unit:"kg", price:1.26},
            {code:"2", desc:"Arena fina", unit:"m3", price:150},
            {code:"3", desc:"Grava", unit:"m3", price:160}
        ],
        mano_obra: [
            {code:"1", desc:"Albañil", unit:"hr", price:20},
            {code:"2", desc:"Ayudante", unit:"hr", price:15}
        ],
        equipos: [
            {code:"1", desc:"Mezcladora", unit:"hr", price:28.67},
            {code:"2", desc:"Vibradora", unit:"hr", price:21}
        ]
    };

    // --- ESTADO GLOBAL ---
    let appData = {
        settings: { 
            social: 55.00, iva_mo: 14.94, tools: 5.00, gg: 10.00, util: 10.00, it: 3.09,
            // Nuevas configuraciones de precisión
            decimals_yield: 5,   // Rendimientos (cómputos)
            decimals_price: 3,   // Unitarios Insumos
            decimals_partial: 4, // Parciales
            decimals_total: 2,   // Totales Monetarios
            decimals_qty: 2,     // Cómputos Métricos
            numberFormat: 'intl' // Formato de números
        },
        database: JSON.parse(JSON.stringify(initialDB)),
        itemBank: [],
        projectItems: [],
        modules: [],          // Nuevo: lista de módulos
        activeModuleId: null  // Nuevo: módulo activo
    };

    let editorContext = null;
    let currentEditId = null;
    let editorBackup = null; 
    let isCreatingNew = false; 
    let lastToastTime = 0;

    // --- HELPERS PARA EXCELJS ---
    // 1. Guardar Buffer como archivo (Reemplaza XLSX.writeFile)
    function saveExcelBuffer(buffer, filename) {
        const blob = new Blob([buffer], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
        saveAs(blob, filename); // Usa FileSaver.js
    }

    // 2. Convertir Hoja de ExcelJS a Matriz de Datos (Simula XLSX.utils.sheet_to_json con header:1)
    function sheetToDataArray(worksheet) {
        const data = [];
        worksheet.eachRow({ includeEmpty: true }, (row, rowNumber) => {
            // ExcelJS usa índices base-1 y row.values[0] suele ser null/undefined
            // Cortamos el primer elemento para obtener un array base-0 limpio
            const rowValues = Array.isArray(row.values) ? row.values.slice(1) : [];
            data.push(rowValues);
        });
        return data;
    }
    
    // Estado de ordenamiento para DB
    let dbSortState = {
        materiales: { field: 'desc', dir: 1 }, // 1: asc, -1: desc
        mano_obra: { field: 'desc', dir: 1 },
        equipos: { field: 'desc', dir: 1 }
    };

    // Variables para gestión de insumos del presupuesto
    let currentInsumosType = '';
    let insumosList = [];

    // Variables para manejo de conflictos
    let conflictData = null;

    // Variables para paginación
    let currentPage = {
        'b1': 1,
        'bank': 1,
        'db-mat': 1,
        'db-mo': 1,
        'db-eq': 1
    };
    const itemsPerPage = 50;
    let saveTimeout; // Variable para debounce de guardado

    // Variables para navegación en editor
    let editorNavigationIndex = -1;
    let editorSourceArray = [];

    // Variables para atajos de teclado
    let currentEditField = null;
    let currentEditRow = null;
    let currentEditType = null;

    // Variable para mantener la selección del banco (PERSISTENCIA)
    let selectedBankIds = new Set(); 

    // --- MEJORA 1: SISTEMA CENTRALIZADO DE FORMATEO ---
    
    // --- NUEVA FUNCIÓN AUXILIAR ---
    // Redondea un valor numérico basándose en la configuración actual
    // Retorna un NÚMERO (no string) listo para cálculos matemáticos
    function roundToConfig(value, type = 'total') {
        if (value === null || value === undefined || isNaN(value)) return 0;
        
        let decimals;
        const settings = appData.settings;
        
        switch(type) {
            case 'yield': decimals = settings.decimals_yield; break;
            case 'price': decimals = settings.decimals_price; break;
            case 'partial': decimals = settings.decimals_partial; break;
            case 'total': decimals = settings.decimals_total; break; // Usado para P. Unitario Final
            case 'qty': decimals = settings.decimals_qty; break;
            default: decimals = 2;
        }

        // Truco para redondear correctamente evitando errores de punto flotante
        // Ejemplo: 1.005.toFixed(2) a veces da 1.00, esto lo corrige
        return Number(Math.round(value + 'e' + decimals) + 'e-' + decimals);
    }

    // Reemplazar la función fmt() actual por un sistema más robusto
    function formatNumber(value, type = 'total') {
        if (value === null || value === undefined || isNaN(value)) return '0';
        
        const settings = appData.settings;
        let decimals;
        
        switch(type) {
            case 'yield': decimals = settings.decimals_yield; break;
            case 'price': decimals = settings.decimals_price; break;
            case 'partial': decimals = settings.decimals_partial; break;
            case 'total': decimals = settings.decimals_total; break;
            case 'qty': decimals = settings.decimals_qty; break;
            case 'code': return Math.round(value).toString();
            default: decimals = settings.decimals_total;
        }
        
        // Redondear a los decimales especificados
        let numStr = parseFloat(value).toFixed(decimals);
        
        // Separar parte entera y decimal
        let parts = numStr.split('.');
        let integerPart = parts[0];
        let decimalPart = parts[1] || '';
        
        // Aplicar separadores de miles según el formato
        const format = settings.numberFormat || 'intl';
        
        switch(format) {
            case 'intl':
                // Miles con espacio, decimal con punto
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, " ");
                return decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
            case 'latam':
                // Miles con coma, decimal con punto
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                return decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
            case 'euro':
                // Miles con punto, decimal con coma
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                return decimalPart ? `${integerPart},${decimalPart}` : integerPart;
            case 'raw':
                // Datos crudos: sin separadores de miles
                return decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
            default:
                // Por defecto, sin separadores de miles
                return decimalPart ? `${integerPart}.${decimalPart}` : integerPart;
        }
    }
    
    // Mantener compatibilidad con código existente
    function fmt(number, type = 'total') {
        return formatNumber(number, type);
    }
    
    // Función para obtener el paso (step) según precisión
    function getStep(type) {
        let decimals = 2;
        switch(type) {
            case 'yield': decimals = settings.decimals_yield || 5; break;
            case 'price': decimals = appData.settings.decimals_price || 3; break;
            case 'partial': decimals = appData.settings.decimals_partial || 4; break;
            case 'total': decimals = appData.settings.decimals_total || 2; break;
            case 'qty': decimals = appData.settings.decimals_qty || 2; break;
        }
        // Retorna "0.0001" para 4 decimales, etc.
        return (1 / Math.pow(10, decimals)).toFixed(decimals);
    }

    // --- MEJORA 2: INDICADOR VISUAL DE PRECISIÓN ---
    
    function updatePrecisionIndicator() {
        const indicator = document.getElementById('precision-indicator');
        if (indicator) {
            const s = appData.settings;
            indicator.innerHTML = `<i class="fas fa-sliders-h"></i>
                Rend:${s.decimals_yield} | 
                Prec:${s.decimals_price} | 
                Total:${s.decimals_total}`;
            indicator.title = `Configuración de decimales:
Rendimientos: ${s.decimals_yield} decimales
Precios: ${s.decimals_price} decimales
Parciales: ${s.decimals_partial} decimales
Totales: ${s.decimals_total} decimales
Cantidades: ${s.decimals_qty} decimales`;
        }
    }
    
    // --- MEJORA 3: SELECTOR RÁPIDO DE PRECISIÓN ---
    
    function setPrecision(preset) {
        const presets = {
            low: { 
                decimals_yield: 2, 
                decimals_price: 2, 
                decimals_total: 0, 
                decimals_partial: 2, 
                decimals_qty: 1 
            },
            medium: { 
                decimals_yield: 5, 
                decimals_price: 3, 
                decimals_total: 2, 
                decimals_partial: 4, 
                decimals_qty: 2 
            },
            high: { 
                decimals_yield: 6, 
                decimals_price: 4, 
                decimals_total: 4, 
                decimals_partial: 6, 
                decimals_qty: 3 
            }
        };
        
        if (presets[preset]) {
            Object.assign(appData.settings, presets[preset]);
            saveSettings();
            showToast(`Precisión ${preset} aplicada`);
            
            // Actualizar botones activos
            document.querySelectorAll('.precision-quick button').forEach(btn => {
                btn.classList.remove('active');
            });
            // No hay manera fácil de saber qué botón se presionó, pero podemos
            // marcarlos por texto
            const buttons = document.querySelectorAll('.precision-quick button');
            buttons.forEach(btn => {
                if (btn.textContent === preset.charAt(0).toUpperCase()) {
                    btn.classList.add('active');
                }
            });
        }
    }
    
    function updateCurrentConfigDisplay() {
        const s = appData.settings;
        document.getElementById('current-yield-dec').textContent = s.decimals_yield;
        document.getElementById('current-price-dec').textContent = s.decimals_price;
        document.getElementById('current-total-dec').textContent = s.decimals_total;
        document.getElementById('current-partial-dec').textContent = s.decimals_partial;
        document.getElementById('current-qty-dec').textContent = s.decimals_qty;
        
        const formatNames = {
            'intl': 'Internacional (1 234.56)',
            'latam': 'LATAM/USA (1,234.56)',
            'euro': 'España/Europa (1.234,56)'
        };
        document.getElementById('current-format').textContent = formatNames[s.numberFormat] || s.numberFormat;
    }
    
    function updateDecimalComparison() {
        const input = document.getElementById('comparisonInput');
        const value = parseFloat(input.value);
        const grid = document.getElementById('comparison-grid');
        
        if (isNaN(value)) {
            grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: #718096;">Ingresa un número válido</div>';
            return;
        }
        
        const s = appData.settings;
        const types = [
            {label: 'Rendimiento (yield)', key: 'decimals_yield', value: s.decimals_yield},
            {label: 'Precio Unitario (price)', key: 'decimals_price', value: s.decimals_price},
            {label: 'Parcial (partial)', key: 'decimals_partial', value: s.decimals_partial},
            {label: 'Total Monetario (total)', key: 'decimals_total', value: s.decimals_total},
            {label: 'Cantidad (qty)', key: 'decimals_qty', value: s.decimals_qty}
        ];
        
        let html = '';
        types.forEach(t => {
            const formatted = formatNumber(value, t.key.replace('decimals_', ''));
            html += `
                <div class="comparison-item">
                    <div class="comparison-label">${t.label}</div>
                    <div class="comparison-value">${formatted}</div>
                    <div class="comparison-decimal">${t.value} decimal${t.value !== 1 ? 'es' : ''}</div>
                </div>
            `;
        });
        
        // Agregar ejemplo con diferentes números
        const examples = [0.123456, 1.5, 1000.99, 1234567.891];
        examples.forEach(ex => {
            html += `
                <div class="comparison-item" style="background: #ebf8ff;">
                    <div class="comparison-label">Ejemplo: ${ex}</div>
                    <div class="comparison-value">${formatNumber(ex, 'total')}</div>
                    <div class="comparison-decimal">Formato: ${s.numberFormat}</div>
                </div>
            `;
        });
        
        grid.innerHTML = html;
    }

    // --- SEGURIDAD: Prevenir XSS ---
    function escapeHtml(text) {
        if (text == null) return "";
        return text.toString()
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // --- PROCESADOR MATEMÁTICO INTELIGENTE (SOPORTA FORMATOS REGIONALES) ---
    function solveMathExpression(value) {
        if (!value) return 0;
        let clean = value.toString().trim();

        // 1. Si empieza con '=', lo quitamos
        if (clean.startsWith('=')) clean = clean.substring(1);

        // 2. LIMPIEZA SEGÚN FORMATO REGIONAL (CRÍTICO)
        const format = appData.settings.numberFormat || 'intl';

        if (format === 'euro') {
            // Formato EURO (1.234,56) -> JS necesita (1234.56)
            // Eliminamos puntos de miles y cambiamos la coma decimal por punto
            clean = clean.replace(/\./g, ''); // Quitar miles (.)
            clean = clean.replace(/,/g, '.'); // Cambiar decimal (,) a (.)
        } else if (format === 'latam') {
            // Formato LATAM/USA (1,234.56) -> JS necesita (1234.56)
            // Eliminamos las comas de miles. El punto se mantiene.
            clean = clean.replace(/,/g, ''); 
        } else {
            // Formato INTL (1 234.56)
            // Eliminamos espacios
            clean = clean.replace(/\s/g, '');
            // Por si acaso el usuario usó coma como decimal aunque esté en Intl
            clean = clean.replace(/,/g, '.'); 
        }

        // 3. Verificar seguridad (solo permitir números y operadores matemáticos)
        if (/^[\d\.\+\-\*\/\(\)\s]+$/.test(clean)) {
            try {
                const result = new Function('return ' + clean)();
                if (!isFinite(result) || isNaN(result)) return 0;
                return result;
            } catch (e) {
                return parseFloat(clean) || 0;
            }
        }

        return parseFloat(clean) || 0;
    }

    // ============================================================================
    // FUNCIÓN UNIFICADA PARA PARSEO DE NÚMEROS (SOLUCIÓN MULTI-REGIONAL)
    // ============================================================================
    
    /**
     * Función unificada para parsear números respetando la configuración regional
     * Esta función debe ser el ÚNICO punto de entrada para convertir strings a números
     * 
     * @param {string|number} value - Valor a parsear
     * @param {boolean} allowExpressions - Si permite expresiones matemáticas (ej: 10+5*2)
     * @returns {number} Número parseado o 0 si es inválido
     * 
     * @example
     * // Formato EURO (España, Alemania, Francia)
     * appData.settings.numberFormat = 'euro';
     * parseNumber('1.234,56')    // → 1234.56 ✅
     * parseNumber('1234,56')     // → 1234.56 ✅
     * parseNumber('1,56')        // → 1.56 ✅
     * 
     * // Formato LATAM (México, USA, Argentina)
     * appData.settings.numberFormat = 'latam';
     * parseNumber('1,234.56')    // → 1234.56 ✅
     * parseNumber('1234.56')     // → 1234.56 ✅
     * parseNumber('1.56')        // → 1.56 ✅
     * 
     * // Formato INTL (Internacional)
     * appData.settings.numberFormat = 'intl';
     * parseNumber('1 234.56')    // → 1234.56 ✅
     * parseNumber('1234.56')     // → 1234.56 ✅
     */
    function parseNumber(value, allowExpressions = false) {
        // 1. Si ya es un número, retornarlo directamente
        if (typeof value === 'number') {
            return isNaN(value) ? 0 : value;
        }
        
        // 2. Validar que existe algún valor
        if (value === null || value === undefined) return 0;
        
        // 3. Convertir a string y limpiar espacios externos
        let clean = value.toString().trim();
        if (clean === '' || clean === '-') return 0;
        
        // 4. Si permite expresiones matemáticas, usar la función existente
        if (allowExpressions) {
            return solveMathExpression(value);
        }
        
        // 5. Obtener formato regional configurado
        const format = appData.settings.numberFormat || 'intl';
        
        // 6. Aplicar limpieza específica según el formato
        switch(format) {
            case 'euro':
                // Formato Europeo: 1.234.567,89
                // - Punto (.) = separador de miles
                // - Coma (,) = separador decimal
                clean = clean.replace(/\./g, '');     // Eliminar miles
                clean = clean.replace(/,/g, '.');     // Convertir decimal a punto JS
                break;
                
            case 'latam':
                // Formato Latinoamericano/USA: 1,234,567.89
                // - Coma (,) = separador de miles
                // - Punto (.) = separador decimal
                clean = clean.replace(/,/g, '');      // Eliminar miles
                break;
                
            case 'intl':
            default:
                // Formato Internacional: 1 234 567.89
                // - Espacio = separador de miles
                // - Punto (.) = separador decimal
                clean = clean.replace(/\s/g, '');     // Eliminar espacios
                clean = clean.replace(/,/g, '.');     // Tolerancia: convertir coma a punto
                break;
        }
        
        // 7. Parsear el resultado limpio
        const result = parseFloat(clean);
        
        // 8. Validaciones de seguridad
        if (!isFinite(result) || isNaN(result)) {
            return 0;
        }
        
        // 9. Verificar rangos razonables
        if (Math.abs(result) > 1e15) {
            return 0;
        }
        
        return result;
    }
    
    /**
     * Detecta automáticamente el formato numérico según el navegador del usuario
     * @returns {string} 'euro', 'latam', o 'intl'
     */
    function detectUserLocale() {
        const locale = navigator.language || navigator.userLanguage || 'en-US';
        
        const localeMap = {
            // Formato EURO
            'es-ES': 'euro', 'de-DE': 'euro', 'de-AT': 'euro', 'de-CH': 'euro',
            'fr-FR': 'euro', 'fr-BE': 'euro', 'fr-CH': 'euro', 'it-IT': 'euro',
            'it-CH': 'euro', 'nl-NL': 'euro', 'nl-BE': 'euro', 'pt-PT': 'euro',
            'da-DK': 'euro', 'no-NO': 'euro', 'sv-SE': 'euro', 'fi-FI': 'euro',
            'pl-PL': 'euro', 'cs-CZ': 'euro', 'ro-RO': 'euro', 'hu-HU': 'euro',
            'tr-TR': 'euro', 'el-GR': 'euro',
            // Formato LATAM
            'es-MX': 'latam', 'es-AR': 'latam', 'es-CO': 'latam', 'es-CL': 'latam',
            'es-PE': 'latam', 'es-VE': 'latam', 'es-EC': 'latam', 'es-GT': 'latam',
            'es-CU': 'latam', 'es-BO': 'latam', 'es-DO': 'latam', 'es-HN': 'latam',
            'es-PY': 'latam', 'es-SV': 'latam', 'es-NI': 'latam', 'es-CR': 'latam',
            'es-PA': 'latam', 'es-UY': 'latam', 'pt-BR': 'latam', 'en-US': 'latam',
            'en-CA': 'latam', 'en-GB': 'latam', 'en-AU': 'latam', 'en-NZ': 'latam',
            'en-ZA': 'latam', 'en-IE': 'latam', 'zh-CN': 'latam', 'zh-TW': 'latam',
            'ja-JP': 'latam', 'ko-KR': 'latam'
        };
        
        if (localeMap[locale]) {
            return localeMap[locale];
        }
        
        const lang = locale.split('-')[0];
        const langDefaults = {
            'es': 'latam', 'en': 'latam', 'de': 'euro', 'fr': 'euro',
            'it': 'euro', 'pt': 'latam', 'nl': 'euro', 'pl': 'euro',
            'tr': 'euro', 'zh': 'latam', 'ja': 'latam', 'ko': 'latam'
        };
        
        return langDefaults[lang] || 'intl';
    }
    
    /**
     * Inicializar configuración por defecto si es la primera vez
     */
    function initializeDefaultSettings() {
        if (!appData.settings.numberFormat) {
            appData.settings.numberFormat = detectUserLocale();
            saveData();
            console.log(`📍 Formato numérico detectado: "${appData.settings.numberFormat}"`);
        }
    }
    
    /**
     * Validación visual de inputs numéricos
     * @param {HTMLInputElement} input - El input a validar
     */
    function validateNumberInput(input) {
        const value = input.value.trim();
        
        if (value === '') {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.title = '';
            return;
        }
        
        const parsed = parseNumber(value);
        const isInvalid = (parsed === 0 && value !== '0' && value !== '0.0' && value !== '0,0');
        
        if (isInvalid) {
            input.style.borderColor = '#e53e3e';
            input.style.backgroundColor = '#fff5f5';
            input.title = 'Formato numérico incorrecto. Verifica el separador decimal.';
        } else {
            input.style.borderColor = '';
            input.style.backgroundColor = '';
            input.title = '';
        }
    }

    // Wrapper mejorado para eventos onchange con soporte de redondeo y autoformateo
    function handleMathInput(inputElement, type = 'total') {
        const rawResult = solveMathExpression(inputElement.value);
        const roundedResult = roundToConfig(rawResult, type);
        
        // AUTOFORMATEO: Actualizar visualmente el input al formato regional
        inputElement.value = formatNumber(roundedResult, type);
        
        return roundedResult;
    }

    // Función para autoformatear inputs en onblur
    function autoformatInput(inputElement, type = 'total') {
        if (!inputElement.value || inputElement.value.trim() === '') return;
        
        // Parsear el valor
        const parsed = parseNumber(inputElement.value);
        
        // Redondear según el tipo
        const rounded = roundToConfig(parsed, type);
        
        // Formatear visualmente
        inputElement.value = formatNumber(rounded, type);
    }

    window.onload = function() {
        loadFromStorage();
        initializeDefaultSettings(); // <-- DETECCIÓN AUTOMÁTICA DE FORMATO
        renderB1(); 
        renderBankList(); 
        renderDBTables(); 
        loadSettingsToUI();
        setupEditModeShortcuts();
        updatePrecisionIndicator();
    };

    // --- GESTIÓN DE LOCALSTORAGE (AutoGuardado con DEBOUNCE) ---
    function saveData() {
        // 1. Indicador Visual Inmediato (para que el usuario sepa que hay cambios pendientes)
        const indicator = document.getElementById('save-indicator');
        if(indicator) {
            indicator.classList.add('unsaved');
            indicator.title = "Guardando cambios...";
        }

        // 2. Cancelar el guardado anterior si el usuario sigue escribiendo
        clearTimeout(saveTimeout);

        // 3. Esperar 1.5 segundos antes de guardar realmente
        saveTimeout = setTimeout(() => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(appData));
                
                // Notificar éxito
                if(indicator) {
                    indicator.classList.remove('unsaved');
                    indicator.title = "Todos los cambios guardados";
                }
                
                // Toast opcional (no abusar)
                // showToast('Guardado automático completo'); 
            } catch (e) {
                console.error("Error al guardar (posible quota excedida)", e);
                showToast('Error: Memoria llena. Exporta tu proyecto.');
            }
        }, 1500); // 1500ms de espera
    }
    
    function loadFromStorage() {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
            try {
                const parsed = JSON.parse(stored);
                appData = { ...appData, ...parsed };
                
                // Asegurar estructura base
                if(!appData.database) appData.database = JSON.parse(JSON.stringify(initialDB));
                if(!appData.projectItems) appData.projectItems = [];
                if(!appData.itemBank) appData.itemBank = [];
                if(!appData.modules || appData.modules.length === 0) {
                    const defaultId = 'mod_' + Date.now();
                    appData.modules = [{ id: defaultId, name: "General" }];
                    appData.activeModuleId = defaultId;
                }
                
                // --- MIGRACIÓN CRÍTICA: AGREGAR IDs SI FALTAN ---
                ['materiales', 'mano_obra', 'equipos'].forEach(type => {
                    if (appData.database[type]) {
                        appData.database[type].forEach((item, idx) => {
                            // Si el item no tiene ID, le creamos uno usando la fecha + índice para evitar duplicados
                            if (!item.id) {
                                item.id = Date.now() + idx + Math.floor(Math.random() * 10000);
                            }
                        });
                    }
                });
                
                // Asegurar configuraciones
                if(!appData.settings) appData.settings = {};
                const defaults = { social: 55, iva_mo: 14.94, tools: 5, gg: 10, util: 10, it: 3.09, decimals_yield: 5, decimals_price: 3, decimals_total: 2, numberFormat: 'intl' };
                appData.settings = { ...defaults, ...appData.settings };

            } catch(e) {
                console.error("Error cargando LocalStorage", e);
                // Si falla, reiniciamos para evitar bloqueo
                localStorage.removeItem(STORAGE_KEY);
            }
        } else {
            // Inicialización nueva desde cero
            const defaultId = 'mod_' + Date.now();
            appData.modules = [{ id: defaultId, name: "General" }];
            appData.activeModuleId = defaultId;
            
            // Asignar IDs a la base de datos inicial hardcodeada
            ['materiales', 'mano_obra', 'equipos'].forEach(type => {
                appData.database[type].forEach((item, idx) => {
                    item.id = Date.now() + idx + Math.floor(Math.random() * 10000);
                });
            });
        }
    }

    // --- LÓGICA DE BORRADO SELECTIVO ---
    function openDeleteModal() {
        document.getElementById('deleteOptionsModal').style.display = 'block';
    }

    function closeDeleteModal() {
        document.getElementById('deleteOptionsModal').style.display = 'none';
    }

    function clearBudgetOnly() {
        // Pregunta de seguridad simple
        if(confirm("¿Estás seguro de vaciar SOLAMENTE los ítems del presupuesto actual?\n\nTu Banco de Ítems y Base de Insumos NO se borrarán.")) {
            
            // Vaciamos el array de ítems del proyecto
            appData.projectItems = [];
            
            // Opcional: Si quieres reiniciar también los módulos a uno solo "General", descomenta esto:
            const defaultId = 'mod_' + Date.now();
            appData.modules = [{ id: defaultId, name: "General" }];
            appData.activeModuleId = defaultId;

            saveData();
            renderB1();      // Actualizar tabla
            recalculateTotalsDisplay(); // Actualizar totales visuales
            closeDeleteModal();
            showToast("Presupuesto vaciado correctamente");
        }
    }

    function confirmFullReset() {
        // Cierra el modal y llama a la función destructiva original
        closeDeleteModal();
        // Pequeño delay para que la UI se sienta fluida
        setTimeout(() => {
            resetData(); // Tu función original que borra caché, cookies y localStorage
        }, 100);
    }
    
    // --- FUNCIÓN DE RESETEO PROFUNDO (STORAGE + COOKIES + CACHE) ---
    async function resetData() {
        if (!confirm("⚠️ ATENCIÓN ⚠️\nEsta acción realizará un BORRADO DE FÁBRICA:\n\n1. Eliminará todos los proyectos y bancos de ítems.\n2. Borrará la configuración personal.\n3. Limpiará la Memoria Caché y Cookies de la aplicación.\n\n¿Estás absolutamente seguro de continuar?")) {
            return;
        }

        showToast("Iniciando limpieza profunda...");
        
        // 1. Limpiar Almacenamiento Local y de Sesión
        try {
            localStorage.clear(); // Borra todo el LocalStorage del dominio
            sessionStorage.clear(); // Borra la sesión actual
        } catch (e) { console.error("Error limpiando Storage", e); }

        // 2. Limpiar Cookies
        try {
            document.cookie.split(";").forEach((c) => {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
            });
        } catch (e) { console.error("Error limpiando Cookies", e); }

        // 3. Limpiar Caché de Archivos (Service Worker Cache)
        if ('caches' in window) {
            try {
                const keys = await caches.keys();
                await Promise.all(keys.map(key => caches.delete(key)));
                console.log("Caché de archivos eliminada.");
            } catch (e) {
                console.error("Error limpiando Cache Storage", e);
            }
        }

        // 4. Desregistrar Service Workers (Para forzar actualización de la PWA)
        if ('serviceWorker' in navigator) {
            try {
                const registrations = await navigator.serviceWorker.getRegistrations();
                for (const registration of registrations) {
                    await registration.unregister();
                }
                console.log("Service Workers desregistrados.");
            } catch (e) {
                console.error("Error desregistrando SW", e);
            }
        }

        showToast("Limpieza completada. Reiniciando sistema...");

        // 5. Recarga forzada desde el servidor (ignora caché)
        setTimeout(() => {
            window.location.reload(true);
        }, 1500);
    }

    function showToast(message) {
        const x = document.getElementById("toast");
        x.textContent = message;
        x.className = "show";
        setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
    }

    // --- UX: SELECCIÓN AUTOMÁTICA AL NAVEGAR ---
    document.addEventListener('focusin', function(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            setTimeout(() => {
                e.target.select();
            }, 50);
        }
    });

    // --- NAVEGACIÓN ---
    function switchTab(tabId) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        let pId = (tabId === 'items' ? 'items' : (tabId === 'config' ? 'config' : (tabId === 'db' ? 'db' : 'b1')));
        document.getElementById('panel-' + pId).classList.add('active');
        
        const tabs = document.querySelectorAll('.tab');
        if(tabId === 'b1') tabs[0].classList.add('active');
        if(tabId === 'items') tabs[1].classList.add('active');
        if(tabId === 'db') tabs[2].classList.add('active');
        
        // Al cambiar de tab, hacemos scroll arriba
        window.scrollTo(0, 0);
    }

    // --- FUNCIONES DE PAGINACIÓN ---
    function changePage(section, direction) {
        const totalItems = getTotalItemsForSection(section);
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        
        currentPage[section] += direction;
        
        // Asegurar que esté en rango
        if (currentPage[section] < 1) currentPage[section] = 1;
        if (currentPage[section] > totalPages) currentPage[section] = totalPages;
        
        // Re-renderizar la sección correspondiente
        switch(section) {
            case 'b1':
                renderB1();
                break;
            case 'bank':
                renderBankList();
                break;
            case 'db-mat':
            case 'db-mo':
            case 'db-eq':
                renderDBTables();
                break;
        }
    }
    
    function getTotalItemsForSection(section) {
        switch(section) {
            case 'b1':
                return appData.projectItems.filter(item => item.moduleId === appData.activeModuleId).length;
            case 'bank':
                return appData.itemBank.length;
            case 'db-mat':
                return appData.database.materiales.length;
            case 'db-mo':
                return appData.database.mano_obra.length;
            case 'db-eq':
                return appData.database.equipos.length;
            default:
                return 0;
        }
    }
    
    function updatePaginationInfo(section, totalItems) {
        const totalPages = Math.ceil(totalItems / itemsPerPage);
        const paginationDiv = document.getElementById(`${section}-pagination`);
        const pageInfo = document.getElementById(`${section}-page-info`);
        
        if (totalPages > 1) {
            paginationDiv.style.display = 'flex';
            pageInfo.textContent = `Página ${currentPage[section]} de ${totalPages} (${totalItems} items)`;
        } else {
            paginationDiv.style.display = 'none';
        }
    }

    function getNextBankCode() {
        let max = 0;
        appData.itemBank.forEach(i => {
            const num = parseInt(i.code);
            if(!isNaN(num) && num > max) max = num;
        });
        return max + 1;
    }

    // --- GESTIÓN DE MÓDULOS ---

    function renderModuleTabs() {
        const container = document.getElementById('module-tabs');
        container.innerHTML = '';

        appData.modules.forEach(mod => {
            const tab = document.createElement('div');
            tab.className = `module-tab ${mod.id === appData.activeModuleId ? 'active' : ''}`;
            tab.textContent = mod.name;
            tab.onclick = () => switchModule(mod.id);
            tab.ondblclick = () => renameCurrentModule(); // Doble click para renombrar
            container.appendChild(tab);
        });
        
        // Actualizar etiqueta de total
        const currentMod = appData.modules.find(m => m.id === appData.activeModuleId);
        if(currentMod) {
            document.getElementById('current-module-name-display').innerText = currentMod.name;
        }
    }

    function switchModule(id) {
        appData.activeModuleId = id;
        currentPage.b1 = 1; // Reset paginación al cambiar de pestaña
        saveData();
        renderB1(); // Renderizará filtro y pestañas
    }

    function addModule() {
        const name = prompt("Nombre del nuevo módulo:", "Nuevo Módulo");
        if (name) {
            const newId = 'mod_' + Date.now() + Math.floor(Math.random() * 1000);
            appData.modules.push({ id: newId, name: name });
            switchModule(newId); // Cambiar al nuevo automáticamente
            showToast("Módulo creado");
        }
    }

    function renameCurrentModule() {
        const current = appData.modules.find(m => m.id === appData.activeModuleId);
        if (!current) return;
        
        const newName = prompt("Renombrar módulo:", current.name);
        if (newName && newName.trim() !== "") {
            current.name = newName;
            saveData();
            renderModuleTabs(); // Solo re-renderizar pestañas
        }
    }

    function cloneCurrentModule() {
        const currentMod = appData.modules.find(m => m.id === appData.activeModuleId);
        if (!currentMod) return;

        const newName = prompt("Nombre para el módulo clonado:", "Copia de " + currentMod.name);
        if (newName === null) return;

        const finalName = newName.trim() === "" ? "Copia de " + currentMod.name : newName;
        const newModuleId = 'mod_' + Date.now() + Math.floor(Math.random() * 1000);
        
        appData.modules.push({ id: newModuleId, name: finalName });

        const itemsToClone = appData.projectItems.filter(i => i.moduleId === appData.activeModuleId);
        let baseTime = Date.now();

        itemsToClone.forEach((item, index) => {
            const newItem = JSON.parse(JSON.stringify(item));
            newItem.id = baseTime + index + Math.floor(Math.random() * 10000);
            newItem.moduleId = newModuleId;
            appData.projectItems.push(newItem);
        });

        saveData();
        switchModule(newModuleId);
        showToast("Módulo clonado exitosamente");
    }

    function deleteCurrentModule() {
        if (appData.modules.length <= 1) {
            showToast("Debe existir al menos un módulo.");
            return;
        }

        // Verificar si tiene items
        const itemsInModule = appData.projectItems.filter(i => i.moduleId === appData.activeModuleId);
        if (itemsInModule.length > 0) {
            if (!confirm(`El módulo tiene ${itemsInModule.length} ítems. ¿Estás seguro de eliminarlos todos?`)) {
                return;
            }
            // Eliminar items del módulo
            appData.projectItems = appData.projectItems.filter(i => i.moduleId !== appData.activeModuleId);
        }

        // Eliminar módulo
        appData.modules = appData.modules.filter(m => m.id !== appData.activeModuleId);
        // Cambiar al anterior
        appData.activeModuleId = appData.modules[appData.modules.length - 1].id;
        
        saveData();
        renderB1();
        showToast("Módulo eliminado");
    }

    // --- PRESUPUESTO B1 (con DocumentFragment y Paginación) ---
    function renderB1() {
        // 1. Renderizar pestañas primero
        renderModuleTabs();

        const tbody = document.getElementById('b1-body');
        tbody.innerHTML = '';
        
        // 2. FILTRAR items por el módulo activo
        const moduleItems = appData.projectItems.filter(item => item.moduleId === appData.activeModuleId);

        // Calcular índices para paginación (basado en items filtrados)
        const totalItems = moduleItems.length;
        const start = (currentPage.b1 - 1) * itemsPerPage;
        const end = Math.min(start + itemsPerPage, totalItems);
        const itemsToRender = moduleItems.slice(start, end);
        
        const fragment = document.createDocumentFragment(); 
        let moduleTotal = 0;

        itemsToRender.forEach((item, index) => {
            const globalIndex = start + index;
            
            // --- INICIO CORRECCIÓN ---
            // 1. Calcular el Precio Unitario crudo (con todos los decimales)
            const rawUnitPrice = calculateUnitPrice(item);
            
            // 2. Redondear Precio y Cantidad SEGÚN CONFIGURACIÓN (lo que ve el ojo)
            const roundedUnitPrice = roundToConfig(rawUnitPrice, 'total'); 
            const roundedQty = roundToConfig(item.quantity, 'qty');
            
            // 3. Multiplicar los valores ya redondeados
            const total = roundedUnitPrice * roundedQty;
            
            // Acumulamos el total redondeado para el módulo
            moduleTotal += total;
            // --- FIN CORRECCIÓN ---
            
            const tr = document.createElement('tr');
            tr.setAttribute('data-id', item.id);
            
            // CÓDIGO CORREGIDO (CON COLUMNA ACCIONES)
            tr.innerHTML = `
                <td class="text-center">
                    <button class="btn btn-primary btn-sm" onclick="editItem('project', ${item.id})" title="Editar">
                        <i class="fas fa-edit"></i>
                    </button>
                </td>
                <td class="text-center" style="font-weight:600;">${globalIndex + 1}</td>
                <td><input type="text" value="${item.projectCode || ''}" onchange="updateProjectItem(${item.id}, 'projectCode', this.value)" placeholder="-" style="text-align:center;"></td>
                <td><textarea class="table-input" onchange="updateProjectItem(${item.id}, 'description', this.value)">${escapeHtml(item.description)}</textarea></td>
                <td><input type="text" value="${escapeHtml(item.unit)}" onchange="updateProjectItem(${item.id}, 'unit', this.value)"></td>
                <td><input type="text" inputmode="decimal" value="${fmt(item.quantity, 'qty')}" onchange="updateProjectItem(${item.id}, 'quantity', handleMathInput(this, 'qty'))" onfocus="this.select()" style="text-align:center;"></td>
                <td class="text-right" style="font-weight:600;">${fmt(rawUnitPrice, 'total')}</td>
                <td class="text-right font-bold">${fmt(total, 'total')}</td>
                <td class="text-center">
                    <div class="actions-row">
                        <button class="btn btn-info btn-sm" onclick="duplicateProjectItem(${item.id})" title="Duplicar">
                            <i class="fas fa-copy"></i>
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="saveProjectItemToBank(${item.id})" title="Guardar en Banco">
                            <i class="fas fa-save"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteProjectItem(${item.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
                `;
            fragment.appendChild(tr);
        });
        
        tbody.appendChild(fragment);
        
        updatePaginationInfo('b1', totalItems);
        
        // 3. CALCULO DE TOTALES (Usando la nueva función centralizada)
        recalculateTotalsDisplay();

        // Reiniciar Sortable para la lista actual
        initSortableB1(); 
    }

    // SOLUCIÓN A: DOM Patching para evitar pérdida de foco
    function updateProjectItem(id, field, value) {
        const item = appData.projectItems.find(i => i.id === id);
        if(item) {
            // 1. Actualizar datos
            item[field] = (field === 'quantity') ? parseNumber(value) : value;
            
            // 2. Guardar (el debounce se encarga de no saturar el storage)
            saveData(); 

            // 3. OPTIMIZACIÓN: NO llamar a renderB1().
            // Solo actualizamos los cálculos visuales si cambió la cantidad.
            if (field === 'quantity') {
                updateRowCalculations(item.id); 
            }
            
            // Si el cambio fue en descripción o unidad, no hace falta hacer nada visual extra,
            // el input ya tiene el valor nuevo porque el usuario lo escribió.
        }
    }

    // Nueva función para actualizar solo los números de esa fila y el total global
    function updateRowCalculations(itemId) {
        const item = appData.projectItems.find(i => i.id === itemId);
        if (!item) return;

        // Buscar la fila en el DOM
        const row = document.querySelector(`tr[data-id="${itemId}"]`);
        if (!row) return; // Puede que esté en otra página

        // 1. Obtener P. Unitario base
        const rawUnitPrice = calculateUnitPrice(item);
        
        // 2. Redondear ambos valores antes de operar
        const roundedUnitPrice = roundToConfig(rawUnitPrice, 'total');
        const roundedQty = roundToConfig(item.quantity, 'qty');
        
        // 3. Calcular Total de la fila
        const total = roundedUnitPrice * roundedQty;

        // Actualizar celda de total en esa fila (asumiendo que es la 7ma columna, índice 6)
        const totalCell = row.cells[6]; 
        if(totalCell) totalCell.innerText = fmt(total, 'total');

        // Actualizar Totales Generales (Módulo y Global)
        recalculateTotalsDisplay(); 
    }

    // Función separada para recalcular totales sin tocar la tabla
    function recalculateTotalsDisplay() {
        // Función interna para calcular el precio de línea redondeado
        const getLineTotal = (item) => {
            const rawUnitPrice = calculateUnitPrice(item);
            const roundedUnitPrice = roundToConfig(rawUnitPrice, 'total');
            const roundedQty = roundToConfig(item.quantity, 'qty');
            return roundedUnitPrice * roundedQty;
        };

        // Total Módulo
        const moduleItems = appData.projectItems.filter(item => item.moduleId === appData.activeModuleId);
        const moduleTotal = moduleItems.reduce((sum, item) => sum + getLineTotal(item), 0);
        
        // Total Global
        const grandTotal = appData.projectItems.reduce((sum, item) => sum + getLineTotal(item), 0);

        // Actualizar DOM
        document.getElementById('module-total-display').innerText = fmt(moduleTotal, 'total');
        document.getElementById('grand-total-display').innerText = fmt(grandTotal, 'total');
    }

    function createEmptyItemB1() {
       const newItem = { 
            id: Date.now() + Math.floor(Math.random() * 1000),
            projectCode: "", 
            description: "Nuevo Ítem", 
            unit: "glb", 
            quantity: 1, 
            materiales: [],
            mano_obra: [],
            equipos: [],
            moduleId: appData.activeModuleId
        };
        appData.projectItems.push(newItem);
        saveData();
        renderB1();
        setTimeout(() => {
            const rows = document.querySelectorAll('#b1-body tr');
            if(rows.length > 0) {
                const lastRow = rows[rows.length - 1];
                const descInput = lastRow.querySelector('textarea');
                if(descInput) { descInput.focus(); descInput.select(); }
            }
        }, 100);
    }

    function duplicateProjectItem(id) {
        const item = appData.projectItems.find(i => i.id === id);
        if(!item) return;
        
        const newItem = JSON.parse(JSON.stringify(item));
        newItem.id = Date.now() + Math.floor(Math.random() * 1000);
        // Insertar justo después del original para mejor UX
        const index = appData.projectItems.indexOf(item);
        appData.projectItems.splice(index + 1, 0, newItem);
        
        saveData();
        renderB1();
        showToast('Ítem duplicado correctamente');
    }

    function deleteProjectItem(id) {
        if(confirm("¿Eliminar este ítem del presupuesto?")) {
            appData.projectItems = appData.projectItems.filter(i => i.id !== id);
            saveData();
            renderB1();
        }
    }

    function saveProjectItemToBank(id) {
        const item = appData.projectItems.find(i => i.id === id);
        if(!item) return;
        if(confirm(`¿Guardar "${item.description}" en el Banco de Ítems?`)) {
            const newItem = JSON.parse(JSON.stringify(item));
            newItem.id = Date.now() + Math.floor(Math.random() * 1000); 
            newItem.code = getNextBankCode(); 
            newItem.quantity = 1; 
            delete newItem.moduleId; // No guardar moduleId en el banco
            appData.itemBank.push(newItem);
            saveData();
            renderBankList();
            showToast(`Guardado en banco con código: ${newItem.code}`);
        }
    }

    // --- FUNCIONES PARA INSUMOS DEL PRESUPUESTO ---
    function collectInsumosFromProject(type) {
        insumosList = [];
        
        const resourceKey = type; 
        const insumosMap = new Map();

        // Recorrer todos los items del proyecto
        appData.projectItems.forEach(item => {
            if (item[resourceKey]) {
                item[resourceKey].forEach(resource => {
                    // Multiplicar REND (qty) por la CANTIDAD del ítem (item.quantity)
                    const cantidadTotal = resource.qty * item.quantity;
                    const precioTotal = cantidadTotal * resource.price;
                    
                    // Clave única compuesta
                    const key = `${resource.desc.toLowerCase()}|${resource.unit}`;
                    
                    if (insumosMap.has(key)) {
                        // Sumar cantidad total y precio total
                        const entry = insumosMap.get(key);
                        entry.cantidadTotal += cantidadTotal;
                        entry.precioTotal += precioTotal;
                        
                        // Si el precio es diferente, lo marcamos como conflicto
                        if (Math.abs(entry.precioUnitario - resource.price) > 0.001) {
                            entry.tieneConflictosPrecio = true;
                            // Guardamos todos los precios encontrados
                            if (!entry.preciosEncontrados) {
                                entry.preciosEncontrados = [entry.precioUnitario];
                            }
                            if (!entry.preciosEncontrados.includes(resource.price)) {
                                entry.preciosEncontrados.push(resource.price);
                            }
                        }
                        
                        entry.occurrences.push({
                            itemId: item.id,
                            itemDesc: item.description,
                            rendimiento: resource.qty,
                            cantidadItem: item.quantity,
                            cantidadTotal: cantidadTotal,
                            precioUnitario: resource.price,
                            precioTotal: precioTotal
                        });
                    } else {
                        // Nuevo insumo
                        insumosMap.set(key, {
                            desc: resource.desc,
                            unit: resource.unit,
                            cantidadTotal: cantidadTotal,
                            precioUnitario: resource.price,
                            precioTotal: precioTotal,
                            selected: false,
                            tieneConflictosPrecio: false,
                            preciosEncontrados: [resource.price],
                            occurrences: [{
                                itemId: item.id,
                                itemDesc: item.description,
                                rendimiento: resource.qty,
                                cantidadItem: item.quantity,
                                cantidadTotal: cantidadTotal,
                                precioUnitario: resource.price,
                                precioTotal: precioTotal
                            }]
                        });
                    }
                });
            }
        });
        
        // Convertir mapa a array
        insumosList = Array.from(insumosMap.values());
    }

    function openInsumosModal(type) {
        currentInsumosType = type;
        const tipoTexto = {
            'materiales': 'Materiales',
            'mano_obra': 'Mano de Obra',
            'equipos': 'Equipos'
        };
        
        document.getElementById('modalTipoInsumo').textContent = tipoTexto[type];
        document.getElementById('insumosModal').style.display = 'block';
        
        // Recopilar insumos del tipo especificado
        collectInsumosFromProject(type);
        renderInsumosTable();
    }

    function renderInsumosTable() {
        const tbody = document.getElementById('insumosTableBody');
        tbody.innerHTML = '';
        
        if (insumosList.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center" style="padding: 20px; color: #718096;">
                        <i class="fas fa-info-circle"></i> No se encontraron insumos de este tipo en el presupuesto.
                    </td>
                </tr>
            `;
            return;
        }
        
        // Ordenar por descripción
        insumosList.sort((a, b) => a.desc.localeCompare(b.desc));
        
        const fragment = document.createDocumentFragment();
        
        insumosList.forEach((insumo, index) => {
            const tr = document.createElement('tr');
            if (insumo.tieneConflictosPrecio) {
                tr.style.backgroundColor = '#fff5f5';
            }
            
            tr.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="insumo-checkbox" 
                           ${insumo.selected ? 'checked' : ''}
                           onchange="toggleInsumoSelection(${index}, this.checked)">
                </td>
                <td>${insumo.desc} ${insumo.tieneConflictosPrecio ? '<span style="color: #e53e3e; font-size: 0.8em;" title="Este insumo tiene diferentes precios en el presupuesto">⚠</span>' : ''}</td>
                <td class="text-center">${insumo.unit}</td>
                <td class="text-right">${fmt(insumo.cantidadTotal, 'qty')}</td>
                <td class="text-right">
                    <input type="text" inputmode="decimal" class="precio-editable" 
                        value="${insumo.precioUnitario}" 
                        onfocus="this.select()"
                        onchange="updatePrecioInsumo(${index}, handleMathInput(this, 'price'))">
                </td>
                <td class="text-right font-bold">${fmt(insumo.precioTotal, 'total')}</td>
            `;
            fragment.appendChild(tr);
        });

        // --- NUEVO CÓDIGO: CÁLCULO Y FILA DE TOTAL ---
        
        // 1. Calcular la suma total de la lista actual
        const totalGeneral = insumosList.reduce((sum, item) => sum + item.precioTotal, 0);

        // 2. Crear la fila de Total
        const trTotal = document.createElement('tr');
        // Estilos para resaltar la fila
        trTotal.style.backgroundColor = '#ebf8ff'; // Azul muy suave
        trTotal.style.borderTop = '2px solid #3182ce'; // Borde superior más grueso
        trTotal.style.fontWeight = '700';
        trTotal.style.color = '#2c5282';

        trTotal.innerHTML = `
            <td colspan="5" class="text-right" style="padding: 12px 10px; font-size: 1.1em;">TOTAL PRESUPUESTO:</td>
            <td class="text-right" style="padding: 12px 6px; font-size: 1.2em;">${fmt(totalGeneral, 'total')}</td>
        `;
        
        fragment.appendChild(trTotal);
        // ---------------------------------------------
        
        tbody.appendChild(fragment);
        
        // Actualizar checkbox "seleccionar todos"
        updateSelectAllCheckbox();
    }

    function updatePrecioInsumo(index, value) {
        // Usar parseNumber para respetar formato regional
        const precio = parseNumber(value);
        insumosList[index].precioUnitario = precio;
        insumosList[index].precioTotal = insumosList[index].cantidadTotal * precio;
        
        // Actualizar la fila para mostrar el nuevo total
        const tbody = document.getElementById('insumosTableBody');
        const row = tbody.children[index];
        if (row) {
            const totalCell = row.querySelector('td:nth-child(6)');
            if (totalCell) {
                totalCell.textContent = fmt(insumosList[index].precioTotal, 'total');
            }
                
            // También actualizar el valor en el input para que no tenga comas
            const precioInput = row.querySelector('td:nth-child(5) input');
            if (precioInput) {
                precioInput.value = precio;
            }
        }
    }

    function aplicarPrecioIndividual(index) {
        const precio = insumosList[index].precioUnitario;
        const desc = insumo.desc;
        const unit = insumo.unit;
        let cambiosRealizados = 0;
        
        // Aplicar el precio a todas las ocurrencias en el proyecto
        insumosList[index].occurrences.forEach(ocurrencia => {
            const item = appData.projectItems.find(i => i.id === ocurrencia.itemId);
            if (item) {
                const resourceKey = currentInsumosType;
                
                if (item[resourceKey]) {
                    item[resourceKey].forEach(resource => {
                        if (resource.desc.toLowerCase() === desc.toLowerCase() && 
                            resource.unit === unit) {
                            resource.price = precio;
                            cambiosRealizados++;
                        }
                    });
                }
            }
        });
        
        if (cambiosRealizados > 0) {
            saveData();
            renderB1();
            showToast(`Precio actualizado para "${desc}" en ${cambiosRealizados} recurso(s)`);
        } else {
            showToast(`No se encontraron recursos para actualizar`);
        }
    }

    function aplicarPreciosEditados() {
        let cambiosTotales = 0;
        const insumosActualizados = [];
        
        insumosList.forEach((insumo, index) => {
            const precio = insumo.precioUnitario;
            const desc = insumo.desc;
            const unit = insumo.unit;
            let cambiosInsumo = 0;
            
            // Aplicar el precio a todas las ocurrencias en el proyecto
            insumo.occurrences.forEach(ocurrencia => {
                const item = appData.projectItems.find(i => i.id === ocurrencia.itemId);
                if (item) {
                    const resourceKey = currentInsumosType;
                    
                    if (item[resourceKey]) {
                        item[resourceKey].forEach(resource => {
                            if (resource.desc.toLowerCase() === desc.toLowerCase() && 
                                resource.unit === unit) {
                                resource.price = precio;
                                cambiosInsumo++;
                            }
                        });
                    }
                }
            });
            
            if (cambiosInsumo > 0) {
                cambiosTotales += cambiosInsumo;
                insumosActualizados.push(desc);
            }
        });
        
        if (cambiosTotales > 0) {
            saveData();
            renderB1();
            showToast(`Precios actualizados para ${insumosActualizados.length} insumo(s) en todo el presupuesto`);
        } else {
            showToast('No se realizaron cambios en el presupuesto');
        }
    }

    function toggleInsumoSelection(index, checked) {
        insumosList[index].selected = checked;
        updateSelectAllCheckbox();
    }

    function toggleSelectAllInsumos(checkbox) {
        const isChecked = checkbox.checked;
        insumosList.forEach((insumo, index) => {
            insumo.selected = isChecked;
        });
        renderInsumosTable();
    }

    function updateSelectAllCheckbox() {
        const selectAllCheckbox = document.getElementById('selectAllInsumos');
        if (!selectAllCheckbox) return;
        
        const total = insumosList.length;
        const selected = insumosList.filter(i => i.selected).length;
        
        if (selected === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (selected === total) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = true;
        }
    }

    // --- LÓGICA DE UNIFICACIÓN CON VISTA DE USOS ---

    let pendingUnificationList = [];

    function initiateUnification() {
        // 1. Obtener seleccionados
        const selected = insumosList.filter(i => i.selected);
        
        // 2. Validación
        if (selected.length < 2) {
            showToast("Selecciona al menos 2 insumos para fusionar.");
            return;
        }

        pendingUnificationList = selected;
        
        // 3. Preparar UI del Modal
        const container = document.getElementById('unify-list-container');
        document.getElementById('unify-count').textContent = selected.length;
        container.innerHTML = '';

        selected.forEach((item, index) => {
            // Generar lista HTML de los items donde se usa
            // Usamos item.occurrences que ya generaste en collectInsumosFromProject
            let apuListHTML = '';
            if (item.occurrences && item.occurrences.length > 0) {
                apuListHTML = item.occurrences.map(occ => 
                    `<li><i class="fas fa-caret-right" style="color:var(--accent)"></i> ${occ.itemDesc} <span style="color:#718096">(${fmt(occ.rendimiento, 'yield')})</span></li>`
                ).join('');
            } else {
                apuListHTML = '<li>No se encontraron usos registrados.</li>';
            }

            const div = document.createElement('div');
            // Quitamos la clase 'unify-option' del contenedor padre para manejar el click mejor
            // y la ponemos en un wrapper interno o manejamos el evento con cuidado.
            // Aquí usaremos una estructura ligeramente distinta para permitir el click en el botón "ver" sin activar la selección.
            
            div.className = 'unify-wrapper'; 
            div.style.marginBottom = "10px";
            
            div.innerHTML = `
                <div class="unify-option" style="margin-bottom:0; border-bottom-left-radius:0; border-bottom-right-radius:0;">
                    <div class="unify-details" style="flex-grow:1;">
                        <span class="unify-name">${item.desc}</span>
                        <div class="unify-meta">
                            <span><i class="fas fa-ruler-combined"></i> ${item.unit}</span>
                            <span><i class="fas fa-tag"></i> ${fmt(item.precioUnitario, 'price')}</span>
                        </div>
                        
                        <div class="usage-badge" onclick="toggleUnifyDetails('usage-${index}', event)">
                            <i class="fas fa-list-ul"></i> Ver en qué ítems se usa (${item.occurrences.length}) <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>

                    <button class="btn btn-success btn-sm" onclick="executeUnification(${index})" style="margin-left:10px;">
                        Mantener este <i class="fas fa-check"></i>
                    </button>
                </div>
                
                <ul id="usage-${index}" class="apu-usage-list" style="margin-top:0; border-top:none; border-top-left-radius:0; border-top-right-radius:0;">
                    ${apuListHTML}
                </ul>
            `;
            container.appendChild(div);
        });

        // 4. Mostrar Modal
        document.getElementById('unifyModal').style.display = 'block';
    }

    // Helper para mostrar/ocultar la lista sin disparar otros eventos
    function toggleUnifyDetails(elementId, event) {
        if(event) event.stopPropagation(); // Evita que el click se propague si hubiera uno en el padre
        
        const list = document.getElementById(elementId);
        if (list.style.display === 'block') {
            list.style.display = 'none';
        } else {
            // Opcional: Cerrar otros abiertos para mantener limpieza
            document.querySelectorAll('.apu-usage-list').forEach(el => el.style.display = 'none');
            list.style.display = 'block';
        }
    }

    function closeUnifyModal() {
        document.getElementById('unifyModal').style.display = 'none';
        pendingUnificationList = [];
    }

    function executeUnification(masterIndex) {
        if (!confirm("¿Estás seguro? Esta acción no se puede deshacer.")) return;

        const master = pendingUnificationList[masterIndex];
        const victims = pendingUnificationList.filter((_, idx) => idx !== masterIndex);
        
        let changesCount = 0;
        
        // Clave normalizada para comparación (desc + unit)
        const getKey = (desc, unit) => `${desc.trim().toLowerCase()}|${unit.trim().toLowerCase()}`;
        
        // Crear Set de claves de las víctimas para búsqueda rápida
        const victimKeys = new Set(victims.map(v => getKey(v.desc, v.unit)));

        // 1. Recorrer TODO el presupuesto
        appData.projectItems.forEach(apu => {
            // Obtener el array correcto según el tipo actual (materiales, mano_obra, equipos)
            const type = currentInsumosType; // Variable global existente en tu código
            const resources = apu[type];

            if (resources && Array.isArray(resources)) {
                resources.forEach(res => {
                    const currentKey = getKey(res.desc, res.unit);
                    
                    // Si el recurso actual está en la lista de víctimas
                    if (victimKeys.has(currentKey)) {
                        // REEMPLAZO: Actualizamos al Maestro
                        res.desc = master.desc;
                        res.unit = master.unit;
                        res.price = master.precioUnitario; // Estandarizamos precio también
                        changesCount++;
                    }
                });
            }
        });

        // 2. Guardar y Refrescar
        saveData();
        
        // Cerrar modal de elección
        closeUnifyModal();
        
        // Recargar la lista de insumos (Modal Grande) para ver la fusión
        collectInsumosFromProject(currentInsumosType);
        renderInsumosTable();
        
        // Recargar presupuesto por si acaso está visible detrás
        renderB1(); 

        showToast(`¡Fusión completada! Se actualizaron ${changesCount} ocurrencias.`);
    }
    // --- EXPORTACIÓN A EXCEL ---
    async function exportInsumosToExcel() {
        if (insumosList.length === 0) {
            showToast('No hay insumos para exportar');
            return;
        }

        const tipoTexto = {
            'materiales': 'Materiales',
            'mano_obra': 'Mano_de_Obra',
            'equipos': 'Equipos'
        };

        const workbook = new ExcelJS.Workbook();
        const worksheet = workbook.addWorksheet('Insumos');

        // Título
        worksheet.mergeCells('A1:E1');
        const titleCell = worksheet.getCell('A1');
        titleCell.value = `INSUMOS ${tipoTexto[currentInsumosType].toUpperCase()} - PRESUPUESTO`;
        titleCell.font = { bold: true, size: 14 };
        titleCell.alignment = { horizontal: 'center' };

        // Cabeceras (Fila 2)
        worksheet.getRow(2).values = ['Descripción', 'Unidad', 'Cantidad Total', 'Precio Unitario', 'Total'];
        const headerRow = worksheet.getRow(2);
        headerRow.font = { bold: true, color: { argb: 'FFFFFFFF' } };
        headerRow.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2D3748' } };
        
        // Anchos
        worksheet.getColumn(1).width = 50;
        worksheet.getColumn(2).width = 10;
        worksheet.getColumn(3).width = 15;
        worksheet.getColumn(4).width = 15;
        worksheet.getColumn(5).width = 15;

        // Datos - ORDENADOS ALFABÉTICAMENTE POR DESCRIPCIÓN
        const insumosOrdenados = [...insumosList].sort((a, b) => 
            a.desc.localeCompare(b.desc, 'es', { sensitivity: 'base' })
        );

        insumosOrdenados.forEach(insumo => {
            const row = worksheet.addRow([
                insumo.desc,
                insumo.unit,
                insumo.cantidadTotal,
                insumo.precioUnitario,
                insumo.precioTotal
            ]);
            // Formato numérico
            row.getCell(3).numFmt = '#,##0.00';
            row.getCell(4).numFmt = '#,##0.00';
            row.getCell(5).numFmt = '#,##0.00';
        });

        // Total General
        const totalGeneral = insumosList.reduce((sum, insumo) => sum + insumo.precioTotal, 0);
        const totalRow = worksheet.addRow(['', '', '', 'TOTAL PRESUPUESTO:', totalGeneral]);
        totalRow.font = { bold: true };
        totalRow.getCell(5).numFmt = '#,##0.00 "Bs"';
        totalRow.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFBEE3F8' } };

        const buffer = await workbook.xlsx.writeBuffer();
        saveExcelBuffer(buffer, `Insumos_${tipoTexto[currentInsumosType]}_${new Date().toISOString().slice(0,10)}.xlsx`);
        showToast('Excel exportado correctamente');
    }

    function closeInsumosModal() {
        document.getElementById('insumosModal').style.display = 'none';
        insumosList = [];
    }

    // --- BANCO DE ÍTEMS (MODIFICADO: Orden A-Z y Numeración 1-2-3) ---
    function renderBankList() {
        const tbody = document.getElementById('bank-body');
        const searchTerm = document.getElementById('main-bank-search')?.value.toLowerCase() || "";
        tbody.innerHTML = '';
        
        // 1. Filtrar primero
        let filteredItems = appData.itemBank.filter(item => 
            item.description.toLowerCase().includes(searchTerm) || 
            item.code.toString().includes(searchTerm)
        );

        // 2. ORDENAR AUTOMÁTICAMENTE POR DESCRIPCIÓN (A-Z)
        filteredItems.sort((a, b) => {
            return a.description.localeCompare(b.description, undefined, { numeric: true, sensitivity: 'base' });
        });

        // 3. Aplicar paginación sobre los resultados filtrados y ordenados
        const totalItems = filteredItems.length;
        const start = (currentPage.bank - 1) * itemsPerPage;
        const end = start + itemsPerPage;
        const pagedItems = filteredItems.slice(start, end);

        pagedItems.forEach((item, index) => {
            const unitPrice = calculateUnitPrice(item);
            
            // CÁLCULO DE NUMERACIÓN VISUAL CONSECUTIVA (1, 2, 3...)
            // Se calcula sumando el índice actual + el desplazamiento de la página
            const visualIndex = start + index + 1;

            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td class="text-center">
                    <button class="btn btn-primary btn-sm" onclick="addSingleItemToProject(${item.id})">
                        <i class="fas fa-plus"></i>
                    </button>
                </td>
                <td class="text-center" style="font-weight:600;">${visualIndex}</td>
                <td>${item.description}</td>
                <td class="text-center">${item.unit}</td>
                <td class="text-right">${fmt(unitPrice, 'total')}</td>
                <td>
                    <div class="actions-row">
                        <button class="btn btn-primary btn-sm" onclick="editItem('bank', ${item.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteBankItem(${item.id})" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.appendChild(tr);
        });

        updatePaginationInfo('bank', totalItems);
    }

    function importBankItemToProject(bankItemId) {
        const bankItem = appData.itemBank.find(i => i.id === bankItemId);
        if(!bankItem) return;
        
        const newItem = JSON.parse(JSON.stringify(bankItem));
        newItem.id = Date.now() + Math.floor(Math.random() * 1000);
        newItem.quantity = 1;
        newItem.moduleId = appData.activeModuleId; // <--- ESTO ES CRÍTICO
        
        // Seguridad para insumos
        newItem.materiales = newItem.materiales || [];
        newItem.mano_obra = newItem.mano_obra || [];
        newItem.equipos = newItem.equipos || [];

        appData.projectItems.push(newItem);
        saveData();
        renderB1();
        showToast('Ítem agregado al módulo actual');
    }

    function createBankItem() {
        const newItem = { 
            id: Date.now() + Math.floor(Math.random() * 1000), 
            code: getNextBankCode(), 
            description: "Nuevo APU", 
            unit: "m3", 
            quantity: 1, 
            materiales: [], // CAMBIADO
            mano_obra: [],  // CAMBIADO
            equipos: [] 
        };
        appData.itemBank.push(newItem);
        saveData();
        renderBankList();
        const newItemId = appData.itemBank[appData.itemBank.length-1].id;
        editItem('bank', newItemId, true);
        setTimeout(() => {
            const descInput = document.getElementById('apu-desc');
            if(descInput) { descInput.focus(); descInput.select(); }
        }, 300);
    }

    function deleteBankItem(id) {
        if(confirm("¿Eliminar este ítem del Banco?")) {
            appData.itemBank = appData.itemBank.filter(i => i.id !== id);
            saveData();
            renderBankList(); // Aquí se re-numera automáticamente al renderizar
        }
    }

    // --- NUEVA FUNCIÓN: Sincronizar insumo importado a la BD ---
    function syncImportedResourceToDB(type, resource) {
        if (!appData.database[type]) {
            console.error(`Tipo de base de datos no válido: ${type}`);
            return 'error';
        }
        
        const list = appData.database[type];
        const resDesc = resource.desc.trim().toLowerCase();
        const resUnit = resource.unit.trim().toLowerCase();
        const resPrice = parseNumber(resource.price);

        // Buscar insumo existente (coincidencia exacta de Nombre y Unidad)
        const existingItem = list.find(item => 
            (item.desc || "").trim().toLowerCase() === resDesc && 
            (item.unit || "").trim().toLowerCase() === resUnit
        );

        if (existingItem) {
            // Si existe y el precio nuevo es válido y diferente, actualizamos
            if (resPrice > 0 && Math.abs(existingItem.price - resPrice) > 0.001) {
                existingItem.price = resPrice;
                return 'updated';
            }
            return 'exists';
        } else {
            // Si no existe, lo creamos
            // Generar código simple basado en la longitud actual
            const newCode = (list.length + 1).toString();
            list.push({
                id: Date.now() + Math.floor(Math.random() * 100000), // ID Único
                code: newCode,
                desc: resource.desc.trim(),
                unit: resource.unit.trim(),
                price: resPrice
            });
            return 'new';
        }
    }

    // --- IMPORTADOR EXCEL APU MEJORADO ---
    function importComplexAPUReport(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const buffer = e.target.result;
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(buffer);
                const worksheet = workbook.getWorksheet(1);
                
                // Convertir a Matriz
                const jsonData = sheetToDataArray(worksheet);

                // --- RESTO DEL CÓDIGO IDENTICO, SOLO CAMBIAMOS LA LECTURA INICIAL ---
                
                let importedCount = 0;
                let stats = { new: 0, updated: 0 }; 
                let currentItem = null;
                let currentSection = null;
                let baseCode = getNextBankCode();

                for (let i = 0; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    // Convertimos toda la fila a string para buscar palabras clave
                    const rowStr = row.map(c => c ? c.toString().toUpperCase() : "").join(" ");

                    let itemFound = false;
                    for(let c=0; c<row.length; c++) {
                        if(row[c] && row[c].toString().toUpperCase().includes("ITEM:")) {
                            if (currentItem && currentItem.description) { 
                                appData.itemBank.push(currentItem); importedCount++; 
                            }
                            
                            let parts = row[c].toString().split(":");
                            let name = parts.slice(1).join(":"); 
                            if(name.trim() === "" && row[c+1]) name = row[c+1];
                            
                            let unit = "glb";
                            for(let u=c; u<row.length; u++) {
                                if(row[u] && row[u].toString().toUpperCase().includes("UNIDAD:")) {
                                    let uParts = row[u].toString().split(":");
                                    let unitVal = uParts.slice(1).join(":");
                                    if(unitVal.trim() === "" && row[u+1]) unitVal = row[u+1];
                                    unit = unitVal.trim();
                                }
                            }

                            currentItem = {
                                id: Date.now() + Math.random(),
                                code: baseCode + importedCount,
                                description: name ? name.trim() : "Item Importado",
                                unit: unit,
                                quantity: 1,
                                materiales: [], mano_obra: [], equipos: [],
                                moduleId: appData.activeModuleId
                            };
                            currentSection = null; itemFound = true; break;
                        }
                    }
                    if(itemFound) continue;
                    if (!currentItem) continue;

                    if (rowStr.includes("MATERIALES") && !rowStr.includes("TOTAL")) { currentSection = 'MAT'; continue; }
                    if (rowStr.includes("MANO DE OBRA") && !rowStr.includes("TOTAL")) { currentSection = 'MO'; continue; }
                    if ((rowStr.includes("EQUIPO") || rowStr.includes("HERRAMIENTAS")) && !rowStr.includes("TOTAL")) { currentSection = 'EQ'; continue; }
                    
                    if (rowStr.includes("TOTAL") || rowStr.includes("SUBTOTAL")) { currentSection = null; continue; }

                    if (currentSection) {
                        // Indices aproximados
                        let desc = row[2]; 
                        let unit = row[3]; 
                        let qty = parseNumber(row[4]); 
                        let price = parseNumber(row[5]);
                        
                        if (desc && desc.toString().trim() !== "" && !isNaN(price)) {
                            let res = { desc: desc.toString().trim(), unit: unit || "u", qty: qty || 0, price: price || 0 };
                            let dbType = '';
                         
                            if (currentSection === 'MAT') { currentItem.materiales.push(res); dbType = 'materiales';}
                            else if (currentSection === 'MO') { currentItem.mano_obra.push(res); dbType = 'mano_obra';}
                            else if (currentSection === 'EQ') { currentItem.equipos.push(res); dbType = 'equipos';}

                            if (dbType) {
                                const result = syncImportedResourceToDB(dbType, res);
                                if (result === 'new') stats.new++;
                                if (result === 'updated') stats.updated++;
                            }
                        }
                    }
                }
                if (currentItem && currentItem.description) { appData.itemBank.push(currentItem); importedCount++; }

                saveData();
                renderBankList();
                renderDBTables();

                if(importedCount > 0) showToast(`Importados ${importedCount} APUs.`);
                else showToast('No se encontraron ítems');
                
                input.value = '';
            } catch(e) {
                console.error(e);
                showToast("Error leyendo archivo");
            }
        };
        reader.readAsArrayBuffer(file);
    }

    // --- EDITOR APU ---
    function editItem(context, id, isNew = false) {
        editorContext = context;
        currentEditId = id;
        isCreatingNew = isNew;
        
        // Resetear navegación si cambia el contexto
        if (editorSourceArray !== (context === 'project' ? appData.projectItems : appData.itemBank)) {
            editorNavigationIndex = -1;
        }
        
        let item = (context === 'project') ? appData.projectItems.find(i => i.id === id) : appData.itemBank.find(i => i.id === id);
        if(!item) return;

        editorBackup = JSON.parse(JSON.stringify(item));

        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.getElementById('panel-editor').classList.add('active');
        document.getElementById('editor-title').innerText = (context === 'project' ? "Editar Ítem Presup." : "Editar Ítem Banco");
        
        document.getElementById('apu-desc').value = item.description;
        document.getElementById('apu-unit').value = item.unit;
        document.getElementById('apu-qty').value = formatNumber(item.quantity, 'qty');
        document.getElementById('apu-qty').disabled = (context === 'bank');

        renderAPUTables(item);
    }

    function renderAPUTables(item) {
        // Helper seguro para asignar texto solo si el elemento existe
        const setText = (id, val) => {
            const el = document.getElementById(id);
            if (el) el.innerText = val;
        };

        const createRows = (arr, type) => {
            let html = '';
            let sum = 0;
            if (!arr) arr = [];
            arr.forEach((r, idx) => {
                // Asegurar números
                const qty = parseFloat(r.qty) || 0;
                const price = parseFloat(r.price) || 0;
                let t = qty * price;
                sum += t;
                
                // Usamos fmt() para visualización
                html += `<tr>
                    <td><textarea class="table-input" onchange="updateRes('${type}', ${idx}, 'desc', this.value)">${escapeHtml(r.desc)}</textarea></td>
                    <td><input type="text" value="${escapeHtml(r.unit)}" onchange="updateRes('${type}', ${idx}, 'unit', this.value)"></td>
                    <td><input type="text" inputmode="decimal" value="${fmt(qty, 'yield')}" onchange="updateRes('${type}', ${idx}, 'qty', handleMathInput(this, 'yield'))" onfocus="this.select()" style="text-align:center;"></td>
                    <td><input type="text" inputmode="decimal" value="${fmt(price, 'price')}" onchange="updateRes('${type}', ${idx}, 'price', handleMathInput(this, 'price'))" onfocus="this.select()" style="text-align:right;"></td>
                    <td class="text-right" style="font-weight:600;">${fmt(t, 'partial')}</td>
                    <td class="text-center"><button class="btn btn-danger btn-sm" onclick="removeRes('${type}', ${idx})" title="Eliminar"><i class="fas fa-times"></i></button></td>
                </tr>`;
            });
            return { html, sum };
        };

        const s = appData.settings;

        // --- 1. MATERIALES ---
        const mat = createRows(item.materiales, 'materiales');
        const tableMat = document.querySelector('#table-mat tbody');
        if(tableMat) tableMat.innerHTML = mat.html;
        setText('sub-mat', fmt(mat.sum, 'partial'));

        // --- 2. MANO DE OBRA ---
        const mo = createRows(item.mano_obra, 'mano_obra');
        const tableMo = document.querySelector('#table-mo tbody');
        if(tableMo) tableMo.innerHTML = mo.html;

        const socVal = mo.sum * (s.social / 100);
        const ivaVal = (mo.sum + socVal) * (s.iva_mo / 100);
        const totalMo = mo.sum + socVal + ivaVal;

        setText('mo-basic', fmt(mo.sum, 'partial'));
        setText('lbl-soc', s.social);
        setText('mo-soc', fmt(socVal, 'partial'));
        setText('lbl-iva', s.iva_mo);
        setText('mo-iva', fmt(ivaVal, 'partial'));
        setText('sub-mo', fmt(totalMo, 'partial'));

        // --- 3. EQUIPOS ---
        const eq = createRows(item.equipos, 'equipos');
        const tableEq = document.querySelector('#table-eq tbody');
        if(tableEq) tableEq.innerHTML = eq.html;

        const toolsVal = totalMo * (s.tools / 100);
        const totalEq = eq.sum + toolsVal;

        // Aquí es donde ocurría el error original:
        setText('eq-basic', fmt(eq.sum, 'partial'));
        setText('lbl-tools', s.tools);
        setText('eq-tools', fmt(toolsVal, 'partial'));
        setText('sub-eq', fmt(totalEq, 'partial'));

        // --- 4. RESUMEN FINAL (Costo Directo + Indirectos) ---
        const costoDirect = mat.sum + totalMo + totalEq;
        setText('sum-direct', fmt(costoDirect, 'partial'));

        const ggVal = costoDirect * (s.gg / 100);
        const utilVal = (costoDirect + ggVal) * (s.util / 100);
        const itVal = (costoDirect + ggVal + utilVal) * (s.it / 100);
        // Nota: El costo indirecto no se muestra sumado, sino desglosado
        
        setText('lbl-gg', s.gg);
        setText('sum-gg', fmt(ggVal, 'partial'));
        setText('lbl-util', s.util);
        setText('sum-util', fmt(utilVal, 'partial'));
        setText('lbl-it', s.it);
        setText('sum-it', fmt(itVal, 'partial'));

        // --- 5. PRECIO UNITARIO FINAL ---
        const precioUnit = costoDirect + ggVal + utilVal + itVal;
        setText('final-price', fmt(precioUnit, 'total'));

        // Reiniciar Sortables (Arrastrar y soltar)
        initSortableEditor('materiales');
        initSortableEditor('mano_obra');
        initSortableEditor('equipos');
    }

    function calculateUnitPrice(item) {
        const s = appData.settings;
        // Validar arrays por si acaso (migración en caliente)
        const mats = item.materiales || [];
        const mo = item.mano_obra || [];
        const eqs = item.equipos || [];

        const sumMat = mats.reduce((a,b)=>a+(b.qty*b.price),0);
        const sumMo = mo.reduce((a,b)=>a+(b.qty*b.price),0);
        
        const totalMo = sumMo + (sumMo*(s.social/100)) + ((sumMo+(sumMo*(s.social/100)))*(s.iva_mo/100));
        
        const sumEq = eqs.reduce((a,b)=>a+(b.qty*b.price),0);
        const totalEq = sumEq + (totalMo*(s.tools/100));
        
        const direct = sumMat + totalMo + totalEq;
        const gg = direct * (s.gg/100);
        const util = (direct + gg) * (s.util/100);
        const it = (direct + gg + util) * (s.it/100);
        
        return direct + gg + util + it;
    }

    function updateEditorMeta() {
        let item = (editorContext === 'project') ? appData.projectItems.find(i => i.id === currentEditId) : appData.itemBank.find(i => i.id === currentEditId);
        if(!item) return;
        
        item.description = document.getElementById('apu-desc').value;
        item.unit = document.getElementById('apu-unit').value;
        if(editorContext === 'project') item.quantity = parseNumber(document.getElementById('apu-qty').value);
        saveData(); 
    }

    function updateRes(type, idx, field, val) {
        let item = (editorContext === 'project') ? appData.projectItems.find(i => i.id === currentEditId) : appData.itemBank.find(i => i.id === currentEditId);
        if(!item) return;
        
        if(field === 'qty' || field === 'price') {
             item[type][idx][field] = parseNumber(val);
        } else {
             item[type][idx][field] = val;
        }
        renderAPUTables(item);
        saveData(); 
    }

    function removeRes(type, idx) {
        let item = (editorContext === 'project') ? appData.projectItems.find(i => i.id === currentEditId) : appData.itemBank.find(i => i.id === currentEditId);
        if(!item) return;
        
        if(confirm("¿Eliminar este recurso?")) {
            item[type].splice(idx, 1);
            renderAPUTables(item);
            saveData(); 
        }
    }

    // --- NAVEGACIÓN EN EDITOR ---
    // --- NAVEGACIÓN EN EDITOR (CORREGIDA POR MÓDULOS Y ORDEN VISUAL) ---
    // --- NAVEGACIÓN EN EDITOR (FLUIDA ENTRE MÓDULOS) ---
    function navigateEditor(direction) {
        if (!editorContext || !currentEditId) return;
        
        let navigationList = [];

        // 1. CONSTRUIR LA LISTA DE NAVEGACIÓN
        if (editorContext === 'project') {
            // CASO PRESUPUESTO: NAVEGACIÓN ENTRE MÓDULOS
            // Recorremos los módulos en el orden en que existen (pestañas)
            // y concatenamos sus ítems para crear una lista maestra secuencial.
            appData.modules.forEach(mod => {
                // Obtenemos los ítems de este módulo específico
                const itemsInModule = appData.projectItems.filter(i => i.moduleId === mod.id);
                // Los agregamos a la lista maestra
                navigationList = navigationList.concat(itemsInModule);
            });
        } else {
            // CASO BANCO: ORDEN ALFABÉTICO (Igual que antes)
            navigationList = [...appData.itemBank].sort((a, b) => {
                return a.description.localeCompare(b.description, undefined, { numeric: true, sensitivity: 'base' });
            });
        }
        
        // 2. ENCONTRAR LA POSICIÓN ACTUAL EN LA LISTA MAESTRA
        const currentIndex = navigationList.findIndex(item => item.id === currentEditId);
        
        if (currentIndex === -1) return; 

        // 3. CALCULAR EL NUEVO ÍNDICE
        const newIndex = currentIndex + direction;
        
        // 4. VERIFICAR LÍMITES GLOBALES
        if (newIndex < 0 || newIndex >= navigationList.length) {
            showToast(direction > 0 ? "Has llegado al final del presupuesto" : "Es el primer ítem del presupuesto");
            return;
        }
        
        // 5. GESTIÓN DE GUARDADO (Seguridad)
        if (hasUnsavedChanges()) {
            if (!confirm("Tienes cambios sin guardar. ¿Quieres guardar antes de navegar?")) {
                return;
            }
        }
        
        // Guardar datos actuales antes de saltar
        const sourceArray = editorContext === 'project' ? appData.projectItems : appData.itemBank;
        const currentRealItem = sourceArray.find(i => i.id === currentEditId);
        
        if (currentRealItem) {
            currentRealItem.description = document.getElementById('apu-desc').value;
            currentRealItem.unit = document.getElementById('apu-unit').value;
            if (editorContext === 'project') {
                currentRealItem.quantity = parseNumber(document.getElementById('apu-qty').value);
            }
        }
        
        // 6. OBTENER EL SIGUIENTE ÍTEM
        const nextItem = navigationList[newIndex];

        // 7. DETECTAR CAMBIO DE MÓDULO (Solo para Presupuesto)
        // Si el siguiente ítem pertenece a un módulo diferente al actual,
        // actualizamos el módulo activo para que al cerrar el editor estemos en la pestaña correcta.
        if (editorContext === 'project' && nextItem.moduleId !== appData.activeModuleId) {
            appData.activeModuleId = nextItem.moduleId;
            // Opcional: Mostrar un aviso visual pequeño
            showToast(`Cambiando al módulo: ${appData.modules.find(m => m.id === nextItem.moduleId)?.name}`);
            
            // Actualizamos las pestañas visuales de fondo por si acaso
            renderModuleTabs();
            // Nota: No llamamos a renderB1() completo para no sobrecargar el editor
        }

        // 8. EJECUTAR NAVEGACIÓN
        editItem(editorContext, nextItem.id);
    }

    function hasUnsavedChanges() {
        if (!editorContext || !currentEditId) return false;
        
        const source = editorContext === 'project' ? appData.projectItems : appData.itemBank;
        const currentItem = source.find(item => item.id === currentEditId);
        
        if (!currentItem || !editorBackup) return false;
        
        // Comparar descripción, unidad y cantidad
        if (currentItem.description !== editorBackup.description ||
            currentItem.unit !== editorBackup.unit ||
            currentItem.quantity !== editorBackup.quantity) {
            return true;
        }
        
        // Comparar arrays de recursos
        const resourceTypes = ['materiales', 'mano_obra', 'equipos'];
        for (const type of resourceTypes) {
            if (currentItem[type].length !== editorBackup[type].length) return true;
            for (let i = 0; i < currentItem[type].length; i++) {
                const curr = currentItem[type][i];
                const backup = editorBackup[type][i];
                if (!curr || !backup) return true;
                if (curr.desc !== backup.desc ||
                    curr.unit !== backup.unit ||
                    curr.qty !== backup.qty ||
                    curr.price !== backup.price) {
                    return true;
                }
            }
        }
        
        return false;
    }

    function discardEditor() {
        if(!editorBackup) { closeEditor(); return; }
        if(confirm("¿Descartar cambios y salir?")) {
            if (isCreatingNew) {
                if(editorContext === 'project') {
                    appData.projectItems = appData.projectItems.filter(i => i.id !== currentEditId);
                } else {
                    appData.itemBank = appData.itemBank.filter(i => i.id !== currentEditId);
                }
            } else {
                if(editorContext === 'project') {
                    const idx = appData.projectItems.findIndex(i => i.id === currentEditId);
                    if(idx !== -1) appData.projectItems[idx] = editorBackup;
                } else {
                    const idx = appData.itemBank.findIndex(i => i.id === currentEditId);
                    if(idx !== -1) appData.itemBank[idx] = editorBackup;
                }
            }
            saveData();
            closeEditor();
        }
    }

    function closeEditor() {
        if(editorContext === 'project') { 
            renderB1(); 
            switchTab('b1'); 
        } else { 
            renderBankList(); 
            switchTab('items'); 
        }
        editorContext = null;
        currentEditId = null;
        editorBackup = null;
        isCreatingNew = false;
        editorNavigationIndex = -1;
    }

    // --- GESTIÓN DE BD INSUMOS (VERSIÓN CORREGIDA CON IDs) ---
    
    function toggleDbSort(type, field) {
        if (dbSortState[type].field === field) {
            dbSortState[type].dir *= -1;
        } else {
            dbSortState[type].field = field;
            dbSortState[type].dir = 1;
        }
        renderDBTables();
    }

    function renderDBTables() {
        const dbSections = [
            { type: 'materiales', pageKey: 'db-mat', tableId: 'db-table-materiales', paginationId: 'db-mat-pagination', pageInfoId: 'db-mat-page-info' },
            { type: 'mano_obra', pageKey: 'db-mo', tableId: 'db-table-mano_obra', paginationId: 'db-mo-pagination', pageInfoId: 'db-mo-page-info' },
            { type: 'equipos', pageKey: 'db-eq', tableId: 'db-table-equipos', paginationId: 'db-eq-pagination', pageInfoId: 'db-eq-page-info' }
        ];

        dbSections.forEach(section => {
            const { type, pageKey, tableId, paginationId, pageInfoId } = section;
            const sortState = dbSortState[type];
            
            // Ordenar
            appData.database[type].sort((a, b) => {
                let valA = a[sortState.field];
                let valB = b[sortState.field];
                
                if (sortState.field === 'code') {
                    const numA = parseFloat(valA);
                    const numB = parseFloat(valB);
                    if(!isNaN(numA) && !isNaN(numB)) return (numA - numB) * sortState.dir;
                }
                
                valA = valA ? valA.toString().toLowerCase() : "";
                valB = valB ? valB.toString().toLowerCase() : "";
                
                if(sortState.field === 'desc') {
                    if (valA === "" && valB !== "") return -1;
                    if (valA !== "" && valB === "") return 1;
                }

                if (valA < valB) return -1 * sortState.dir;
                if (valA > valB) return 1 * sortState.dir;
                return 0;
            });

            // Renumerar visualmente (código 1, 2, 3...)
            appData.database[type].forEach((item, index) => {
                item.code = (index + 1).toString();
            });

            // Paginación
            const totalItems = appData.database[type].length;
            const start = (currentPage[pageKey] - 1) * itemsPerPage;
            const end = Math.min(start + itemsPerPage, totalItems);
            const itemsToRender = appData.database[type].slice(start, end);

            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            
            const fragment = document.createDocumentFragment();

            itemsToRender.forEach((item) => {
                const tr = document.createElement('tr');
                // CAMBIO AQUI: Usamos fmt(item.price, 'price') en el value del input
                tr.innerHTML = `
                    <td class="text-center"><input type="text" value="${item.code}" readonly title="Número de Fila (Auto)"></td>
                    <td><textarea class="db-desc-input" onkeydown="handleDescEnter(event, this)" onchange="updateDbItem('${type}', ${item.id}, 'desc', this.value)" placeholder="Descripción">${escapeHtml(item.desc)}</textarea></td>
                    <td><input type="text" value="${escapeHtml(item.unit)}" onchange="updateDbItem('${type}', ${item.id}, 'unit', this.value)" placeholder="u"></td>
                    <td><input type="text" inputmode="decimal" value="${fmt(item.price, 'price')}" onchange="updateDbItem('${type}', ${item.id}, 'price', handleMathInput(this, 'price'))" onfocus="this.select()" style="text-align:right;"></td>
                    <td class="text-center"><button class="btn btn-danger btn-sm" onclick="deleteDbItem('${type}', ${item.id})" title="Eliminar"><i class="fas fa-trash"></i></button></td>`;
                fragment.appendChild(tr);
            });
            
            tbody.appendChild(fragment);
            
            // Info Paginación
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationDiv = document.getElementById(paginationId);
            const pageInfo = document.getElementById(pageInfoId);
            
            if (totalPages > 1) {
                paginationDiv.style.display = 'flex';
                pageInfo.textContent = `Página ${currentPage[pageKey]} de ${totalPages} (${totalItems} items)`;
            } else {
                paginationDiv.style.display = 'none';
            }
            
            // Íconos Sort
            const table = document.getElementById(tableId);
            table.querySelectorAll('.sort-icon').forEach(i => i.className = 'fas fa-sort sort-icon'); 
            const activeHeader = table.querySelector(`.col-${sortState.field} .sort-icon`);
            if(activeHeader) {
                activeHeader.className = sortState.dir === 1 ? 'fas fa-sort-down sort-icon' : 'fas fa-sort-up sort-icon';
            }
        });
    }

    function handleDescEnter(event, textarea) {
        if (event.key === 'Enter') {
            event.preventDefault();
            const row = textarea.closest('tr');
            const unitInput = row.querySelector('td:nth-child(3) input');
            if (unitInput) { unitInput.focus(); unitInput.select(); }
        }
    }

    // ACTUALIZAR POR ID
    function updateDbItem(type, id, field, value) {
        // Buscamos el objeto que tenga este ID exacto
        const item = appData.database[type].find(i => i.id === id);
        if (item) {
            if(field === 'price') value = parseNumber(value);
            item[field] = value;
            saveData();
        } else {
            console.error("No se encontró el item con ID:", id);
        }
    }

    // ELIMINAR POR ID
    function deleteDbItem(type, id) {
        if(confirm("¿Borrar este insumo de la base de datos?")) {
            // Filtramos excluyendo el ID que queremos borrar
            appData.database[type] = appData.database[type].filter(i => i.id !== id);
            saveData();
            renderDBTables();
        }
    }

    function addDbRow(type) {
        // Generar nuevo ID único
        const newId = Date.now() + Math.floor(Math.random() * 100000);
        
        appData.database[type].push({
            id: newId, 
            code: "0", 
            desc: "", 
            unit: "u", 
            price: 0
        });
        saveData();
        renderDBTables();

        // Auto-focus al nuevo elemento
        setTimeout(() => {
            const inputs = document.querySelectorAll(`#db-table-${type} textarea`);
            // Buscamos inputs vacíos, probablemente el último creado
            for(let i=inputs.length-1; i>=0; i--) {
                if(inputs[i].value === "" && inputs[i].classList.contains('db-desc-input')) {
                    inputs[i].focus();
                    break;
                }
            }
        }, 100);
    }
    
    // --- LÓGICA DE UNIFICACIÓN DE DUPLICADOS ---
    function cleanAndMergeDuplicates() {
        if(!confirm("Esta acción buscará insumos con exactamente la misma Descripción y Unidad, y los fusionará manteniendo el PRECIO MÁS ALTO encontrado. ¿Continuar?")) return;

        const types = ['materiales', 'mano_obra', 'equipos'];
        let totalRemoved = 0;

        types.forEach(type => {
            const originalList = appData.database[type];
            // Usamos un Map para detectar duplicados únicos por "descripción|unidad"
            const map = new Map();
            let duplicatesInType = 0;

            originalList.forEach(item => {
                // Normalizamos la clave: minúsculas y sin espacios extra
                const key = (item.desc || "").trim().toLowerCase() + "||" + (item.unit || "").trim().toLowerCase();

                if (!key || key === "||") return; // Ignorar filas vacías

                if (map.has(key)) {
                    // Ya existe: Es un duplicado
                    const existing = map.get(key);
                    // Lógica de actualización: Conservamos el precio MAYOR para no perder valor
                    if (parseNumber(item.price) > parseNumber(existing.price)) {
                        existing.price = parseNumber(item.price);
                    }
                    duplicatesInType++;
                } else {
                    // Nuevo insumo único
                    // Guardamos una copia para no alterar referencias si fuera necesario
                    map.set(key, { ...item }); 
                }
            });

            // Reconstruimos el array solo con los valores únicos del mapa
            if (duplicatesInType > 0) {
                appData.database[type] = Array.from(map.values());
                totalRemoved += duplicatesInType;
            }
        });

        if (totalRemoved > 0) {
            saveData();
            renderDBTables();
            showToast(`Se fusionaron ${totalRemoved} duplicados correctamente.`);
        } else {
            showToast("No se encontraron duplicados.");
        }
    }

    // --- MODALES Y LÓGICA DE AGREGADO CON DUPLICADOS ---
    let modalTargetType = '';

    // --- FUNCIÓN DE CREACIÓN RÁPIDA EN EDITOR ---
    function quickCreateResource(type) {
        // 1. Pedir datos básicos
        const desc = prompt("Descripción del nuevo insumo:", "");
        if (desc === null || desc.trim() === "") return; // Cancelado
        
        const unit = prompt("Unidad (ej: m3, pza, hr):", "u");
        if (unit === null) return;

        const priceStr = prompt("Precio Unitario referencial:", "0");
        if (priceStr === null) return;
        const price = parseNumber(priceStr);

        // 2. Crear objeto para la Base de Datos (con ID)
        const newId = Date.now() + Math.floor(Math.random() * 100000);
        const dbItem = {
            id: newId,
            code: (appData.database[type].length + 1).toString(), // Código auto-incremental simple
            desc: desc.trim(),
            unit: unit.trim(),
            price: price
        };

        // 3. Guardar en Base de Datos Global
        appData.database[type].push(dbItem);

        // 4. Crear objeto para el APU actual
        const apuItem = {
            id: Date.now() + Math.floor(Math.random() * 100000) + 1, // ID único para el recurso en el APU
            desc: desc.trim(),
            unit: unit.trim(),
            price: price,
            qty: 1 // Cantidad por defecto
        };

        // 5. Identificar APU actual y agregarlo
        let targetItem = (editorContext === 'project') ? 
            appData.projectItems.find(i => i.id === currentEditId) : 
            appData.itemBank.find(i => i.id === currentEditId);

        if (targetItem) {
            // Determinar array destino (DIRECTO, ya no necesitamos traducción compleja)
            // Si el argumento 'type' ya viene como 'materiales', 'mano_obra', etc.
            // podemos acceder directamente: targetItem[type]
            
            // Pero por seguridad mantengamos la asignación explicita:
            let targetArray;
            if (type === 'materiales') targetArray = targetItem.materiales;
            else if (type === 'mano_obra') targetArray = targetItem.mano_obra;
            else targetArray = targetItem.equipos;
            
            if(!targetArray) { 
                // Fallback por si acaso
                if(type === 'materiales') targetItem.materiales = [];
                if(type === 'mano_obra') targetItem.mano_obra = [];
                targetArray = targetItem[type];
            }

            targetArray.push(apuItem);
            
            // 6. Actualizar Interfaz... (Sigue igual)
            renderAPUTables(targetItem);
            saveData();
            showToast("Insumo creado y agregado");
            
            // Enfocar el input de cantidad del nuevo item (el último de la tabla)
            setTimeout(() => {
                let tableId = (type === 'materiales') ? 'table-mat' : (type === 'mano_obra') ? 'table-mo' : 'table-eq';
                let rows = document.querySelectorAll(`#${tableId} tbody tr`);
                if(rows.length > 0) {
                    let lastRow = rows[rows.length - 1];
                    let qtyInput = lastRow.querySelector('td:nth-child(3) input'); // Input de rendimiento
                    if(qtyInput) { qtyInput.focus(); qtyInput.select(); }
                }
            }, 100);
        }
    }
    
    function openResourceModal(type) {
        modalTargetType = type;
        document.getElementById('resourceModal').style.display = 'block';
        document.getElementById('modal-search').value = '';
        filterModalList();
        document.getElementById('modal-search').focus();
    }
    
    // Función auxiliar para intentar agregar un recurso
    function tryAddResource(newItem) {
        let tItem = (editorContext === 'project') ? 
            appData.projectItems.find(i => i.id === currentEditId) : 
            appData.itemBank.find(i => i.id === currentEditId);
        
        if(!tItem) return;
        
        // Determinar el array destino
        let targetArray = (modalTargetType==='materiales') ? tItem.materiales :
                         (modalTargetType==='mano_obra') ? tItem.mano_obra :
                         tItem.equipos;
        
        // Verificar duplicados (por nombre exacto)
        const duplicateIndex = targetArray.findIndex(r => r.desc.toLowerCase() === newItem.desc.toLowerCase());
        
        if (duplicateIndex >= 0) {
            // Se encontró duplicado - Abrir Modal de Conflicto
            conflictData = {
                tItem: tItem,
                targetArray: targetArray,
                newItem: newItem,
                existingIndex: duplicateIndex
            };
            
            document.getElementById('conflict-msg').innerHTML = 
                `El insumo <b>"${newItem.desc}"</b> ya existe en este APU.<br><br>¿Qué deseas hacer?`;
            
            // Ocultar modal de búsqueda temporalmente
            document.getElementById('resourceModal').style.display = 'none';
            document.getElementById('conflictModal').style.display = 'block';
        } else {
            // No hay duplicado, agregar directamente
            targetArray.push(newItem);
            finishAddResource(tItem);
        }
    }

    // Función para resolver el conflicto desde el modal
    function resolveConflict(action) {
        if (!conflictData) return;
        
        const { tItem, targetArray, newItem, existingIndex } = conflictData;
        
        if (action === 'replace') {
            // Reemplazar: Actualizar precio y unidad, mantener cantidad existente
            targetArray[existingIndex].price = newItem.price;
            targetArray[existingIndex].unit = newItem.unit;
            showToast('Insumo actualizado');
            finishAddResource(tItem);
        } else {
            // Descartar
            showToast('Operación cancelada');
            // Re-abrir el modal de búsqueda original
            document.getElementById('conflictModal').style.display = 'none';
            document.getElementById('resourceModal').style.display = 'block';
            return;
        }
        
        document.getElementById('conflictModal').style.display = 'none';
    }

    function finishAddResource(tItem) {
        renderAPUTables(tItem);
        saveData();
        // Cerrar modales
        document.getElementById('conflictModal').style.display = 'none';
        document.getElementById('resourceModal').style.display = 'none';
    }
    
    // Búsqueda optimizada con límite de resultados
    function filterModalList() {
        const txt = document.getElementById('modal-search').value.toLowerCase();
        const tbody = document.getElementById('modal-list-body');
        tbody.innerHTML = '';
        
        let list = [...appData.database[modalTargetType]].sort((a,b) => a.desc.localeCompare(b.desc));
        
        let count = 0;
        const maxResults = 50; // Límite para mejor rendimiento

        // Usar bucle for para poder break cuando lleguemos al límite
        for (let i = 0; i < list.length; i++) {
            if (count >= maxResults) break;
            
            const item = list[i];
            if(item.desc.toLowerCase().includes(txt) || (item.code && item.code.toString().toLowerCase().includes(txt))) {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="text-center" style="font-weight:600;">${item.code||''}</td>
                    <td>${item.desc}</td>
                    <td class="text-center">${item.unit}</td>
                    <td class="text-right" style="font-weight:600;">${fmt(item.price, 'price')}</td>
                    <td class="text-center"><button class="btn btn-primary btn-sm" title="Añadir"><i class="fas fa-plus"></i></button></td>`;
                
                tr.onclick = function() {
                    const newItem = { 
                        desc: item.desc, 
                        unit: item.unit, 
                        price: item.price, 
                        qty: 1 
                    };
                    tryAddResource(newItem);
                };
                tbody.appendChild(tr);
                count++;
            }
        }
        
        if (count === 0 && txt) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="5" class="text-center" style="padding: 20px; color: #718096;">
                        <i class="fas fa-search"></i> No se encontraron resultados para "${txt}"
                    </td>
                </tr>
            `;
        }
    }

    // --- FUNCIONES PARA MODAL BANCO CON MULTI-SELECCIÓN ---
    function openItemBankModalForSelect() {
        selectedBankIds.clear(); // <--- AGREGAR ESTO: Limpiar selección previa
        document.getElementById('bankModal').style.display = 'block';
        document.getElementById('bank-search').value = ''; // Limpiar búsqueda visual
        document.getElementById('bank-search').focus();
        filterBankModal();
    }
    
    // Búsqueda optimizada para banco con multi-selección
    function filterBankModal() {
        const txt = document.getElementById('bank-search').value.toLowerCase();
        const tbody = document.getElementById('bank-modal-body');
        const bulkBtn = document.getElementById('btn-bulk-add');
        tbody.innerHTML = '';
        
        // Checkbox maestro desactivado al filtrar
        document.getElementById('bank-select-all').checked = false;

        let count = 0;
        const maxResults = 50; 
        
        for (let i = 0; i < appData.itemBank.length; i++) {
            if (count >= maxResults) break;
            const item = appData.itemBank[i];
            
            if(item.description.toLowerCase().includes(txt) || item.code.toString().includes(txt)) {
                // VERIFICACIÓN DE PERSISTENCIA: ¿Está este ID ya seleccionado?
                const isChecked = selectedBankIds.has(item.id) ? 'checked' : '';

                const tr = document.createElement('tr');
                // Nota el cambio en el onchange del checkbox
                tr.innerHTML = `
                    <td class="text-center">
                        <input type="checkbox" class="bank-item-cb" 
                               ${isChecked} 
                               onchange="toggleBankSelection(${item.id}, this.checked)">
                    </td>
                    <td class="text-center" style="font-weight:600;">${item.code}</td>
                    <td>${item.description}</td>
                    <td class="text-center">${item.unit}</td>
                    <td class="text-center">
                        <button class="btn btn-primary btn-sm" onclick="addSingleItemToProject(${item.id})">
                            <i class="fas fa-plus"></i>
                        </button>
                    </td>`;
                tbody.appendChild(tr);
                count++;
            }
        }
        
        // Mostrar botón si hay algo seleccionado en el SET (no solo en pantalla)
        updateBulkCounter();
    }

    // NUEVAS FUNCIONES DE APOYO (para multi-selección)
    function toggleBankSelection(id, isChecked) {
        if (isChecked) {
            selectedBankIds.add(id);
        } else {
            selectedBankIds.delete(id);
        }
        updateBulkCounter();
    }

    function toggleSelectAllBank(master) {
        const visibleCheckboxes = document.querySelectorAll('.bank-item-cb');
        const isChecked = master.checked;

        visibleCheckboxes.forEach(cb => {
            cb.checked = isChecked;
            // Truco para obtener el ID sin volver a renderizar:
            const id = parseInt(cb.getAttribute('onchange').match(/\d+/)[0]);
            
            if (isChecked) {
                selectedBankIds.add(id);
            } else {
                selectedBankIds.delete(id);
            }
        });
        updateBulkCounter();
    }

    function updateBulkCounter() {
        // Contamos desde la memoria (Set), no desde el DOM
        const selectedCount = selectedBankIds.size;
        
        const btn = document.getElementById('btn-bulk-add');
        const countSpan = document.getElementById('selected-count');
        
        if(countSpan) countSpan.innerText = selectedCount;
        // Mostrar botón si hay al menos 1 seleccionado en total
        if(btn) btn.style.display = selectedCount > 0 ? 'inline-flex' : 'none';
    }

    function addSingleItemToProject(id) {
        const item = appData.itemBank.find(i => i.id === id);
        if(item) {
            let newItem = JSON.parse(JSON.stringify(item));
            newItem.id = Date.now() + Math.floor(Math.random() * 1000);
            newItem.quantity = 1;
            newItem.moduleId = appData.activeModuleId;
            appData.projectItems.push(newItem);
            saveData();
            renderB1();
            showToast('Ítem agregado');
        }
    }

    function addSelectedBankItems() {
        if (selectedBankIds.size === 0) return;

        let addedCount = 0;

        // Iteramos sobre los IDs guardados en memoria
        selectedBankIds.forEach(id => {
            const item = appData.itemBank.find(i => i.id === id);
            if(item) {
                let newItem = JSON.parse(JSON.stringify(item));
                newItem.id = Date.now() + Math.floor(Math.random() * 10000) + addedCount; 
                newItem.quantity = 1;
                newItem.moduleId = appData.activeModuleId;
                appData.projectItems.push(newItem);
                addedCount++;
            }
        });

        saveData();
        renderB1();
        closeBankModal(); // Esto también limpiará la selección gracias al Paso 6
        showToast(`${addedCount} ítems agregados con éxito`);
    }

    function closeBankModal() { 
        document.getElementById('bankModal').style.display='none'; 
    }
    
    function closeResourceModal() { 
        document.getElementById('resourceModal').style.display='none'; 
    }

    // --- FUNCIONES DE CONFIGURACIÓN ---
    function openConfigModal() {
        loadSettingsToUI();
        document.getElementById('configModal').style.display = 'block';
    }

    function closeConfigModal() {
        document.getElementById('configModal').style.display = 'none';
    }

    function loadSettingsToUI() {
        document.getElementById('conf-dec-yield').value = appData.settings.decimals_yield || 5;
        document.getElementById('conf-dec-price').value = appData.settings.decimals_price || 3;
        document.getElementById('conf-dec-partial').value = appData.settings.decimals_partial || 4;
        document.getElementById('conf-dec-total').value = appData.settings.decimals_total || 2;
        document.getElementById('conf-dec-qty').value = appData.settings.decimals_qty || 2;

        document.getElementById('conf-social').value = appData.settings.social;
        document.getElementById('conf-iva-mo').value = appData.settings.iva_mo;
        document.getElementById('conf-tools').value = appData.settings.tools;
        document.getElementById('conf-gg').value = appData.settings.gg;
        document.getElementById('conf-util').value = appData.settings.util;
        document.getElementById('conf-it').value = appData.settings.it;
        
        if(appData.settings.numberFormat) 
            document.getElementById('conf-format').value = appData.settings.numberFormat;
            
        // Actualizar indicador de precisión
        updatePrecisionIndicator();
    }

    function saveSettings() {
        appData.settings.decimals_yield = parseInt(document.getElementById('conf-dec-yield').value) || 5;
        appData.settings.decimals_price = parseInt(document.getElementById('conf-dec-price').value) || 3;
        appData.settings.decimals_partial = parseInt(document.getElementById('conf-dec-partial').value) || 4;
        appData.settings.decimals_total = parseInt(document.getElementById('conf-dec-total').value) || 2;
        appData.settings.decimals_qty = parseInt(document.getElementById('conf-dec-qty').value) || 2;

        appData.settings.social = parseFloat(document.getElementById('conf-social').value) || 0;
        appData.settings.iva_mo = parseFloat(document.getElementById('conf-iva-mo').value) || 0;
        appData.settings.tools = parseFloat(document.getElementById('conf-tools').value) || 0;
        appData.settings.gg = parseFloat(document.getElementById('conf-gg').value) || 0;
        appData.settings.util = parseFloat(document.getElementById('conf-util').value) || 0;
        appData.settings.it = parseFloat(document.getElementById('conf-it').value) || 0;
        appData.settings.numberFormat = document.getElementById('conf-format').value;

        saveData(); 
        updatePrecisionIndicator();
        
        // ACTUALIZAR TODAS LAS VISTAS (no solo la activa)
        renderB1();           // Presupuesto
        renderBankList();     // Banco
        renderDBTables();     // Insumos
        renderInsumosTable(); // Tabla de insumos
        recalcCalcTable();    // Calculadora
        
        // Si hay un item en el editor, actualizarlo también
        if(currentEditId) {
            let item = (editorContext === 'project') ? 
                appData.projectItems.find(i => i.id === currentEditId) : 
                appData.itemBank.find(i => i.id === currentEditId);
            if(item) renderAPUTables(item);
        }
        
        showToast('Formato numérico actualizado en todas las pestañas');
    }

    // --- ARCHIVOS RUPE ---
    async function exportB1ToExcel() {
        // 1. Verificar librería ZIP
        if (typeof JSZip === 'undefined') {
            showToast("Error: Librería JSZip no cargada.");
            return;
        }

        const pName = document.getElementById('reportProjectName')?.value || "PROYECTO";
        const zip = new JSZip();
        
        showToast("Generando archivos con 5 decimales...");

        // --- HELPER DE REDONDEO ESTRICTO (5 DECIMALES) ---
        const n = (num) => {
            if (num === null || num === undefined || isNaN(num)) return 0;
            // Redondea matemáticamente a 5 decimales y devuelve número
            return parseFloat(Number(num).toFixed(5));
        };

        // --- ESTILOS ---
        const borderStyle = {
            top: { style: 'thin' }, left: { style: 'thin' }, bottom: { style: 'thin' }, right: { style: 'thin' }
        };

        const styleHeader = {
            font: { bold: true, color: { argb: 'FFFFFFFF' } },
            fill: { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2D3748' } },
            alignment: { horizontal: 'center', vertical: 'middle' },
            border: borderStyle
        };

        const styleCell = {
            border: borderStyle,
            alignment: { vertical: 'middle' }
        };
        
        const styleItemFill = {
            type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF0F4F8' }
        };

        // --- HELPER PARA OBTENER INSUMOS GLOBALES
        const getProjectInsumos = (type) => {
            const map = new Map();
            
            appData.projectItems.forEach(item => {
                // CORRECCIÓN: Usamos las claves en español para coincidir con tu DB
                // y agregamos '|| []' para evitar errores si el array es null o undefined
                let resources = [];
                
                if (type === 'mat') {
                    resources = item.materiales || [];
                } else if (type === 'mo') {
                    resources = item.mano_obra || [];
                } else {
                    resources = item.equipos || [];
                }

                resources.forEach(r => {
                    // Normalizamos la descripción para agrupar (evitar duplicados por mayúsculas/espacios)
                    const key = r.desc.trim().toUpperCase();
                    
                    if (map.has(key)) {
                        const existing = map.get(key);
                        existing.qty += (r.qty * item.quantity); // Cantidad unitaria * Cantidad del ítem en proyecto
                        existing.totalPrice += (r.qty * r.price * item.quantity);
                    } else {
                        map.set(key, {
                            desc: r.desc,
                            unit: r.unit,
                            price: r.price, // Asumimos precio promedio o el último encontrado
                            qty: r.qty * item.quantity,
                            totalPrice: r.qty * r.price * item.quantity
                        });
                    }
                });
            });
            
            return Array.from(map.values());
        };

        // 1. GENERAR ARCHIVOS B3 (MATERIALES, MO, EQUIPO)
        const specs = [
            { type: 'mat', name: 'B3-MATERIALES.xlsx', sheet: 'B3-MATERIALES', title: 'MATERIALES' },
            { type: 'mo', name: 'B3-MANO_DE_OBRA.xlsx', sheet: 'Hoja1', title: 'MANO DE OBRA' },
            { type: 'eq', name: 'B3-MAQUINARIA_Y_EQUIPO.xlsx', sheet: 'Hoja1', title: 'EQUIPO, MAQUINARIA Y HERRAMIENTAS' }
        ];

        for (const spec of specs) {
            const wb = new ExcelJS.Workbook();
            const ws = wb.addWorksheet(spec.sheet);

            ws.addRow(["", spec.title, "", ""]);
            ws.mergeCells('B1:D1');
            ws.getCell('B1').font = { bold: true, size: 12 };

            const hRow = ws.addRow(["Nº", "DESCRIPCIÓN", "UNIDAD", "PRECIO UNITARIO"]);
            for(let i=1; i<=4; i++) hRow.getCell(i).style = styleHeader;

            ws.getColumn(1).width = 5; ws.getColumn(2).width = 50;
            ws.getColumn(3).width = 15; ws.getColumn(4).width = 20;

            const data = getProjectInsumos(spec.type);

            // ORDENAR ALFABÉTICAMENTE POR DESCRIPCIÓN
            const dataOrdenada = [...data].sort((a, b) => 
                a.desc.localeCompare(b.desc, 'es', { sensitivity: 'base' })
            );

            dataOrdenada.forEach((ins, i) => {
                // Forzamos n() en el precio
                const row = ws.addRow([i + 1, ins.desc, ins.unit, n(ins.price)]);
                row.eachCell(c => Object.assign(c, styleCell));
                
                // Forzamos formato visual '0.00000' en la columna de precio (4)
                row.getCell(4).numFmt = '0.00000';
            });

            const starRow = ws.addRow(["*", "", "", ""]);
            for(let i=1; i<=4; i++) starRow.getCell(i).border = borderStyle;

            const buffer = await wb.xlsx.writeBuffer();
            zip.file(spec.name, buffer);
        }

        // ================================================================
        // 2. GENERAR FORM_CANTIDADES.xlsx
        // ================================================================
        const wbForm = new ExcelJS.Workbook();
        const forms = [
            { sheet: 'PPTO. MATERIALES', title: 'MATERIALES-INSUMOS', key: 'materiales' },
            { sheet: 'PPTO. MANO DE OBRA', title: 'MANO DE OBRA-INSUMOS', key: 'mano_obra' },
            { sheet: 'PPTO. MAQUINARIA Y EQUIPO', title: 'EQUIPO, MAQUINARIA Y HERRAMIENTAS-INSUMOS', key: 'equipos' }
        ];

        forms.forEach(f => {
            const ws = wbForm.addWorksheet(f.sheet);
            ws.addRow(["", f.title]);
            
            const hRow = ws.addRow(["Código", "Descripción", "Unidad", "Cantidad", "Precio Unitario", "Precio Total (Bs)"]);
            for(let i=1; i<=6; i++) hRow.getCell(i).style = styleHeader;

            ws.getColumn(1).width = 10; ws.getColumn(2).width = 45;
            ws.getColumn(3).width = 10; ws.getColumn(4).width = 15;
            ws.getColumn(5).width = 15; ws.getColumn(6).width = 18;

            appData.projectItems.forEach(item => {
                const code = item.projectCode ? `>${item.projectCode}` : `>${item.code || ''}`;
                const itemRow = ws.addRow([code, item.description, "", "", "", ""]);
                
                for(let c=1; c<=6; c++) {
                    const cell = itemRow.getCell(c);
                    cell.fill = styleItemFill;
                    cell.font = { bold: true };
                    cell.border = borderStyle;
                }

                // Cantidad del ítem principal a 5 decimales
                const itemQty = n(item.quantity);

                (item[f.key] || []).forEach((r, idx) => {
                    // CÁLCULOS MATEMÁTICOS ESTRICTOS
                    // 1. Cantidad Total = Rendimiento * Cantidad Item
                    const totalQty = n(r.qty * itemQty);
                    
                    // 2. Precio Unitario
                    const unitPrice = n(r.price);
                    
                    // 3. Precio Total = Cantidad Total (ya redondeada) * P.Unitario (ya redondeado)
                    const totalPrice = n(totalQty * unitPrice);

                    const row = ws.addRow([
                        idx + 1, 
                        r.desc, 
                        r.unit, 
                        totalQty, 
                        unitPrice, 
                        totalPrice
                    ]);
                    
                    row.eachCell(c => Object.assign(c, styleCell));

                    // APLICAR FORMATO VISUAL 0.00000 A LAS TRES COLUMNAS NUMÉRICAS
                    row.getCell(4).numFmt = '0.00000'; // Cantidad
                    row.getCell(5).numFmt = '0.00000'; // P. Unit
                    row.getCell(6).numFmt = '0.00000'; // Total
                });
            });

            const starRow = ws.addRow(["*", "", "", "", "", ""]);
            for(let c=1; c<=6; c++) starRow.getCell(c).border = borderStyle;
        });

        const bufferForm = await wbForm.xlsx.writeBuffer();
        zip.file("FORM_CANTIDADES.xlsx", bufferForm);

        // ================================================================
        // 3. DESCARGA
        // ================================================================
        showToast("Comprimiendo ZIP...");
        zip.generateAsync({type:"blob"}).then(function(content) {
            const dateStr = new Date().toISOString().slice(0,10);
            saveAs(content, `Reportes_SICOES_5DEC_${pName}_${dateStr}.zip`);
            showToast("Descarga lista");
        });
    }

    function exportProjectJSON() {
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData));
        const dl = document.createElement('a'); 
        dl.href = s;

        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const año = ahora.getFullYear();
        dl.download = `Proy_Save_${dia}${mes}${año}.json`;

        dl.click();
        showToast('Proyecto guardado');
    }

    // --- FUNCIONES NUEVAS DE GUARDADO ---
    function openSaveOptionsModal() {
        document.getElementById('saveOptionsModal').style.display = 'block';
    }

    function exportBudgetOnlyJSON() {
        const budgetData = {
            settings: appData.settings,
            modules: appData.modules,
            activeModuleId: appData.activeModuleId, // <--- ESTA LÍNEA FALTABA
            projectItems: appData.projectItems,
            // Dejamos vacíos el Banco y la BD Global
            database: { materiales: [], mano_obra: [], equipos: [] }, 
            itemBank: [] 
        };
        
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(budgetData));
        const dl = document.createElement('a'); 
        dl.href = s; 
        
        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const año = ahora.getFullYear();
        dl.download = `PG_${dia}${mes}${año}.json`;

        dl.click();
        showToast('Presupuesto exportado (sin BD)');
    }

    function loadProjectJSON(input) {
        const file = input.files[0];
        if (!file) return;

        // Validación del tipo de archivo para Android
        const fileName = file.name.toLowerCase();
        const isValidExtension = fileName.endsWith('.json');
        const isValidMimeType = file.type === 'application/json' || 
                            file.type === 'text/json' || 
                            file.type === 'text/plain' || 
                            file.type === '';

        // Si no cumple ni extensión ni tipo MIME válido, pero el usuario lo seleccionó
        // (Android a veces no envía el tipo MIME), permitirlo si tiene extensión .json
        if (!isValidExtension && !isValidMimeType) {
            showToast('Por favor, seleccione un archivo JSON válido.');
            input.value = '';
            return;
        }

        const reader = new FileReader();
        
        reader.onload = function(e) { 
            try { 
                const loadedData = JSON.parse(e.target.result);
                
                // Fusionar con cuidado para no perder estructura base si el archivo es antiguo
                appData = { ...appData, ...loadedData };
                
                // CORRECCIÓN: Asegurar que hay un módulo activo
                if (!appData.activeModuleId && appData.modules.length > 0) {
                    appData.activeModuleId = appData.modules[0].id;
                }

                // CORRECCIÓN: Asegurar que la base de datos no sea null (importante para guardado simple)
                if (!appData.database) {
                    appData.database = { materiales: [], mano_obra: [], equipos: [] };
                }

                saveData();
                renderB1(); 
                renderBankList(); 
                renderDBTables(); 
                loadSettingsToUI(); 
                
                // Forzar actualización de la pestaña visual
                switchTab('b1');
                
                showToast("Proyecto cargado correctamente"); 
            }
            catch(err) { 
                console.error(err);
                showToast("Error al leer el archivo JSON. Verifique que el archivo sea válido."); 
            }
            // Limpiar el input para permitir cargar el mismo archivo dos veces seguidas si se desea
            input.value = '';
        };
        
        reader.onerror = function() {
            showToast("Error al leer el archivo");
            input.value = '';
        };
        
        reader.readAsText(file);
    }

    function exportBankJSON() {
        const s = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(appData.itemBank));
        const dl = document.createElement('a'); 
        dl.href = s;

        const ahora = new Date();
        const dia = String(ahora.getDate()).padStart(2, '0');
        const mes = String(ahora.getMonth() + 1).padStart(2, '0');
        const año = ahora.getFullYear();
        dl.download = `BD_${dia}${mes}${año}.json`;

        dl.click();
        showToast('Banco exportado');
    }

    function importBankJSON(input) {
        const r = new FileReader();
        r.onload = function(e) {
            try { 
                let loaded = JSON.parse(e.target.result);
                if(Array.isArray(loaded)) {
                    let apuCount = 0;
                    let insumosCount = 0;

                    loaded.forEach((i, index) => { 
                        // 1. Agregar el APU al Banco
                        i.code = getNextBankCode(); 
                        // Usamos index para asegurar IDs únicos si el proceso es muy rápido
                        i.id = Date.now() + Math.floor(Math.random() * 1000) + index; 
                        appData.itemBank.push(i); 
                        apuCount++;

                        // 2. NUEVA LOGICA: Extraer insumos a la Base de Datos Global
                        
                        // Procesar Materiales
                        if (i.materiales && Array.isArray(i.materiales)) {
                            i.materiales.forEach(res => {
                                const result = syncImportedResourceToDB('materiales', res);
                                if (result === 'new') insumosCount++;
                            });
                        }

                        // Procesar Mano de Obra
                        if (i.mano_obra && Array.isArray(i.mano_obra)) {
                            i.mano_obra.forEach(res => {
                                const result = syncImportedResourceToDB('mano_obra', res);
                                if (result === 'new') insumosCount++;
                            });
                        }

                        // Procesar Equipos
                        if (i.equipos && Array.isArray(i.equipos)) {
                            i.equipos.forEach(res => {
                                const result = syncImportedResourceToDB('equipos', res);
                                if (result === 'new') insumosCount++;
                            });
                        }
                    });

                    saveData();
                    
                    // Actualizar ambas vistas
                    renderBankList(); 
                    renderDBTables(); // Importante: Actualiza visualmente la pestaña Insumos
                    
                    showToast(`Importado: ${apuCount} APUs y ${insumosCount} insumos nuevos`);
                }
            } catch(e) { 
                console.error(e);
                showToast("Error al leer el archivo JSON o formato incorrecto"); 
            }
            // Limpiar input para permitir recargar el mismo archivo
            input.value = '';
        };
        r.readAsText(input.files[0]);
    }
    
    function importDBFromExcel() {
        const f = document.getElementById('dbFile').files[0];
        const type = document.getElementById('dbImportType').value;
        if(!f) {
            showToast('Seleccione un archivo primero');
            return;
        }
        
        const r = new FileReader();
        r.onload = async function(e) {
            try {
                const buffer = e.target.result;
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(buffer);
                const worksheet = workbook.getWorksheet(1);
                
                // Convertir a array simple
                const json = sheetToDataArray(worksheet);
                let c=0;
                
                // Asumiendo que la fila 0 es cabecera, empezamos en 1
                for(let i=1; i<json.length; i++) {
                    let row = json[i];
                    // row[1] = Descripción, row[2] = Unidad, row[3] o [4] = Precio
                    if(row && row.length>=2 && row[1]) {
                        // Manejo seguro de valores ExcelJS
                        const desc = row[1] ? row[1].toString().trim() : "";
                        const unit = row[2] ? row[2].toString().trim() : "u";
                        let price = parseFloat(row[3]);
                        if(isNaN(price)) price = parseFloat(row[4]); // Intentar columna siguiente
                        if(isNaN(price)) price = 0;

                        appData.database[type].push({
                            id: Date.now() + Math.floor(Math.random() * 100000) + c,
                            code: "0", 
                            desc: desc, 
                            unit: unit, 
                            price: price
                        });
                        c++;
                    }
                }
                
                if(c > 0) {
                    saveData();
                    renderDBTables(); 
                    showToast(`Importados ${c} insumos`);
                } else {
                    showToast('No se encontraron datos válidos');
                }
                document.getElementById('dbFile').value = '';
            } catch(err) {
                console.error(err);
                showToast('Error al procesar el archivo');
            }
        };
        r.readAsArrayBuffer(f);
    }

    // --- ATAJOS DE TECLADO ---
    function setupEditModeShortcuts() {
        document.addEventListener('keydown', function(e) {
            // Solo procesar si estamos en modo edición
            if (!document.getElementById('panel-editor').classList.contains('active')) return;
            
            // Atajos globales para navegación
            if (e.ctrlKey) {
                switch(e.key) {
                    case 'ArrowLeft':
                        e.preventDefault();
                        navigateEditor(-1);
                        break;
                    case 'ArrowRight':
                        e.preventDefault();
                        navigateEditor(1);
                        break;
                    case 's':
                        e.preventDefault();
                        closeEditor();
                        break;
                    case 'Escape':
                        e.preventDefault();
                        discardEditor();
                        break;
                }
            }
            
            // Solo procesar atajos de campo si hay un campo activo
            if(!currentEditField) return;
            
            switch(e.key) {
                case 'Enter':
                    e.preventDefault();
                    // Guardar y pasar al siguiente campo
                    saveCurrentField();
                    moveToNextField();
                    break;
                case 'Escape':
                    e.preventDefault();
                    // Cancelar edición
                    cancelEdit();
                    break;
                case 'Tab':
                    e.preventDefault();
                    // Navegar entre campos
                    moveToNextField();
                    break;
                case 'ArrowUp':
                    e.preventDefault();
                    // Navegar a la fila anterior
                    navigateRows(-1);
                    break;
                case 'ArrowDown':
                    e.preventDefault();
                    // Navegar a la siguiente fila
                    navigateRows(1);
                    break;
            }
        });
        
        // Configurar eventos para campos editables
        document.addEventListener('focusin', function(e) {
            if (e.target.tagName === 'TEXTAREA' || e.target.tagName === 'INPUT') {
                const field = e.target;
                const row = field.closest('tr');
                const table = field.closest('table');
                
                if (table && table.id) {
                    currentEditField = field;
                    currentEditRow = row;
                    
                    // Determinar tipo de tabla
                    if (table.id === 'table-mat') currentEditType = 'materiales';
                    else if (table.id === 'table-mo') currentEditType = 'mano_obra';
                    else if (table.id === 'table-eq') currentEditType = 'equipos';
                    else currentEditType = null;
                    
                    // Seleccionar texto automáticamente
                    setTimeout(() => {
                        if (field.value && field.tagName === 'INPUT') {
                            field.select();
                        }
                    }, 10);
                }
            }
        });
        
        document.addEventListener('focusout', function(e) {
            currentEditField = null;
            currentEditRow = null;
            currentEditType = null;
        });
    }

    function saveCurrentField() {
        if (!currentEditField || !currentEditType) return;
        
        const field = currentEditField;
        const value = field.value;
        
        // Encontrar el índice de la fila
        const rows = Array.from(currentEditRow.parentElement.children);
        const rowIndex = rows.indexOf(currentEditRow);
        
        // Actualizar el dato en el modelo
        const item = (editorContext === 'project') ? 
            appData.projectItems.find(i => i.id === currentEditId) : 
            appData.itemBank.find(i => i.id === currentEditId);
        
        if (!item) return;
        
        // Determinar qué campo se está editando
        const cellIndex = Array.from(currentEditRow.children).indexOf(field.parentElement);
        
        // Mapear índice de celda a campo
        const fieldMap = {
            0: 'desc',
            1: 'unit',
            2: 'qty',
            3: 'price'
        };
        
        const fieldName = fieldMap[cellIndex];
        if (fieldName) {
            if (fieldName === 'qty' || fieldName === 'price') {
                // CAMBIO: Usamos el resolutor matemático en lugar de parseFloat directo
                // Esto asegura que "10*5" se convierta en 50 antes de guardarse al presionar Enter
                item[currentEditType][rowIndex][fieldName] = solveMathExpression(value);
            } else {
                item[currentEditType][rowIndex][fieldName] = value;
            }
            
            // Recalcular y actualizar la tabla
            renderAPUTables(item);
            saveData();
        }
    }

    function moveToNextField() {
        if (!currentEditField || !currentEditRow) return;
        
        const cells = Array.from(currentEditRow.children);
        const currentCell = currentEditField.parentElement;
        const currentIndex = cells.indexOf(currentCell);
        
        let nextCell;
        if (currentIndex < cells.length - 2) { // -2 para evitar la columna de acciones
            nextCell = cells[currentIndex + 1];
        } else {
            // Ir a la siguiente fila
            const rows = Array.from(currentEditRow.parentElement.children);
            const rowIndex = rows.indexOf(currentEditRow);
            if (rowIndex < rows.length - 1) {
                nextCell = rows[rowIndex + 1].children[0];
            } else {
                // Última fila, crear nueva
                addResourceToCurrentTable();
                setTimeout(() => {
                    const newRows = Array.from(currentEditRow.parentElement.children);
                    if (newRows.length > rows.length) {
                        const lastRow = newRows[newRows.length - 1];
                        const firstCell = lastRow.children[0];
                        const textarea = firstCell.querySelector('textarea');
                        if (textarea) {
                            textarea.focus();
                        }
                    }
                }, 50);
                return;
            }
        }
        
        if (nextCell) {
            const input = nextCell.querySelector('input, textarea');
            if (input) {
                input.focus();
                if (input.tagName === 'INPUT') {
                    input.select();
                }
            }
        }
    }

    function cancelEdit() {
        if (!currentEditField) return;
        
        currentEditField.blur();
        currentEditField = null;
        currentEditRow = null;
        currentEditType = null;
    }

    function navigateRows(direction) {
        if (!currentEditRow || !currentEditType) return;
        
        const rows = Array.from(currentEditRow.parentElement.children);
        const rowIndex = rows.indexOf(currentEditRow);
        const newIndex = rowIndex + direction;
        
        if (newIndex >= 0 && newIndex < rows.length) {
            const newRow = rows[newIndex];
            const currentCellIndex = Array.from(currentEditRow.children).indexOf(currentEditField.parentElement);
            const newCell = newRow.children[currentCellIndex];
            const input = newCell.querySelector('input, textarea');
            
            if (input) {
                input.focus();
                if (input.tagName === 'INPUT') {
                    input.select();
                }
            }
        }
    }

    function addResourceToCurrentTable() {
        if (!currentEditType) return;
        
        const item = (editorContext === 'project') ? 
            appData.projectItems.find(i => i.id === currentEditId) : 
            appData.itemBank.find(i => i.id === currentEditId);
        
        if (!item) return;
        
        item[currentEditType].push({ desc: "", unit: "u", qty: 1, price: 0 });
        renderAPUTables(item);
        saveData();
    }

    // --- LÓGICA DRAG & DROP ---

    // Función auxiliar para mover elementos en un array
    function arrayMove(arr, oldIndex, newIndex) {
        if (newIndex >= arr.length) {
            let k = newIndex - arr.length + 1;
            while (k--) {
                arr.push(undefined);
            }
        }
        arr.splice(newIndex, 0, arr.splice(oldIndex, 1)[0]);
        return arr;
    }

    // SOLUCIÓN B: Drag & Drop seguro con módulos
    function initSortableB1() {
        const el = document.getElementById('b1-body');
        if(!el) return;

        // Destruir instancia previa si existe para evitar duplicados al re-renderizar
        if(el._sortable) el._sortable.destroy();

        el._sortable = Sortable.create(el, {
            animation: 150,
            handle: 'tr', // Se puede arrastrar toda la fila
            filter: 'input, textarea, button, select, i', // Excepto al tocar inputs/botones
            preventOnFilter: false, // Permite usar los inputs
            ghostClass: 'sortable-ghost',
            delay: 200, // Solo para touch
            delayOnTouchOnly: true, // Solo aplicar delay en dispositivos táctiles
            onEnd: function (evt) {
                if (evt.oldIndex === evt.newIndex) return;

                // 1. Obtener todos los IDs del módulo actual en el ORDEN NUEVO visual
                // (Sortable ya movió el elemento en el DOM, así que leemos el DOM)
                const rows = Array.from(document.querySelectorAll('#b1-body tr'));
                const visibleIds = rows.map(r => parseFloat(r.getAttribute('data-id'))).filter(id => !isNaN(id));

                // 2. Crear un mapa del orden nuevo para acceso rápido
                const newOrderMap = new Map();
                visibleIds.forEach((id, index) => newOrderMap.set(id, index));

                // 3. Separar ítems: Los del módulo activo vs Los de otros módulos
                const activeModuleId = appData.activeModuleId;
                const otherModuleItems = appData.projectItems.filter(i => i.moduleId !== activeModuleId);
                let activeModuleItems = appData.projectItems.filter(i => i.moduleId === activeModuleId);

                // 4. Reordenar SOLO los ítems del módulo activo según el mapa visual
                activeModuleItems.sort((a, b) => {
                    const idxA = newOrderMap.has(a.id) ? newOrderMap.get(a.id) : -1;
                    const idxB = newOrderMap.has(b.id) ? newOrderMap.get(b.id) : -1;
                    
                    // Si por error de paginación algo no está visible, lo mandamos al final
                    if (idxA === -1) return 1; 
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });

                // 5. Reconstruir el array global
                // ESTRATEGIA SEGURA: Concatenar otros + activos reordenados
                appData.projectItems = [...otherModuleItems, ...activeModuleItems];

                saveData();
                
                // IMPORTANTE: Renumerar visualmente las filas (Columna "Nº") sin recargar toda la tabla
                rows.forEach((row, index) => {
                    // Asumiendo paginación, suma el offset
                    const offset = (currentPage.b1 - 1) * itemsPerPage;
                    row.cells[1].innerText = offset + index + 1;
                });
            }
        });
    }

    // Inicializar Sortable en las tablas del Editor
    function initSortableEditor(type) {
        // Mapeo de IDs de tablas y propiedades del objeto
        const config = {
            'materiales': { id: 'table-mat', prop: 'materiales' },
            'mano_obra':  { id: 'table-mo',  prop: 'mano_obra' },
            'equipos':    { id: 'table-eq',  prop: 'equipos' }
        };

        const conf = config[type];
        const table = document.getElementById(conf.id);
        if(!table) return;
        const el = table.querySelector('tbody');

        if(el._sortable) el._sortable.destroy();

        el._sortable = Sortable.create(el, {
            animation: 150,
            filter: 'input, textarea, button, select', 
            preventOnFilter: false,
            ghostClass: 'sortable-ghost',
            delay: 200,
            delayOnTouchOnly: true,
            onEnd: function (evt) {
                // Identificar el ítem actual que se está editando
                let item = (editorContext === 'project') 
                    ? appData.projectItems.find(i => i.id === currentEditId) 
                    : appData.itemBank.find(i => i.id === currentEditId);
                
                if(!item) return;

                // Reordenar el array específico (materiales, mano de obra o equipos)
                const movedRes = item[conf.prop].splice(evt.oldIndex, 1)[0];
                item[conf.prop].splice(evt.newIndex, 0, movedRes);

                saveData();
                // Re-renderizar tablas para actualizar los índices en los eventos onchange (importante)
                renderAPUTables(item);
            }
        });
    }

    // --- LÓGICA DE CALCULADORA ---
    let currentCalcItemData = null; // Almacena el ítem seleccionado temporalmente

    // 1. Modificar la función switchTab existente
    const originalSwitchTab = switchTab;
    switchTab = function(tabId) {
        document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        
        // Mapeo de IDs
        let pId = '';
        if (tabId === 'b1') pId = 'b1';
        else if (tabId === 'items') pId = 'items';
        else if (tabId === 'db') pId = 'db';
        else if (tabId === 'calc') pId = 'calc'; // Nuevo caso
        else pId = 'config';

        const targetPanel = document.getElementById('panel-' + pId);
        if(targetPanel) targetPanel.classList.add('active');
        
        // Activar clase visual en la pestaña
        const tabs = document.querySelectorAll('.tab');
        if(tabId === 'b1') tabs[0].classList.add('active');
        if(tabId === 'items') tabs[1].classList.add('active');
        if(tabId === 'db') tabs[2].classList.add('active');
        if(tabId === 'calc') tabs[3].classList.add('active'); // La nueva pestaña

        window.scrollTo(0, 0);
    };

    // 2. Buscador para la Calculadora (Busca en el Banco)
    function searchCalcItem() {
        const txt = document.getElementById('calc-search-input').value.toLowerCase();
        const resultsDiv = document.getElementById('calc-search-results');
        
        if (txt.length < 2) {
            resultsDiv.style.display = 'none';
            return;
        }

        resultsDiv.innerHTML = '';
        const matches = appData.itemBank.filter(i => 
            i.description.toLowerCase().includes(txt) || 
            i.code.toString().includes(txt)
        );

        if (matches.length === 0) {
            resultsDiv.innerHTML = '<div style="padding:10px; color:#718096;">No hay coincidencias en el Banco.</div>';
        } else {
            matches.forEach(item => {
                const div = document.createElement('div');
                div.style.cssText = 'padding:8px 10px; cursor:pointer; border-bottom:1px solid #f7fafc; hover:background:#f7fafc;';
                div.innerHTML = `<strong>${item.code}</strong> - ${item.description} <small>(${item.unit})</small>`;
                div.onmouseover = function() { this.style.backgroundColor = '#ebf8ff'; };
                div.onmouseout = function() { this.style.backgroundColor = 'white'; };
                div.onclick = function() {
                    selectItemForCalc(item);
                    resultsDiv.style.display = 'none';
                    document.getElementById('calc-search-input').value = '';
                };
                resultsDiv.appendChild(div);
            });
        }
        resultsDiv.style.display = 'block';
    }

    // 3. Seleccionar ítem y preparar datos
    function selectItemForCalc(item) {
        // Hacemos una copia profunda para no modificar el banco original al cambiar rendimientos en la calc
        currentCalcItemData = JSON.parse(JSON.stringify(item));
        
        document.getElementById('calc-selected-name').innerText = item.description;
        document.getElementById('calc-selected-unit').innerText = item.unit;
        
        recalcCalcTable();
    }

    // 4. Renderizar y Calcular con Factores Inteligentes (OPTIMIZADO)
    function recalcCalcTable() {
        const tbody = document.getElementById('calc-body');
        tbody.innerHTML = '';
        if (!currentCalcItemData) return;

        const inputQty = parseFloat(document.getElementById('calc-quantity').value) || 0;
        
        // Función auxiliar para renderizar filas usando la nueva precisión
        const createCalcRow = (res, type, index) => {
            const totalBase = res.qty * inputQty;
            const descLower = res.desc.toLowerCase();
            
            // Lógica de factores
            if (res.calcFactor === undefined) {
                if (type === 'materiales') { 
                    if (descLower.includes('cemento') || descLower.includes('yeso')) res.calcFactor = 50;
                    else res.calcFactor = 1; 
                } else if (type === 'mano_obra' || type === 'equipos') { 
                    res.calcFactor = 8; 
                } else {
                    res.calcFactor = 1;
                }
            }

            // Cálculo del valor final
            let finalValue = totalBase;
            let labelSuffix = "";
            let textColor = "#2b6cb0";

            if (res.calcFactor && parseFloat(res.calcFactor) !== 0) {
                finalValue = totalBase / res.calcFactor;
                
                if (parseFloat(res.calcFactor) !== 1) {
                    if (type === 'materiales') { 
                        if (descLower.includes('cemento') || descLower.includes('yeso')) {
                            labelSuffix = " Bolsas";
                            textColor = "#805ad5";
                        } else {
                            textColor = "#38a169";
                        }
                    } else if (type === 'mano_obra' || type === 'equipos') { 
                        labelSuffix = " Días";
                        textColor = "#dd6b20";
                    }
                }
            }

            // NOTA: Usamos getStep('yield') para el input de rendimiento
            // y fmt(finalValue, 'qty') para el resultado requerido
            return `
                <tr>
                    <td>${res.desc}</td>
                    <td class="text-center">${res.unit}</td>
                    <td>
                        <input type="text" inputmode="decimal" value="${fmt(res.qty, 'yield')}" 
                            onchange="updateCalcValue('${type}', ${index}, 'qty', handleMathInput(this, 'yield'))"
                            style="width:100%; text-align:center; border:1px dashed #cbd5e0; background:transparent;">
                    </td>
                    <td>
                        <input type="text" inputmode="decimal" value="${fmt(res.calcFactor, 'yield')}" 
                        onchange="updateCalcValue('${type}', ${index}, 'calcFactor', handleMathInput(this, 'yield'))"
                        onfocus="this.select()"
                        style="width:100%; text-align:center; border:1px solid #e2e8f0; font-weight:bold; color:var(--primary);">
                    </td>
                    <td class="text-right font-bold" style="color:${textColor}; font-size:1.05rem;">
                        ${fmt(finalValue, 'qty')}${labelSuffix}
                    </td>
                </tr>
            `;
        };

        let html = '';
        const sections = [
            {id:'materiales', l:'Materiales', i:'fa-box'}, 
            {id:'mano_obra', l:'Mano de Obra', i:'fa-users'}, 
            {id:'equipos', l:'Equipos', i:'fa-truck-monster'}
        ];

        sections.forEach(sec => {
            if (currentCalcItemData[sec.id] && currentCalcItemData[sec.id].length > 0) {
                html += `<tr style="background:#edf2f7;"><td colspan="5" style="font-weight:bold; font-size:0.85rem;"><i class="fas ${sec.i}"></i> ${sec.l}</td></tr>`;
                currentCalcItemData[sec.id].forEach((r, i) => html += createCalcRow(r, sec.id, i));
            }
        });
        tbody.innerHTML = html || `<tr><td colspan="5" class="text-center">No hay insumos.</td></tr>`;
    }

    // FUNCIÓN PARA IMPRIMIR REPORTE
    function printCalcReport() {
        if (!currentCalcItemData) return alert("Selecciona un ítem primero.");

        const printWindow = window.open('', '_blank');
        const qty = document.getElementById('calc-quantity').value;
        const date = new Date().toLocaleDateString();
        
        let tableRows = '';
        const rows = document.querySelectorAll('#calc-body tr');
        rows.forEach(row => {
            if (row.style.background.includes('rgb(237, 242, 247)')) {
                // Fila de encabezado de sección (Materiales, etc.)
                tableRows += `<tr><td colspan="4" style="background:#f1f5f9; font-weight:bold; padding:10px; border:1px solid #e2e8f0;">${row.innerText.toUpperCase()}</td></tr>`;
            } else {
                const cells = row.querySelectorAll('td');
                if(cells.length >= 5) {
                    const desc = cells[0].innerText;
                    const unit = cells[1].innerText;
                    const yieldVal = cells[2].querySelector('input').value;
                    const totalText = cells[4].innerText; // Captura el texto con "Bolsas" o "Días"
                    
                    tableRows += `
                        <tr>
                            <td style="padding:10px; border:1px solid #e2e8f0;">${desc}</td>
                            <td style="padding:10px; border:1px solid #e2e8f0; text-align:center;">${unit}</td>
                            <td style="padding:10px; border:1px solid #e2e8f0; text-align:center;">${yieldVal}</td>
                            <td style="padding:10px; border:1px solid #e2e8f0; text-align:right; font-weight:bold;">${totalText}</td>
                        </tr>`;
                }
            }
        });

        printWindow.document.write(`
            <html>
            <head>
                <title>Reporte de Insumos - PresuRE</title>
                <style>
                    body { font-family: 'Segoe UI', sans-serif; color: #1a202c; padding: 40px; }
                    .header { border-bottom: 3px solid #1a365d; margin-bottom: 30px; padding-bottom: 10px; }
                    table { width: 100%; border-collapse: collapse; margin-bottom: 30px; }
                    th { background: #1a365d; color: white; padding: 12px; text-align: left; text-transform: uppercase; font-size: 12px; }
                    .footer { text-align: center; font-size: 10px; color: #a0aec0; margin-top: 50px; border-top: 1px solid #e2e8f0; padding-top: 10px; }
                </style>
            </head>
            <body>
                <div class="header">
                    <h2 style="margin:0; color:#1a365d;">LISTA DE REQUERIMIENTO DE INSUMOS</h2>
                    <p style="margin:5px 0; font-size:14px;">Generado por PresuRE</p>
                </div>
                <div style="margin-bottom:20px; background:#f8fafc; padding:15px; border-radius:8px;">
                    <strong>ACTIVIDAD/ÍTEM:</strong> ${currentCalcItemData.description}<br>
                    <strong>CANTIDAD PROGRAMADA:</strong> ${qty} ${currentCalcItemData.unit}<br>
                    <strong>FECHA DE REPORTE:</strong> ${date}
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Descripción del Insumo</th>
                            <th style="text-align:center;">Unid. Base</th>
                            <th style="text-align:center;">Rend.</th>
                            <th style="text-align:right;">Total Calculado</th>
                        </tr>
                    </thead>
                    <tbody>${tableRows}</tbody>
                </table>
                <div class="footer">Este documento es una guía de cálculo para despacho de materiales en obra.</div>
            </body>
            </html>
        `);
        printWindow.document.close();
        // Esperar un poco para que carguen estilos si fuera necesario
        setTimeout(() => { printWindow.print(); }, 250);
    }

    // 5. Función genérica para actualizar cualquier valor en la fila
    function updateCalcValue(type, index, field, newVal) {
        if (!currentCalcItemData) return;
        currentCalcItemData[type][index][field] = parseFloat(newVal) || 0;
        recalcCalcTable();
    }
    
    // Cerrar resultados de búsqueda si clic fuera
    document.addEventListener('click', function(e) {
        const searchContainer = document.getElementById('calc-search-input').parentElement.parentElement;
        const results = document.getElementById('calc-search-results');
        if (!searchContainer.contains(e.target) && results) {
            results.style.display = 'none';
        }
    });
    
    // Agregar event listener para el input de comparación
    document.getElementById('comparisonInput')?.addEventListener('input', function() {
        updateDecimalComparison();
    });
    
    // Agregar event listener para la tecla Enter en el input de comparación
    document.getElementById('comparisonInput')?.addEventListener('keyup', function(e) {
        if (e.key === 'Enter') {
            updateDecimalComparison();
        }
    });

/* --- MÓDULO DE REPORTES SICOES (APU DETALLADO) --- */
let currentReportFormat = 'pdf';

function openReportModal() { 
    // Precargar nombre si existe un módulo activo o usar genérico
    const input = document.getElementById('reportProjectName');
    if(input && !input.value) input.value = "CONSTRUCCIÓN...";
    document.getElementById('reportModal').style.display = 'block'; 
}

function closeReportModal() { document.getElementById('reportModal').style.display = 'none'; }

function setReportFormat(format) {
    currentReportFormat = format;
    document.querySelectorAll('.format-option').forEach(el => el.classList.remove('active'));
    document.querySelector(`.format-option input[value="${format}"]`).parentElement.classList.add('active');
}

function generateSelectedReport(type) {
    // Obtener nombre del proyecto del input
    const pName = document.getElementById('reportProjectName').value || "PROYECTO SIN NOMBRE";
    
    showToast("Generando reporte...");
    setTimeout(() => {
        if (currentReportFormat === 'pdf') {
            generatePDFReportSICOES(type, pName);
        } else {
            generateExcelReportSICOES(type, pName);
        }
        closeReportModal();
    }, 200);
}

// ==========================================
//   MOTOR PDF SICOES (CON CÁLCULO COMPLETO)
function generatePDFReportSICOES(type, projectName) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const dateStr = new Date().toLocaleDateString();
    const f = (num, t) => formatNumber(num, t);
    const s = appData.settings; 

    // ESTILO GLOBAL DE TABLAS (Ajuste de altura de filas aquí)
    const tableStyles = {
        cellPadding: 1.5,     // Reducir padding para filas más compactas
        minCellHeight: 6,     // Altura mínima consistente
        fontSize: 8,          // Tamaño de letra legible
        valign: 'middle'      // Centrado vertical
    };

    const headerStyles = { 
        fillColor: [230, 230, 230], 
        textColor: 0, 
        fontStyle: 'bold', 
        lineWidth: 0.1, 
        lineColor: 150,
        halign: 'center'
    };

    // --- SUB: B-1 PRESUPUESTO ---
    const addPagePG = () => {
        doc.setFontSize(14); doc.setFont("helvetica", "bold");
        doc.text("FORMULARIO B-1", 105, 15, { align: "center" });
        doc.text("PRESUPUESTO GENERAL DE OBRA", 105, 22, { align: "center" });
        
        doc.setFontSize(9); doc.setFont("helvetica", "normal");
        doc.text(`PROYECTO: ${projectName}`, 14, 32);
        doc.text(`FECHA: ${dateStr}`, 195, 32, { align: "right" });

        const tableBody = [];
        let grandTotal = 0;
        let itemGlobalCounter = 1;

        appData.modules.forEach(mod => {
            tableBody.push([{ content: mod.name.toUpperCase(), colSpan: 6, styles: { fillColor: [245, 245, 245], fontStyle: 'bold' } }]);
            const modItems = appData.projectItems.filter(i => i.moduleId === mod.id);
            modItems.forEach(item => {
                // 1. Calcular P. Unitario base (crudo)
                const rawPu = calculateUnitPrice(item);
                
                // 2. Redondear Precio y Cantidad usando la configuración (IGUAL QUE EN TABLA VISUAL)
                const pu = roundToConfig(rawPu, 'total');
                const qty = roundToConfig(item.quantity, 'qty');
                
                // 3. Calcular el total de la línea con valores redondeados
                const total = pu * qty;
                
                // 4. Sumar al gran total
                grandTotal += total;

                // 5. Imprimir en PDF usando formato visual (f)
                // Nota: pasamos 'pu' y 'total' ya calculados, no recalculamos dentro del push
                tableBody.push([
                    itemGlobalCounter++, 
                    item.description, 
                    item.unit, 
                    f(qty, 'qty'),     // Mostrar cantidad redondeada
                    f(pu, 'total'),    // Mostrar precio redondeado
                    f(total, 'total')  // Mostrar total matemático exacto de lo anterior
                ]);
            });
        });

        tableBody.push([{ content: "TOTAL PRESUPUESTO", colSpan: 5, styles: { fontStyle: 'bold', halign: 'right' } }, { content: f(grandTotal, 'total'), styles: { fontStyle: 'bold' } }]);

        doc.autoTable({
            startY: 35,
            head: [['Nº', 'DESCRIPCIÓN', 'UND.', 'CANTIDAD', 'P. UNITARIO', 'TOTAL']],
            body: tableBody,
            theme: 'grid',
            headStyles: headerStyles,
            styles: tableStyles, // Aplicar estilos compactos
            columnStyles: { 0: { halign: 'left', cellWidth: 10 }, 2: { halign: 'center'}, 3: { halign: 'right' }, 4: { halign: 'right' }, 5: { halign: 'right' } }
        });
    };

    // --- SUB: B-2 APUS (CON DESGLOSE COMPLETO) ---
    const addPageAPUs = () => {
        const apuColumnStyles = {
            0: { cellWidth: 95 },  // Descripción
            1: { cellWidth: 15, halign: 'center' }, // Unidad
            2: { cellWidth: 22, halign: 'right' },  // Cantidad/Rendimiento
            3: { cellWidth: 25, halign: 'right' },  // Precio Unitario
            4: { cellWidth: 25, halign: 'right' }   // Subtotal
        };
        let itemCounter = 1;
        appData.modules.forEach(mod => {
            const modItems = appData.projectItems.filter(i => i.moduleId === mod.id);
            modItems.forEach(item => {
                doc.addPage();
                let y = 15;

                // Encabezado
                doc.setFontSize(12); doc.setFont("helvetica", "bold");
                doc.text("FORMULARIO B-2", 105, y, { align: "center" }); y += 6;
                doc.text("ANÁLISIS DE PRECIOS UNITARIOS", 105, y, { align: "center" }); y += 8;

                // Caja Datos
                doc.setDrawColor(0); doc.setFillColor(255, 255, 255); doc.rect(14, y, 182, 16);
                doc.setFontSize(9); doc.setFont("helvetica", "normal");
                doc.text(`PROYECTO: ${projectName}`, 16, y + 5);
                doc.text(`ÍTEM ${itemCounter++}: ${item.description}`, 16, y + 11);
                doc.text(`UNIDAD: ${item.unit}`, 140, y + 5);
                doc.text(`CANTIDAD: ${f(item.quantity, 'qty')}`, 140, y + 11);
                y += 20;

                // --- CÁLCULOS INTERNOS ---
                // Corrección: Usar || [] para evitar errores si el array no existe
                const matArr = item.materiales || [];
                const moArr = item.mano_obra || [];
                const eqArr = item.equipos || [];

                const sumMat = matArr.reduce((a,b)=>a+(b.qty*b.price),0);
                const sumMo = moArr.reduce((a,b)=>a+(b.qty*b.price),0);

                const valSoc = sumMo * (s.social/100);
                const valIvaMo = (sumMo + valSoc) * (s.iva_mo/100);
                const totalMo = sumMo + valSoc + valIvaMo;

                const sumEq = eqArr.reduce((a,b)=>a+(b.qty*b.price),0);
                const valTools = totalMo * (s.tools/100);
                const totalEq = sumEq + valTools;

                const costoDirecto = sumMat + totalMo + totalEq;
                const valGG = costoDirecto * (s.gg/100);
                const valUtil = (costoDirecto + valGG) * (s.util/100);
                const valIT = (costoDirecto + valGG + valUtil) * (s.it/100);
                const precioFinal = costoDirecto + valGG + valUtil + valIT;

                // --- TABLA MATERIALES ---
                // Generamos el cuerpo o una fila vacía si no hay datos para mantener estructura si se desea, 
                // pero autoTable maneja arrays vacíos mostrando solo headers.
                const bodyMat = matArr.map(r => [r.desc, r.unit, f(r.qty, 'yield'), f(r.price, 'price'), f(r.qty*r.price, 'partial')]);
                bodyMat.push([{ content: 'SUBTOTAL MATERIALES', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, f(sumMat, 'partial')]);
                
                doc.autoTable({
                    startY: y, head: [['MATERIALES', 'UND.', 'REND.', 'PRECIO', 'PARCIAL']],
                    body: bodyMat, theme: 'grid', headStyles: headerStyles, styles: tableStyles, columnStyles: apuColumnStyles, margin:{left:14, right:14}
                });
                y = doc.lastAutoTable.finalY + 4;

                // --- TABLA MANO DE OBRA (Siempre visible) ---
                const bodyMo = moArr.map(r => [r.desc, r.unit, f(r.qty, 'yield'), f(r.price, 'price'), f(r.qty*r.price, 'partial')]);
                bodyMo.push([{ content: 'SUBTOTAL MANO DE OBRA', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, f(sumMo, 'partial')]);
                bodyMo.push([{ content: `Cargas Sociales (${s.social}%)`, colSpan: 4, styles: { halign: 'right', textColor: 100 } }, f(valSoc, 'partial')]);
                bodyMo.push([{ content: `IVA MO (${s.iva_mo}%)`, colSpan: 4, styles: { halign: 'right', textColor: 100 } }, f(valIvaMo, 'partial')]);
                bodyMo.push([{ content: 'TOTAL MANO DE OBRA', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold', fillColor:[245,245,245] } }, { content: f(totalMo, 'partial'), styles:{fontStyle:'bold'} }]);

                doc.autoTable({
                    startY: y, head: [['MANO DE OBRA', 'UND.', 'REND.', 'PRECIO', 'PARCIAL']],
                    body: bodyMo, theme: 'grid', headStyles: headerStyles, styles: tableStyles, columnStyles: apuColumnStyles, margin:{left:14, right:14}
                });
                y = doc.lastAutoTable.finalY + 4;

                // --- TABLA EQUIPO (Siempre visible) ---
                const bodyEq = eqArr.map(r => [r.desc, r.unit, f(r.qty, 'yield'), f(r.price, 'price'), f(r.qty*r.price, 'partial')]);
                bodyEq.push([{ content: 'SUBTOTAL EQUIPO', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold' } }, f(sumEq, 'partial')]);
                bodyEq.push([{ content: `Herramientas Menores (${s.tools}% de MO)`, colSpan: 4, styles: { halign: 'right', textColor: 100 } }, f(valTools, 'partial')]);
                bodyEq.push([{ content: 'TOTAL EQUIPO Y MAQUINARIA', colSpan: 4, styles: { halign: 'right', fontStyle: 'bold', fillColor:[245,245,245] } }, { content: f(totalEq, 'partial'), styles:{fontStyle:'bold'} }]);

                // Control salto página
                if (y > 220) { doc.addPage(); y = 20; }
                
                doc.autoTable({
                    startY: y, head: [['EQUIPO Y MAQUINARIA', 'UND.', 'REND.', 'PRECIO', 'PARCIAL']],
                    body: bodyEq, theme: 'grid', headStyles: headerStyles, styles: tableStyles, columnStyles: apuColumnStyles, margin:{left:14, right:14}
                });
                y = doc.lastAutoTable.finalY + 4;

                // --- RESUMEN FINAL ---
                if (y > 230) { doc.addPage(); y = 20; }
                
                doc.autoTable({
                    startY: y,
                    body: [
                        ['COSTO DIRECTO', f(costoDirecto, 'total')],
                        [`Gastos Generales (${s.gg}%)`, f(valGG, 'total')],
                        [`Utilidad (${s.util}%)`, f(valUtil, 'total')],
                        [`Impuesto IT (${s.it}%)`, f(valIT, 'total')],
                        ['PRECIO UNITARIO TOTAL', f(precioFinal, 'total')]
                    ],
                    theme: 'plain',
                    styles: { ...tableStyles, cellPadding: 1 }, // Aún más compacto para el resumen
                    columnStyles: { 0: { halign: 'right', fontStyle: 'bold', cellWidth: 157 }, 1: { halign: 'right', fontStyle: 'bold', cellWidth: 25, fillColor:[240,240,240] } },
                    margin: { left: 14, right: 14 }
                });
            });
        });
    };

    // --- SUB: LISTADOS DE INSUMOS (AGREGADO NOMBRE PROYECTO) ---
    const addPageInsumos = (cat) => {
        collectInsumosFromProjectGlobal(cat);
        doc.addPage();
        
        // Título
        doc.setFontSize(14); doc.setFont("helvetica", "bold");
        doc.text(`LISTADO DE ${cat.toUpperCase()}`, 105, 20, {align:'center'});
        
        // Nombre del Proyecto Agregado
        doc.setFontSize(10); doc.setFont("helvetica", "normal");
        doc.text(`PROYECTO: ${projectName}`, 105, 26, { align: "center" });
        doc.text(`FECHA: ${dateStr}`, 195, 26, { align: "right" });

        const body = insumosGlobalList.map(i => [i.desc, i.unit, f(i.cantidadTotal, 'qty'), f(i.precioUnitario, 'price'), f(i.precioTotal, 'total')]);
        const total = insumosGlobalList.reduce((a,b)=>a+b.precioTotal,0);

        body.push([{ content: 'TOTAL', colSpan: 4, styles:{halign:'right', fontStyle:'bold'} }, { content: f(total, 'total'), styles: { fontStyle: 'bold' } }]);

        doc.autoTable({ 
            startY: 32, 
            head: [['DESCRIPCIÓN', 'UND.', 'CANT.', 'P. UNIT', 'TOTAL']], 
            body: body, 
            theme: 'grid', 
            headStyles: headerStyles, 
            styles: tableStyles, // Aplicar estilos compactos
            columnStyles: { 1:{halign:'center'}, 2:{halign:'right'}, 3:{halign:'right'}, 4:{halign:'right'} } 
        });
    };

    // --- EJECUCIÓN ---
    if (type === 'masivo') {
        addPagePG(); addPageAPUs(); 
        addPageInsumos('materiales'); addPageInsumos('mano_obra'); addPageInsumos('equipos');
        doc.save(`PROYECTO_${projectName}_COMPLETO.pdf`);
    } else if (type === 'pg') {
        addPagePG(); doc.save(`B1_${projectName}.pdf`);
    } else if (type === 'apu') {
        doc.deletePage(1); addPageAPUs(); doc.save(`B2_${projectName}.pdf`);
    } else {
        doc.deletePage(1); addPageInsumos(type); doc.save(`Insumos_${type}.pdf`);
    }
}

//   MOTOR EXCEL SICOES (CON CÁLCULO COMPLETO)
async function generateExcelReportSICOES(type, projectName) {
        const workbook = new ExcelJS.Workbook();
        workbook.creator = "PresuRE App";
        
        const s = appData.settings;
        const n = (num, t) => { 
            let d = 2; 
            if(t==='qty') d = s.decimals_qty; 
            if(t==='total') d = s.decimals_total; 
            if(t==='price') d = s.decimals_price; 
            if(t==='yield') d = s.decimals_yield; 
            if(t==='partial') d = s.decimals_partial; 
            return parseFloat(parseFloat(num).toFixed(d));
        };

        // --- SUB: B-1 PRESUPUESTO ---
        const buildB1 = () => {
            const ws = workbook.addWorksheet("B-1");
            ws.columns = [
                { width: 5 }, { width: 45 }, { width: 10 }, { width: 12 }, { width: 12 }, { width: 15 }
            ];
            
            // Encabezados
            ws.addRow(["FORMULARIO B-1"]).font = { bold: true, size: 14 };
            ws.addRow(["PRESUPUESTO GENERAL DE OBRA"]).font = { bold: true };
            ws.addRow([`PROYECTO: ${projectName}`]);
            ws.addRow([]);
            
            const header = ws.addRow(["Nº", "DESCRIPCIÓN", "UNIDAD", "CANTIDAD", "P. UNITARIO", "TOTAL"]);
            header.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            header.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF274B7D' } };

            let c=1, gt=0;
            appData.modules.forEach(mod => {
                const rMod = ws.addRow([mod.name.toUpperCase()]);
                rMod.font = { bold: true, italic: true };
                rMod.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFEDF2F7' } };

                appData.projectItems.filter(i => i.moduleId === mod.id).forEach(item => {
                    const pu = calculateUnitPrice(item);
                    // Redondeo visual antes de multiplicar
                    const puR = roundToConfig(pu, 'total');
                    const qtyR = roundToConfig(item.quantity, 'qty');
                    const tot = puR * qtyR;
                    gt += tot;

                    ws.addRow([c++, item.description, item.unit, n(qtyR,'qty'), n(puR,'total'), n(tot,'total')]);
                });
            });

            const rTot = ws.addRow(["", "TOTAL PRESUPUESTO", "", "", "", n(gt,'total')]);
            rTot.font = { bold: true };
            rTot.getCell(6).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFC6F6D5' } };
        };

        // --- SUB: B-2 APUS ---
        const buildAPU = () => {
            const ws = workbook.addWorksheet("B-2");
            ws.columns = [{width:40}, {width:10}, {width:12}, {width:12}, {width:15}];
            
            ws.addRow(["FORMULARIO B-2"]).font = { bold: true, size: 14 };
            ws.addRow(["ANÁLISIS DE PRECIOS UNITARIOS"]);
            ws.addRow([`PROYECTO: ${projectName}`]);
            ws.addRow([]);

            let c = 1;
            appData.modules.forEach(mod => {
                appData.projectItems.filter(i=>i.moduleId===mod.id).forEach(item => {
                    const matArr = item.materiales || [];
                    const moArr = item.mano_obra || [];
                    const eqArr = item.equipos || [];
                    // Cálculos
                    const sumMat = matArr.reduce((a,b)=>a+(b.qty*b.price),0);
                    const sumMo = moArr.reduce((a,b)=>a+(b.qty*b.price),0);
                    const valSoc = sumMo * (s.social/100);
                    const valIvaMo = (sumMo + valSoc) * (s.iva_mo/100);
                    const totalMo = sumMo + valSoc + valIvaMo;
                    const sumEq = eqArr.reduce((a,b)=>a+(b.qty*b.price),0);
                    const valTools = totalMo * (s.tools/100);
                    const totalEq = sumEq + valTools;
                    const cd = sumMat + totalMo + totalEq;
                    const valGG = cd * (s.gg/100);
                    const valUtil = (cd + valGG) * (s.util/100);
                    const valIT = (cd + valGG + valUtil) * (s.it/100);
                    let finalP = cd + valGG + valUtil + valIT;
                    finalP = roundToConfig(finalP, 'total');

                    // Encabezado Item
                    const rHead = ws.addRow(["ÍTEM " + c++, item.description, "UNIDAD: " + item.unit, "CANT: " + n(item.quantity,'qty')]);
                    rHead.font = { bold: true };
                    rHead.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFE2E8F0' } };

                    ws.addRow(["DESCRIPCIÓN", "UNIDAD", "RENDIMIENTO", "PRECIO", "PARCIAL"]).font = { italic: true };

                    // Materiales
                    ws.addRow(["MATERIALES"]).font = { bold: true, underline: true };
                    matArr.forEach(r => ws.addRow(["  "+r.desc, r.unit, n(r.qty,'yield'), n(r.price,'price'), n(r.qty*r.price,'partial')]));
                    ws.addRow(["SUBTOTAL MATERIALES", "", "", "", n(sumMat,'partial')]).font = { bold: true };

                    // MO
                    ws.addRow(["MANO DE OBRA"]).font = { bold: true, underline: true };
                    moArr.forEach(r => ws.addRow(["  "+r.desc, r.unit, n(r.qty,'yield'), n(r.price,'price'), n(r.qty*r.price,'partial')]));
                    ws.addRow(["SUBTOTAL MANO DE OBRA", "", "", "", n(sumMo,'partial')]);
                    ws.addRow([`CARGAS SOCIALES (${s.social}%)`, "", "", "", n(valSoc,'partial')]).font = { color: { argb: 'FF718096' } };
                    ws.addRow([`IVA MO (${s.iva_mo}%)`, "", "", "", n(valIvaMo,'partial')]).font = { color: { argb: 'FF718096' } };
                    ws.addRow(["TOTAL MANO DE OBRA", "", "", "", n(totalMo,'partial')]).font = { bold: true };

                    // Equipo
                    ws.addRow(["EQUIPO Y MAQUINARIA"]).font = { bold: true, underline: true };
                    eqArr.forEach(r => ws.addRow(["  "+r.desc, r.unit, n(r.qty,'yield'), n(r.price,'price'), n(r.qty*r.price,'partial')]));
                    ws.addRow(["SUBTOTAL EQUIPO", "", "", "", n(sumEq,'partial')]);
                    ws.addRow([`HERRAMIENTAS MENORES (${s.tools}% de MO)`, "", "", "", n(valTools,'partial')]).font = { color: { argb: 'FF718096' } };
                    ws.addRow(["TOTAL EQUIPO", "", "", "", n(totalEq,'partial')]).font = { bold: true };

                    // Resumen
                    ws.addRow(["COSTO DIRECTO", "", "", "", n(cd,'total')]);
                    ws.addRow([`GASTOS GENERALES (${s.gg}%)`, "", "", "", n(valGG,'total')]);
                    ws.addRow([`UTILIDAD (${s.util}%)`, "", "", "", n(valUtil,'total')]);
                    ws.addRow([`IMPUESTO IT (${s.it}%)`, "", "", "", n(valIT,'total')]);
                    const rFin = ws.addRow(["TOTAL PRECIO UNITARIO", "", "", "", n(finalP,'total')]);
                    rFin.font = { bold: true, size: 11 };
                    rFin.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFFFF0F0' } };
                    
                    ws.addRow([]); // Espacio
                });
            });
        };

        // --- SUB: INSUMOS ---
        const buildInsumos = (cat, sheetName) => {
            collectInsumosFromProjectGlobal(cat);
            const ws = workbook.addWorksheet(sheetName);
            ws.columns = [{width:40}, {width:10}, {width:15}, {width:15}, {width:15}];
            
            ws.addRow([`LISTADO DE ${cat.toUpperCase()}`]).font = { bold: true, size: 14 };
            ws.addRow([`PROYECTO: ${projectName}`]);
            ws.addRow([]);
            
            const head = ws.addRow(["DESCRIPCIÓN", "UNIDAD", "CANT. TOTAL", "PRECIO UNIT.", "TOTAL"]);
            head.font = { bold: true, color: { argb: 'FFFFFFFF' } };
            head.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF2D3748' } };

            let t = 0;
            insumosGlobalList.forEach(i => { 
                t+=i.precioTotal; 
                ws.addRow([i.desc, i.unit, n(i.cantidadTotal,'qty'), n(i.precioUnitario,'price'), n(i.precioTotal,'total')]); 
            });
            
            const rTot = ws.addRow(["COSTO TOTAL", "", "", "", n(t,'total')]);
            rTot.font = { bold: true };
            rTot.getCell(5).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFBEE3F8' } };
        };

        // Ejecutar lógica según tipo
        if (type === 'masivo') {
            buildB1(); buildAPU();
            buildInsumos('materiales', "Materiales");
            buildInsumos('mano_obra', "Mano de Obra");
            buildInsumos('equipos', "Equipos");
            const buffer = await workbook.xlsx.writeBuffer();
            saveExcelBuffer(buffer, `PROYECTO_${projectName}_COMPLETO.xlsx`);
        } else if (type === 'pg') {
            buildB1();
            const buffer = await workbook.xlsx.writeBuffer();
            saveExcelBuffer(buffer, "B1.xlsx");
        } else if (type === 'apu') {
            buildAPU();
            const buffer = await workbook.xlsx.writeBuffer();
            saveExcelBuffer(buffer, "B2.xlsx");
        } else {
            buildInsumos(type, type);
            const buffer = await workbook.xlsx.writeBuffer();
            saveExcelBuffer(buffer, `Insumos_${type}.xlsx`);
        }
    }

// Variable auxiliar global para insumos (se mantiene igual)
let insumosGlobalList = [];
function collectInsumosFromProjectGlobal(type) {
    insumosGlobalList = [];
    const resourceKey = type; 
    const insumosMap = new Map();

    appData.projectItems.forEach(item => {
        if (item[resourceKey]) {
            item[resourceKey].forEach(resource => {
                const cantidadTotal = resource.qty * item.quantity;
                const precioTotal = cantidadTotal * resource.price;
                const key = `${resource.desc.toLowerCase()}|${resource.unit}`;
                
                if (insumosMap.has(key)) {
                    const entry = insumosMap.get(key);
                    entry.cantidadTotal += cantidadTotal;
                    entry.precioTotal += precioTotal;
                } else {
                    insumosMap.set(key, {
                        desc: resource.desc,
                        unit: resource.unit,
                        cantidadTotal: cantidadTotal,
                        precioUnitario: resource.price,
                        precioTotal: precioTotal
                    });
                }
            });
        }
    });
    insumosGlobalList = Array.from(insumosMap.values()).sort((a, b) => a.desc.localeCompare(b.desc));
}

// --- FUNCIÓN DE SINCRONIZACIÓN (INSUMOS -> BANCO) ---
    function syncDbToBank() {
        if (!confirm("Esta acción actualizará los PRECIOS de todos los ítems en el BANCO basándose en la lista actual de INSUMOS.\n\nLa coincidencia se hace por Descripción y Unidad.\n\n¿Deseas continuar?")) {
            return;
        }

        let updateCount = 0;
        let itemsAffected = 0;

        // 1. Crear Mapa Maestro de Precios desde la BD (Global) para búsqueda rápida
        // Clave: "tipo|descripción|unidad" -> Valor: Precio
        const priceMap = new Map();

        const types = ['materiales', 'mano_obra', 'equipos'];
        
        types.forEach(type => {
            appData.database[type].forEach(dbItem => {
                // Normalizamos clave: minúsculas y sin espacios extremos
                const key = `${type}|${dbItem.desc.trim().toLowerCase()}|${dbItem.unit.trim().toLowerCase()}`;
                priceMap.set(key, parseFloat(dbItem.price) || 0);
            });
        });

        // 2. Recorrer el Banco de Ítems y actualizar
        const propMap = {
            'materiales': 'materiales',
            'mano_obra': 'mano_obra',
            'equipos': 'equipos'
        };

        appData.itemBank.forEach(apu => {
            let itemUpdated = false;

            Object.keys(propMap).forEach(apuProp => {
                const dbType = propMap[apuProp];
                
                if (apu[apuProp] && Array.isArray(apu[apuProp])) {
                    apu[apuProp].forEach(resource => {
                        const key = `${dbType}|${resource.desc.trim().toLowerCase()}|${resource.unit.trim().toLowerCase()}`;
                        
                        if (priceMap.has(key)) {
                            const newPrice = priceMap.get(key);
                            // Si el precio es diferente (con tolerancia pequeña para float), actualizamos
                            if (Math.abs(resource.price - newPrice) > 0.001) {
                                resource.price = newPrice;
                                updateCount++;
                                itemUpdated = true;
                            }
                        }
                    });
                }
            });

            if (itemUpdated) itemsAffected++;
        });

        // 3. (Opcional) Preguntar si actualizar también el Presupuesto Activo
        let projectUpdatedCount = 0;
        if (updateCount > 0 && appData.projectItems.length > 0) {
            if (confirm(`Se actualizaron ${updateCount} precios en ${itemsAffected} ítems del BANCO.\n\n¿Deseas aplicar estos precios también al PRESUPUESTO (Proyecto actual)?`)) {
                
                appData.projectItems.forEach(apu => {
                    Object.keys(propMap).forEach(apuProp => {
                        const dbType = propMap[apuProp];
                        if (apu[apuProp] && Array.isArray(apu[apuProp])) {
                            apu[apuProp].forEach(resource => {
                                const key = `${dbType}|${resource.desc.trim().toLowerCase()}|${resource.unit.trim().toLowerCase()}`;
                                if (priceMap.has(key)) {
                                    const newPrice = priceMap.get(key);
                                    if (Math.abs(resource.price - newPrice) > 0.001) {
                                        resource.price = newPrice;
                                        projectUpdatedCount++;
                                    }
                                }
                            });
                        }
                    });
                });
            }
        }

        // 4. Guardar y refrescar
        if (updateCount > 0 || projectUpdatedCount > 0) {
            saveData();
            
            // Si estamos viendo el banco, refrescar lista para ver nuevos precios totales
            if (document.getElementById('panel-items').classList.contains('active')) {
                renderBankList();
            }
            // Si estamos viendo el presupuesto, refrescar para recalcular totales
            if (document.getElementById('panel-b1').classList.contains('active')) {
                renderB1();
            }

            let msg = `Sincronización completa.\nBanco: ${updateCount} cambios.`;
            if (projectUpdatedCount > 0) msg += `\nPresupuesto: ${projectUpdatedCount} cambios.`;
            
            showToast(msg); // Usamos tu sistema de notificaciones existente
        } else {
            showToast("No se encontraron diferencias de precios para actualizar.");
        }
    }
    // --- IMPORTACIÓN INTELIGENTE DE VOLÚMENES (PRESUPUESTO) --
    function importBudgetFromExcel(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = async function(e) {
            try {
                const buffer = e.target.result;
                const workbook = new ExcelJS.Workbook();
                await workbook.xlsx.load(buffer);
                
                // Obtener primera hoja
                const worksheet = workbook.getWorksheet(1);
                
                // CONVERTIR A MATRIZ (Array of Arrays) usando nuestro helper
                const jsonData = sheetToDataArray(worksheet);

                if (jsonData.length === 0) {
                    showToast("El archivo está vacío.");
                    return;
                }

                // 1. Detectar índices de columnas
                let headerRowIndex = -1;
                let colDesc = -1, colUnit = -1, colQty = -1, colCode = -1;

                for (let i = 0; i < Math.min(jsonData.length, 20); i++) {
                    // Aseguramos que la fila exista y sea array
                    if(!Array.isArray(jsonData[i])) continue;

                    const row = jsonData[i].map(cell => cell ? cell.toString().toUpperCase().trim() : "");
                    
                    if (row.includes("DESCRIPCIÓN") || row.includes("DESCRIPCION")) {
                        headerRowIndex = i;
                        row.forEach((cell, idx) => {
                            if (cell.includes("CÓDIGO") || cell.includes("CODIGO")) colCode = idx;
                            if (cell.includes("DESCRIPCIÓN") || cell.includes("DESCRIPCION")) colDesc = idx;
                            if (cell.includes("UNIDAD") || cell.includes("UND")) colUnit = idx;
                            if (cell.includes("CANTIDAD") || cell.includes("TOTAL")) colQty = idx;
                        });
                        break;
                    }
                }

                if (colDesc === -1 || colQty === -1) {
                    showToast("Error: No se encontraron columnas 'Descripción' y 'Cantidad'.");
                    return;
                }

                let itemsAdded = 0;
                let itemsMatched = 0;
                
                for (let i = headerRowIndex + 1; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    // Validar existencia de celda antes de toString()
                    const descRaw = (row[colDesc] !== undefined && row[colDesc] !== null) ? row[colDesc].toString().trim() : "";
                    if (descRaw === "") continue; 

                    const rawCode = (colCode !== -1 && row[colCode]) ? row[colCode].toString().trim() : "";
                    const rawUnit = (colUnit !== -1 && row[colUnit]) ? row[colUnit].toString().trim() : "glb";
                    
                    // Manejo seguro de cantidad
                    let rawQty = 0;
                    if (colQty !== -1 && row[colQty] !== undefined && row[colQty] !== null) {
                        // ExcelJS a veces devuelve objetos para celdas con fórmulas, intentamos obtener 'result' o el valor directo
                        let val = row[colQty];
                        if(typeof val === 'object' && val.result !== undefined) val = val.result;
                        rawQty = parseNumber(val);
                    }
                    if (isNaN(rawQty)) rawQty = 0;

                    // Smart Matching
                    const match = findBestMatchInBank(descRaw, rawUnit);
                    let newItem = match ? JSON.parse(JSON.stringify(match)) : { materiales: [], mano_obra: [], equipos: [] };
                    if(match) itemsMatched++;

                    newItem.id = Date.now() + Math.floor(Math.random() * 100000) + i;
                    newItem.moduleId = appData.activeModuleId;
                    newItem.projectCode = rawCode;
                    newItem.description = descRaw;
                    newItem.unit = rawUnit;
                    newItem.quantity = rawQty;

                    appData.projectItems.push(newItem);
                    itemsAdded++;
                }

                saveData();
                renderB1();
                showToast(`Importación completa: ${itemsAdded} ítems (${itemsMatched} del Banco).`);
                
            } catch (err) {
                console.error(err);
                showToast("Error al procesar el archivo Excel.");
            }
            input.value = '';
        };
        reader.readAsArrayBuffer(file);
    }

    // Función auxiliar para normalizar texto (quitar acentos, minúsculas, espacios extra)
    function normalizeStr(str) {
        return str.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g, "").replace(/\s+/g, ' ').trim();
    }

    // Algoritmo de Búsqueda "Smart"
    function findBestMatchInBank(targetDesc, targetUnit) {
        if (!appData.itemBank || appData.itemBank.length === 0) return null;
        
        const nTargetDesc = normalizeStr(targetDesc);
        const nTargetUnit = normalizeStr(targetUnit);
        
        let bestMatch = null;
        let bestScore = 0;
        
        // Umbral mínimo para considerar coincidencia (evita falsos positivos muy lejanos)
        const minScoreThreshold = 0.4; 

        appData.itemBank.forEach(bankItem => {
            let score = 0;
            const nBankDesc = normalizeStr(bankItem.description);
            const nBankUnit = normalizeStr(bankItem.unit);

            // 1. Coincidencia de Unidad (Peso: 20%)
            // Es importante que la unidad coincida (ej: m2 vs m3 cambia todo)
            if (nBankUnit === nTargetUnit) {
                score += 0.3;
            } else if ((nBankUnit.includes(nTargetUnit) || nTargetUnit.includes(nBankUnit)) && nTargetUnit.length > 1) {
                score += 0.15; // Coincidencia parcial de unidad
            }

            // 2. Coincidencia de Descripción (Peso: 80%)
            if (nBankDesc === nTargetDesc) {
                score += 0.7; // Coincidencia exacta
            } else {
                // Tokenización: Comparamos palabra por palabra
                const targetWords = nTargetDesc.split(' ').filter(w => w.length > 2); // Ignorar palabras cortas (de, y, el)
                const bankWords = nBankDesc.split(' ');
                
                if (targetWords.length > 0) {
                    let matches = 0;
                    targetWords.forEach(word => {
                        if (nBankDesc.includes(word)) matches++;
                    });
                    
                    // Porcentaje de palabras coincidentes
                    const wordScore = (matches / targetWords.length) * 0.7;
                    score += wordScore;
                }
            }

            // Guardar el mejor resultado
            if (score > bestScore && score >= minScoreThreshold) {
                bestScore = score;
                bestMatch = bankItem;
            }
        });

        return bestMatch;
    }

    // ============================================================================
    // FUNCIÓN DE TESTS PARA VALIDAR EL SISTEMA DE PARSEO DE NÚMEROS
    // Ejecutar en consola del navegador: runNumberFormatTests()
    // ============================================================================
    
    function runNumberFormatTests() {
        console.log('🧪 Ejecutando tests de formato numérico...\n');
        
        let passed = 0;
        let failed = 0;
        
        function test(name, actual, expected) {
            if (actual === expected) {
                console.log(`✅ ${name}: ${actual}`);
                passed++;
            } else {
                console.error(`❌ ${name}: esperado ${expected}, obtenido ${actual}`);
                failed++;
            }
        }
        
        // Guardar configuración actual
        const originalFormat = appData.settings.numberFormat;
        
        // TEST 1: Formato EURO
        console.log('\n--- FORMATO EURO ---');
        appData.settings.numberFormat = 'euro';
        test('EURO: 1.234,56', parseNumber('1.234,56'), 1234.56);
        test('EURO: 1234,56', parseNumber('1234,56'), 1234.56);
        test('EURO: 1,56', parseNumber('1,56'), 1.56);
        test('EURO: 0,5', parseNumber('0,5'), 0.5);
        test('EURO: 1.000.000,99', parseNumber('1.000.000,99'), 1000000.99);
        
        // TEST 2: Formato LATAM
        console.log('\n--- FORMATO LATAM ---');
        appData.settings.numberFormat = 'latam';
        test('LATAM: 1,234.56', parseNumber('1,234.56'), 1234.56);
        test('LATAM: 1234.56', parseNumber('1234.56'), 1234.56);
        test('LATAM: 1.56', parseNumber('1.56'), 1.56);
        test('LATAM: 0.5', parseNumber('0.5'), 0.5);
        test('LATAM: 1,000,000.99', parseNumber('1,000,000.99'), 1000000.99);
        
        // TEST 3: Formato INTL
        console.log('\n--- FORMATO INTL ---');
        appData.settings.numberFormat = 'intl';
        test('INTL: 1 234.56', parseNumber('1 234.56'), 1234.56);
        test('INTL: 1234.56', parseNumber('1234.56'), 1234.56);
        test('INTL: 1.56', parseNumber('1.56'), 1.56);
        test('INTL: 0.5', parseNumber('0.5'), 0.5);
        test('INTL: 1 000 000.99', parseNumber('1 000 000.99'), 1000000.99);
        test('INTL: Tolerancia 1,56', parseNumber('1,56'), 1.56);
        
        // TEST 4: Casos Edge
        console.log('\n--- CASOS EDGE ---');
        test('String vacío', parseNumber(''), 0);
        test('Null', parseNumber(null), 0);
        test('Undefined', parseNumber(undefined), 0);
        test('Número directo', parseNumber(123.45), 123.45);
        test('String "0"', parseNumber('0'), 0);
        test('String "-"', parseNumber('-'), 0);
        test('Número negativo', parseNumber('-123.45'), -123.45);
        
        // Restaurar configuración
        appData.settings.numberFormat = originalFormat;
        
        // Resumen
        console.log(`\n${'='.repeat(50)}`);
        console.log(`✅ Tests pasados: ${passed}`);
        console.log(`❌ Tests fallidos: ${failed}`);
        console.log(`📊 Total: ${passed + failed}`);
        console.log(`${'='.repeat(50)}\n`);
        
        if (failed === 0) {
            console.log('🎉 ¡Todos los tests pasaron! El sistema de parseo funciona correctamente.');
        } else {
            console.warn('⚠️ Algunos tests fallaron. Revisar la implementación.');
        }
        
        return { passed, failed };
    }
    
    // Hacer la función global para poder ejecutarla desde la consola
    window.runNumberFormatTests = runNumberFormatTests;

</script>
<script>
    // --- LÓGICA PWA AVANZADA ---
    let deferredPrompt; // Variable para guardar el evento de instalación nativo
    const pwaToast = document.getElementById('pwa-toast');

    // Función para cerrar el Toast
    function closePwaToast() {
        pwaToast.classList.remove('show');
    }

    // 1. Detección de iOS
    const isIos = /iPhone|iPad|iPod/.test(navigator.userAgent) && !window.MSStream;
    // 2. Detección de modo Standalone (App ya instalada)
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;

    // Si la app YA está instalada, detenemos la ejecución aquí.
    if (isStandalone) {
        console.log('App ejecutándose en modo standalone.');
    } else {
        // --- CASO ANDROID / PC (Evento beforeinstallprompt) ---
        window.addEventListener('beforeinstallprompt', (e) => {
            // 1. Prevenir que Chrome muestre su mini-barra automáticamente
            e.preventDefault();
            // 2. Guardar el evento para dispararlo después
            deferredPrompt = e;
            
            // 3. Inyectar contenido HTML para Android/PC
            pwaToast.innerHTML = `
                <div class="pwa-content">
                    <img src="icon-512.png" style="width: 30px; height: 30px; border-radius: 50%;">
                    <span>Instalar <strong>PresuRE</strong> para un mejor acceso.</span>
                </div>
                <div style="display:flex; align-items:center;">
                    <button class="pwa-btn" onclick="installPwa()">Instalar</button>
                    <button class="pwa-close" onclick="closePwaToast()">&times;</button>
                </div>
            `;
            
            // 4. Mostrar el Toast
            pwaToast.classList.add('show');
        });

        // Función que ejecuta la instalación nativa al pulsar tu botón
        async function installPwa() {
            if (deferredPrompt) {
                // Ejecutar el prompt nativo
                deferredPrompt.prompt();
                // Esperar a ver qué decide el usuario
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`User response to the install prompt: ${outcome}`);
                
                // Limpiar variable y cerrar toast
                deferredPrompt = null;
                closePwaToast();
            }
        }

        // --- CASO IOS (iPhone/iPad) ---
        // iOS no soporta beforeinstallprompt, así que mostramos instrucciones manuales
        if (isIos) {
            pwaToast.innerHTML = `
                <div class="pwa-content">
                    <i class="fab fa-apple" style="font-size: 24px;"></i>
                    <div style="display:flex; flex-direction:column; align-items:flex-start;">
                        <span>Instalar en <strong>iPhone</strong>:</span>
                        <span style="font-size:12px; opacity:0.9;">Pulsa <i class="fas fa-share-square"></i> y luego "Agregar a Inicio" <i class="fas fa-plus-square"></i></span>
                    </div>
                </div>
                <button class="pwa-close" onclick="closePwaToast()">&times;</button>
            `;
            
            // Mostrar después de 3 segundos en iOS
            setTimeout(() => {
                pwaToast.classList.add('show');
            }, 3000);
        }
    }

    // REGISTRO DEL SERVICE WORKER (Mantener tu código existente)
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js')
                .then(registration => {
                    console.log('SW registrado con éxito:', registration.scope);
                })
                .catch(err => {
                    console.log('SW falló:', err);
                });
        });
    }
</script>
<div id="pwa-toast"></div>
</body>
</html>